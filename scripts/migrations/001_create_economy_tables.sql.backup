-- ç¶“æ¿Ÿç³»çµ±è³‡æ–™åº«é·ç§»è…³æœ¬
-- Task ID: 2 - å¯¦ä½œç¶“æ¿Ÿç³»çµ±æ ¸å¿ƒåŠŸèƒ½
-- ç‰ˆæœ¬: 001
-- æè¿°: å»ºç«‹ç¶“æ¿Ÿç³»çµ±æ ¸å¿ƒè¡¨æ ¼ï¼ˆeconomy_accounts, economy_transactions, currency_settingsï¼‰
-- å‰µå»ºæ—¥æœŸ: 2025-08-17

-- =============================================================================
-- 1. ç¶“æ¿Ÿå¸³æˆ¶è¡¨æ ¼ (economy_accounts)
-- =============================================================================
CREATE TABLE IF NOT EXISTS economy_accounts (
    id TEXT PRIMARY KEY,                    -- å¸³æˆ¶IDï¼Œæ ¼å¼ï¼šuser_{user_id}_{guild_id} æˆ– gov_{type}_{guild_id}
    account_type TEXT NOT NULL,             -- å¸³æˆ¶é¡å‹ï¼šuser, government_council, government_department
    guild_id INTEGER NOT NULL,              -- Discordä¼ºæœå™¨ID
    user_id INTEGER,                        -- ä½¿ç”¨è€…IDï¼ˆåƒ…ç”¨æ–¼useré¡å‹å¸³æˆ¶ï¼‰
    balance REAL NOT NULL DEFAULT 0.0,      -- å¸³æˆ¶é¤˜é¡
    created_at TEXT NOT NULL,               -- å»ºç«‹æ™‚é–“ (ISO 8601æ ¼å¼)
    updated_at TEXT NOT NULL,               -- æœ€å¾Œæ›´æ–°æ™‚é–“ (ISO 8601æ ¼å¼)
    is_active INTEGER NOT NULL DEFAULT 1,   -- å¸³æˆ¶æ˜¯å¦å•Ÿç”¨ (0=åœç”¨, 1=å•Ÿç”¨)
    metadata TEXT,                          -- é¡å¤–è³‡æ–™ (JSONæ ¼å¼)
    
    -- ç´„æŸæ¢ä»¶
    CHECK (account_type IN ('user', 'government_council', 'government_department')),
    CHECK (balance >= 0.0),
    CHECK (is_active IN (0, 1)),
    CHECK (
        (account_type = 'user' AND user_id IS NOT NULL) OR
        (account_type IN ('government_council', 'government_department') AND user_id IS NULL)
    )
);

-- å¸³æˆ¶è¡¨æ ¼ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_economy_accounts_guild_id ON economy_accounts(guild_id);
CREATE INDEX IF NOT EXISTS idx_economy_accounts_user_id ON economy_accounts(user_id);
CREATE INDEX IF NOT EXISTS idx_economy_accounts_type_guild ON economy_accounts(account_type, guild_id);
CREATE INDEX IF NOT EXISTS idx_economy_accounts_active ON economy_accounts(is_active);

-- =============================================================================
-- 2. äº¤æ˜“è¨˜éŒ„è¡¨æ ¼ (economy_transactions)
-- =============================================================================
CREATE TABLE IF NOT EXISTS economy_transactions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,  -- äº¤æ˜“ID
    from_account TEXT,                      -- ä¾†æºå¸³æˆ¶ID (NULLè¡¨ç¤ºç³»çµ±å­˜æ¬¾)
    to_account TEXT,                        -- ç›®æ¨™å¸³æˆ¶ID (NULLè¡¨ç¤ºç³»çµ±ææ¬¾)
    amount REAL NOT NULL,                   -- äº¤æ˜“é‡‘é¡
    transaction_type TEXT NOT NULL,         -- äº¤æ˜“é¡å‹ï¼štransfer, deposit, withdraw, reward, penalty
    reason TEXT,                            -- äº¤æ˜“åŸå› /æè¿°
    guild_id INTEGER NOT NULL,              -- Discordä¼ºæœå™¨ID
    created_by INTEGER,                     -- åŸ·è¡Œäº¤æ˜“çš„ä½¿ç”¨è€…ID
    created_at TEXT NOT NULL,               -- äº¤æ˜“æ™‚é–“ (ISO 8601æ ¼å¼)
    status TEXT NOT NULL DEFAULT 'completed', -- äº¤æ˜“ç‹€æ…‹ï¼špending, completed, failed, cancelled
    reference_id TEXT,                      -- åƒè€ƒID (ç”¨æ–¼é—œè¯å…¶ä»–ç³»çµ±)
    metadata TEXT,                          -- é¡å¤–è³‡æ–™ (JSONæ ¼å¼)
    
    -- ç´„æŸæ¢ä»¶
    CHECK (amount > 0.0),
    CHECK (transaction_type IN ('transfer', 'deposit', 'withdraw', 'reward', 'penalty')),
    CHECK (status IN ('pending', 'completed', 'failed', 'cancelled')),
    CHECK (
        (transaction_type = 'transfer' AND from_account IS NOT NULL AND to_account IS NOT NULL) OR
        (transaction_type = 'deposit' AND from_account IS NULL AND to_account IS NOT NULL) OR
        (transaction_type = 'withdraw' AND from_account IS NOT NULL AND to_account IS NULL) OR
        (transaction_type IN ('reward', 'penalty'))
    ),
    
    -- å¤–éµç´„æŸ
    FOREIGN KEY (from_account) REFERENCES economy_accounts(id) ON DELETE SET NULL,
    FOREIGN KEY (to_account) REFERENCES economy_accounts(id) ON DELETE SET NULL
);

-- äº¤æ˜“è¡¨æ ¼ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_economy_transactions_from_account ON economy_transactions(from_account);
CREATE INDEX IF NOT EXISTS idx_economy_transactions_to_account ON economy_transactions(to_account);
CREATE INDEX IF NOT EXISTS idx_economy_transactions_guild_id ON economy_transactions(guild_id);
CREATE INDEX IF NOT EXISTS idx_economy_transactions_type ON economy_transactions(transaction_type);
CREATE INDEX IF NOT EXISTS idx_economy_transactions_created_at ON economy_transactions(created_at);
CREATE INDEX IF NOT EXISTS idx_economy_transactions_status ON economy_transactions(status);
CREATE INDEX IF NOT EXISTS idx_economy_transactions_created_by ON economy_transactions(created_by);

-- =============================================================================
-- 3. è²¨å¹£è¨­å®šè¡¨æ ¼ (currency_settings)
-- =============================================================================
CREATE TABLE IF NOT EXISTS currency_settings (
    guild_id INTEGER PRIMARY KEY,           -- Discordä¼ºæœå™¨ID
    currency_name TEXT NOT NULL DEFAULT 'é‡‘å¹£', -- è²¨å¹£åç¨±
    currency_symbol TEXT NOT NULL DEFAULT 'ğŸ’°', -- è²¨å¹£ç¬¦è™Ÿ
    decimal_places INTEGER NOT NULL DEFAULT 2, -- å°æ•¸ä½æ•¸
    min_transfer_amount REAL NOT NULL DEFAULT 1.0, -- æœ€å°è½‰å¸³é‡‘é¡
    max_transfer_amount REAL,               -- æœ€å¤§è½‰å¸³é‡‘é¡ (NULLè¡¨ç¤ºç„¡é™åˆ¶)
    daily_transfer_limit REAL,             -- æ¯æ—¥è½‰å¸³é™é¡ (NULLè¡¨ç¤ºç„¡é™åˆ¶)
    enable_negative_balance INTEGER NOT NULL DEFAULT 0, -- æ˜¯å¦å…è¨±è² é¤˜é¡
    created_at TEXT NOT NULL,               -- å»ºç«‹æ™‚é–“
    updated_at TEXT NOT NULL,               -- æœ€å¾Œæ›´æ–°æ™‚é–“
    
    -- ç´„æŸæ¢ä»¶
    CHECK (decimal_places >= 0 AND decimal_places <= 8),
    CHECK (min_transfer_amount >= 0.0),
    CHECK (max_transfer_amount IS NULL OR max_transfer_amount >= min_transfer_amount),
    CHECK (daily_transfer_limit IS NULL OR daily_transfer_limit >= 0.0),
    CHECK (enable_negative_balance IN (0, 1))
);

-- è²¨å¹£è¨­å®šè¡¨æ ¼ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_currency_settings_guild_id ON currency_settings(guild_id);

-- =============================================================================
-- 4. å¯©è¨ˆè¨˜éŒ„è¡¨æ ¼ (economy_audit_log)
-- =============================================================================
CREATE TABLE IF NOT EXISTS economy_audit_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,  -- å¯©è¨ˆè¨˜éŒ„ID
    operation TEXT NOT NULL,                -- æ“ä½œé¡å‹ï¼šcreate_account, transfer, config_change ç­‰
    target_type TEXT NOT NULL,              -- ç›®æ¨™é¡å‹ï¼šaccount, transaction, config
    target_id TEXT NOT NULL,                -- ç›®æ¨™ID
    guild_id INTEGER NOT NULL,              -- Discordä¼ºæœå™¨ID
    user_id INTEGER,                        -- åŸ·è¡Œæ“ä½œçš„ä½¿ç”¨è€…ID
    old_values TEXT,                        -- æ“ä½œå‰çš„å€¼ (JSONæ ¼å¼)
    new_values TEXT,                        -- æ“ä½œå¾Œçš„å€¼ (JSONæ ¼å¼)
    ip_address TEXT,                        -- IPåœ°å€
    user_agent TEXT,                        -- ä½¿ç”¨è€…ä»£ç†
    created_at TEXT NOT NULL,               -- è¨˜éŒ„æ™‚é–“
    success INTEGER NOT NULL,               -- æ“ä½œæ˜¯å¦æˆåŠŸ (0=å¤±æ•—, 1=æˆåŠŸ)
    error_message TEXT,                     -- éŒ¯èª¤è¨Šæ¯ (å¦‚æœæ“ä½œå¤±æ•—)
    
    -- ç´„æŸæ¢ä»¶
    CHECK (success IN (0, 1))
);

-- å¯©è¨ˆè¨˜éŒ„è¡¨æ ¼ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_economy_audit_log_operation ON economy_audit_log(operation);
CREATE INDEX IF NOT EXISTS idx_economy_audit_log_target ON economy_audit_log(target_type, target_id);
CREATE INDEX IF NOT EXISTS idx_economy_audit_log_guild_id ON economy_audit_log(guild_id);
CREATE INDEX IF NOT EXISTS idx_economy_audit_log_user_id ON economy_audit_log(user_id);
CREATE INDEX IF NOT EXISTS idx_economy_audit_log_created_at ON economy_audit_log(created_at);

-- =============================================================================
-- 5. åˆå§‹è³‡æ–™æ’å…¥
-- =============================================================================

-- ç‚ºæ¯å€‹å¯èƒ½çš„ä¼ºæœå™¨å»ºç«‹é è¨­è²¨å¹£è¨­å®šï¼ˆé€™éƒ¨åˆ†åœ¨æœå‹™å±¤è™•ç†ï¼‰
-- INSERT INTO currency_settings (guild_id, currency_name, currency_symbol, created_at, updated_at)
-- VALUES (?, 'é‡‘å¹£', 'ğŸ’°', datetime('now'), datetime('now'))
-- ON CONFLICT(guild_id) DO NOTHING;

-- =============================================================================
-- 6. è³‡æ–™é©—è­‰æª¢æŸ¥
-- =============================================================================

-- æª¢æŸ¥è¡¨æ ¼æ˜¯å¦æ­£ç¢ºå»ºç«‹
SELECT name FROM sqlite_master WHERE type='table' AND name LIKE 'economy_%' OR name = 'currency_settings';

-- æª¢æŸ¥ç´¢å¼•æ˜¯å¦æ­£ç¢ºå»ºç«‹
SELECT name FROM sqlite_master WHERE type='index' AND (name LIKE 'idx_economy_%' OR name LIKE 'idx_currency_%');

-- æ¸¬è©¦åŸºæœ¬ç´„æŸ
-- é€™äº›æ¸¬è©¦æœƒåœ¨å–®å…ƒæ¸¬è©¦ä¸­é€²è¡Œï¼Œæ­¤è™•åƒ…ä½œç‚ºåƒè€ƒ

-- =============================================================================
-- é·ç§»å®Œæˆæ¨™è¨˜
-- =============================================================================
-- æ­¤è…³æœ¬å°‡ç”± DatabaseManager çš„é·ç§»ç³»çµ±åŸ·è¡Œ
-- é·ç§»ç³»çµ±æœƒè‡ªå‹•è¨˜éŒ„åŸ·è¡Œç‹€æ…‹åˆ° schema_migrations è¡¨æ ¼