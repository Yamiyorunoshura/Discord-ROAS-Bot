name: T2 Concurrency Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2é»åŸ·è¡Œ

jobs:
  concurrency-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run concurrency tests
      run: |
        python tests/concurrency/automated_test_runner.py --mode=ci --timeout=1800
    
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: concurrency-test-results
        path: test_reports/concurrency/
    
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const reportPath = 'test_reports/concurrency/ci_summary.json';
          if (fs.existsSync(reportPath)) {
            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            const comment = `## ğŸ§ª T2 ä½µç™¼æ¸¬è©¦çµæœ
            
            - **ç¸½æ¸¬è©¦æ•¸**: ${report.total_tests}
            - **é€šéæ¸¬è©¦**: ${report.passing_tests}
            - **å¤±æ•—æ¸¬è©¦**: ${report.failing_tests}
            - **æ•´é«”ç‹€æ…‹**: ${report.overall_success ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}
            - **éŒ¯èª¤ç‡**: ${report.average_error_rate_percent.toFixed(2)}%
            - **å¹³å‡éŸ¿æ‡‰æ™‚é–“**: ${report.average_response_time_ms.toFixed(2)}ms
            
            è©³ç´°å ±å‘Šè«‹æŸ¥çœ‹ Actions artifactsã€‚
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }
