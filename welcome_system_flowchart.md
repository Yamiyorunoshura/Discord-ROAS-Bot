# Discord 歡迎系統流程圖

## 🎯 系統架構概覽

```
┌─────────────────────────────────────────────────────────────────┐
│                    Discord 歡迎系統架構                        │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  主控制模組  │  │  渲染引擎   │  │  資料庫管理  │          │
│  │ WelcomeCog  │  │  Renderer   │  │   WelcomeDB │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│         │                │                │                  │
│         └────────────────┼────────────────┘                  │
│                          │                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  快取管理   │  │  配置管理   │  │  面板系統   │          │
│  │   Cache     │  │   Config    │  │    Panel    │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 主要流程圖

### 1. 系統初始化流程

```mermaid
flowchart TD
    A[Bot 啟動] --> B[載入 WelcomeCog]
    B --> C[初始化 WelcomeDB]
    C --> D[初始化 WelcomeRenderer]
    D --> E[初始化 WelcomeCache]
    E --> F[建立背景圖片目錄]
    F --> G[註冊事件監聽器]
    G --> H[系統就緒]
    
    C --> C1[建立資料庫連接池]
    C1 --> C2[初始化資料表結構]
    C2 --> C3[載入預設設定]
    
    D --> D1[初始化字體管理器]
    D1 --> D2[初始化模板管理器]
    D2 --> D3[初始化頭像下載器]
```

### 2. 成員加入事件處理流程

```mermaid
flowchart TD
    A[成員加入事件觸發] --> B[檢查伺服器設定]
    B --> C{是否有歡迎頻道設定?}
    C -->|是| D[取得歡迎頻道]
    C -->|否| E[記錄未設定頻道]
    E --> F[結束流程]
    
    D --> G[檢查快取]
    G --> H{快取中有圖片?}
    H -->|是| I[使用快取圖片]
    H -->|否| J[生成新圖片]
    
    J --> K[下載成員頭像]
    K --> L[取得背景圖片]
    L --> M[渲染歡迎圖片]
    M --> N[儲存到快取]
    N --> I
    
    I --> O[渲染歡迎訊息]
    O --> P[發送到頻道]
    P --> Q[記錄成功日誌]
```

### 3. 圖片生成詳細流程

```mermaid
flowchart TD
    A[開始生成圖片] --> B[取得模板設定]
    B --> C[計算佈局配置]
    C --> D[建立畫布]
    D --> E{有背景圖片?}
    E -->|是| F[載入背景圖片]
    E -->|否| G[使用預設背景色]
    
    F --> H[調整背景尺寸]
    G --> H
    H --> I[下載成員頭像]
    I --> J{頭像下載成功?}
    J -->|是| K[處理頭像]
    J -->|否| L[使用預設頭像]
    
    K --> M[圓形裁剪]
    L --> M
    M --> N[調整頭像尺寸]
    N --> O[貼上頭像到畫布]
    
    O --> P[繪製標題文字]
    P --> Q[繪製描述文字]
    Q --> R[繪製裝飾元素]
    R --> S[儲存為 PNG]
    S --> T[返回 BytesIO]
```

### 4. 設定管理流程

```mermaid
flowchart TD
    A[設定指令觸發] --> B[檢查權限]
    B --> C{有權限?}
    C -->|否| D[回覆權限不足]
    C -->|是| E[載入當前設定]
    
    E --> F[建立設定面板]
    F --> G[顯示設定選項]
    G --> H[等待用戶操作]
    
    H --> I{用戶操作類型}
    I -->|修改頻道| J[更新頻道設定]
    I -->|修改標題| K[更新標題設定]
    I -->|修改描述| L[更新描述設定]
    I -->|上傳背景| M[處理背景上傳]
    I -->|預覽效果| N[生成預覽圖片]
    
    J --> O[儲存到資料庫]
    K --> O
    L --> O
    M --> P[驗證圖片格式]
    P --> Q[儲存圖片檔案]
    Q --> R[更新資料庫]
    R --> S[清除快取]
    S --> O
    
    N --> T[顯示預覽]
    O --> U[更新面板顯示]
    T --> U
    U --> H
```

### 5. 快取管理流程

```mermaid
flowchart TD
    A[快取請求] --> B{檢查快取存在?}
    B -->|是| C{檢查是否過期?}
    B -->|否| D[返回 None]
    
    C -->|否| E[返回快取圖片]
    C -->|是| F[清除過期快取]
    F --> D
    
    G[設定快取] --> H{快取已滿?}
    H -->|是| I[移除最舊項目]
    H -->|否| J[直接加入快取]
    
    I --> J
    J --> K[儲存圖片和時間戳]
```

### 6. 錯誤處理流程

```mermaid
flowchart TD
    A[操作開始] --> B[嘗試執行]
    B --> C{執行成功?}
    C -->|是| D[記錄成功日誌]
    C -->|否| E[捕獲異常]
    
    E --> F[記錄錯誤日誌]
    F --> G[分析錯誤類型]
    
    G --> H{錯誤類型}
    H -->|資料庫錯誤| I[重試資料庫操作]
    H -->|網路錯誤| J[重試網路請求]
    H -->|圖片處理錯誤| K[使用預設圖片]
    H -->|權限錯誤| L[回覆權限不足]
    H -->|其他錯誤| M[回覆一般錯誤]
    
    I --> N{重試成功?}
    J --> O{重試成功?}
    K --> P[繼續處理]
    L --> Q[結束流程]
    M --> Q
    
    N -->|是| D
    N -->|否| R[使用預設值]
    O -->|是| D
    O -->|否| R
    
    R --> P
    P --> D
    D --> S[返回結果]
```

## 📊 核心組件職責

### WelcomeCog (主控制模組)
- **職責**: 協調所有組件，處理 Discord 事件
- **主要方法**:
  - `on_member_join()`: 處理成員加入事件
  - `send_welcome_message()`: 發送歡迎訊息
  - `_generate_welcome_image()`: 生成歡迎圖片
  - `handle_background_upload()`: 處理背景上傳

### WelcomeRenderer (渲染引擎)
- **職責**: 生成歡迎圖片
- **主要組件**:
  - `AvatarDownloader`: 下載和處理頭像
  - `FontManager`: 管理字體
  - `TemplateManager`: 管理模板
  - `LayoutCalculator`: 計算佈局

### WelcomeDB (資料庫管理)
- **職責**: 管理設定和背景圖片
- **主要操作**:
  - `get_settings()`: 取得伺服器設定
  - `update_setting()`: 更新設定
  - `update_welcome_background()`: 更新背景圖片

### WelcomeCache (快取管理)
- **職責**: 快取生成的圖片
- **主要功能**:
  - `get()`: 取得快取圖片
  - `set()`: 設定快取圖片
  - `clear()`: 清除快取

## 🔧 技術特點

1. **模組化設計**: 每個組件都有明確的職責
2. **錯誤處理**: 完善的異常捕獲和重試機制
3. **快取優化**: 避免重複生成相同圖片
4. **配置靈活**: 支援自訂背景、文字、位置等
5. **模板系統**: 支援多種視覺風格
6. **字體管理**: 支援多種字體和回退機制

## 📈 性能優化

- **快取機制**: 減少重複圖片生成
- **連接池**: 優化資料庫連接
- **異步處理**: 提高並發性能
- **圖片壓縮**: 優化檔案大小
- **錯誤恢復**: 確保系統穩定性 