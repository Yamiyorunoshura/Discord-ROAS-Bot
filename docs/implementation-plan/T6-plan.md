# T6 Docker跨平台一鍵啟動腳本 - 實施計劃

---
**任務ID**: T6  
**專案名稱**: Discord機器人模組化系統  
**負責人**: task-planner (David)  
**日期**: 2025-08-23  
**專案根目錄**: /Users/tszkinlai/Coding/roas-bot  

## 來源文件
- **類型**: requirements | **路徑**: /Users/tszkinlai/Coding/roas-bot/docs/specs/requirement.md
- **類型**: task | **路徑**: /Users/tszkinlai/Coding/roas-bot/docs/specs/task.md  
- **類型**: design | **路徑**: /Users/tszkinlai/Coding/roas-bot/docs/specs/design.md

## 假設與約束
- 現有Dockerfile基於Python 3.10，需升級至Python 3.13配合R7需求
- 現有docker-compose配置已建立基礎框架，需優化以支援一鍵啟動流程
- uv套件管理器將取代傳統pip，需整合至容器建置流程
- 跨平台腳本需支援Windows PowerShell、macOS/Linux Bash環境
- 必須保持現有監控基礎設施（Redis、Prometheus、Grafana）的相容性

---

## 1. 任務概述

### 摘要
實現跨平台（Windows/macOS/Linux）Docker容器化一鍵啟動解決方案，基於Python 3.13-slim基礎映像，整合uv套件管理器，提供完整的前置檢查、啟動驗證與錯誤處理機制，降低部署門檻並提升營運效率。

### 背景
當前專案已具備基本的Docker容器化配置，但缺乏跨平台一鍵啟動能力。隨著Python 3.13升級需求(R7)與uv套件管理器導入(R6)，需要重新設計容器化架構，確保在不同作業系統上都能快速、可靠地啟動Discord機器人服務。

### 目標
- 提供Windows (.ps1) 與 Unix-like (.sh) 平台的一鍵啟動腳本
- 升級Docker映像至Python 3.13-slim並整合uv套件管理器
- 實現智能前置條件檢查與用戶引導
- 建立完整的容器健康檢查與錯誤恢復機制
- 提供完整的文檔與疑難排解指南

---

## 2. 功能性與非功能性目標

### 功能性需求
- **F-T6-1**: Docker映像基於python:3.13-slim，整合uv套件管理器進行依賴安裝
  - **驗收條件**: 
    - 容器啟動後python --version回傳3.13.x
    - uv --version命令成功執行且版本>=0.1.0
    - 依賴安裝時間相較pip減少至少30%
- **F-T6-2**: 提供跨平台啟動腳本支援Windows PowerShell與Unix Bash
  - **驗收條件**:
    - scripts/start.ps1在Windows 10+環境成功執行
    - scripts/start.sh在macOS 10.15+與Ubuntu 20.04+環境成功執行
    - 腳本自動檢測並讀取.env環境變數檔案
- **F-T6-3**: 智能前置條件檢查與用戶指引系統
  - **驗收條件**:
    - 檢測Docker Engine版本>=20.10.0與Docker Compose版本>=2.0.0
    - 缺失時提供平台特定的安裝指引連結
    - 環境變數缺失時提供範例與設定指導

### 非功能性需求  
- **N-T6-1**: 啟動效能優化，從命令執行到服務就緒時間<120秒
  - **量測指標**: 從執行啟動腳本到健康檢查通過的總耗時<120秒(90%成功率)
- **N-T6-2**: 容器映像大小最佳化，最終映像大小<500MB
  - **量測指標**: docker images顯示的映像大小≤500MB
- **N-T6-3**: 啟動成功率在標準環境達99%
  - **量測指標**: 在乾淨的Docker環境中連續100次啟動，成功率≥99%

---

## 3. 範圍界定

### 包含範圍
- 基於Python 3.13-slim的多階段Dockerfile重構
- 整合uv套件管理器的依賴安裝流程
- Windows PowerShell啟動腳本(.ps1)開發
- macOS/Linux Bash啟動腳本(.sh)開發  
- Docker Compose配置優化與健康檢查強化
- 容器啟動驗證腳本與日誌檢查工具
- 跨平台部署文檔與疑難排解指南
- 與現有監控基礎設施的整合驗證

### 排除範圍
- Kubernetes或其他容器編排平台的支援
- 自動化CI/CD pipeline配置（屬於其他任務範疇）
- 生產環境的高可用性與負載均衡配置
- SSL/TLS憑證自動化管理
- 資料庫遷移腳本（T4已處理）

---

## 4. 技術實施方法

### 架構概覽
採用多階段Docker建置策略，第一階段進行依賴編譯與安裝，第二階段建立精簡的執行時環境。啟動腳本採用平台特定語言實現，提供統一的用戶體驗介面。

### 模組設計

#### M-T6-1: Docker映像重構模組
**目的**: 建立基於Python 3.13與uv的最佳化容器映像
**介面**:
- 輸入: pyproject.toml, uv.lock, 應用程式源碼
- 輸出: discord-bot:latest Docker映像
- API: 標準Docker build指令介面
**重用**: 採用多階段建置模式，重用現有的目錄結構與權限配置

#### M-T6-2: 跨平台啟動腳本模組  
**目的**: 提供統一的一鍵啟動體驗
**介面**:
- 輸入: .env環境檔案, docker-compose配置
- 輸出: 啟動狀態回報, 錯誤診斷資訊
- API: 命令行介面，支援--env-file, --verbose參數
**重用**: 重用現有的docker-compose配置框架

#### M-T6-3: 健康檢查與驗證模組
**目的**: 確保服務啟動完整性與問題快速診斷  
**介面**:
- 輸入: 容器ID或服務名稱
- 輸出: 健康狀態JSON報告  
- API: scripts/verify_container_health.sh命令行工具
**重用**: 整合現有的DatabaseManager健康檢查邏輯

### 資料流與狀態管理
**Schema變更**: 無需資料庫結構調整
**遷移步驟**: N/A - 本任務不涉及資料持久化變更

### 測試策略
**單元測試**:
- 啟動腳本的參數解析與環境檢測邏輯
- Docker映像建置過程的層級優化驗證
- uv依賴解析與安裝流程的隔離測試

**整合測試**:
- 跨平台環境的端對端啟動流程驗證
- 與現有監控系統(Redis/Prometheus)的整合測試
- 負載情況下的容器啟動穩定性測試

**驗收測試**:
- 在Windows 10/11, macOS Big Sur+, Ubuntu 20.04+的實際部署驗證
- 新手用戶的部署體驗測試(無預設Docker知識)
- 錯誤場景的恢復能力測試(網路中斷、磁碟空間不足等)

### 品質要求
- **程式碼覆蓋率**: 啟動腳本核心邏輯≥85%測試覆蓋率
- **效能基準**: 映像建置時間<300秒，啟動時間<120秒  
- **安全檢查**: Docker映像無高風險漏洞(CVSS評分<7.0)
- **文檔完整性**: 所有公開API與腳本參數100%文檔覆蓋

---

## 5. 開發里程碑

### M1: Docker映像現代化 (2025-08-24 - 2025-08-25)
**交付成果**:
- 重構Dockerfile支援Python 3.13-slim基底
- 整合uv套件管理器取代pip安裝流程
- 多階段建置優化，映像大小<500MB
- docker/compose.yaml更新支援新映像

**完成定義**:
- docker build成功產生discord-bot:3.13-uv映像
- 映像大小驗證通過(<500MB)
- 容器啟動後Python版本為3.13.x
- uv套件安裝功能正常運作

### M2: 跨平台啟動腳本開發 (2025-08-25 - 2025-08-26)  
**交付成果**:
- scripts/start.ps1 Windows PowerShell啟動腳本
- scripts/start.sh Unix Bash啟動腳本
- 前置條件檢查邏輯(Docker版本、環境變數、磁碟空間)
- 錯誤處理與用戶指引系統

**完成定義**:
- 兩個腳本在目標平台成功執行
- 前置檢查涵蓋所有必要依賴
- 錯誤訊息清晰且提供解決方案
- 支援--verbose和--env-file參數

### M3: 容器健康檢查與驗證 (2025-08-26 - 2025-08-27)
**交付成果**:  
- scripts/verify_container_health.sh健康檢查工具
- 升級docker-compose健康檢查配置
- 服務就緒狀態檢測與日誌分析
- 異常情況自動診斷與恢復建議

**完成定義**:
- 健康檢查腳本準確檢測服務狀態
- Docker Compose健康檢查配置最佳化
- 異常狀況提供明確診斷資訊
- 整合測試通過率100%

---

## 6. 時程規劃

**開始日期**: 2025-08-24  
**結束日期**: 2025-08-27  
**總開發人日**: 4人日

### 詳細時程
| 里程碑 | 開始日期 | 結束日期 | 工期 |
|--------|----------|----------|------|
| M1: Docker映像現代化 | 2025-08-24 | 2025-08-25 | 2日 |  
| M2: 跨平台啟動腳本開發 | 2025-08-25 | 2025-08-26 | 2日 |
| M3: 容器健康檢查與驗證 | 2025-08-26 | 2025-08-27 | 2日 |

*註: M1與M2部分工作可並行進行，實際工期為4日*

---

## 7. 依賴關係

### 外部依賴
- **Docker Engine**: 版本≥20.10.0，提供多階段建置與健康檢查支援
- **Docker Compose**: 版本≥2.0.0，支援現代compose.yaml格式
- **uv套件管理器**: 版本≥0.1.0，Python快速套件管理解決方案
- **Python 3.13-slim**: 官方Docker映像，提供穩定的執行時環境

### 內部依賴  
- **T7任務**: uv + pyproject.toml依賴管理配置，本任務需等待T7完成pyproject.toml配置
- **現有服務架構**: 基於現有的core/, services/, panels/目錄結構
- **資料庫組件**: 重用現有的SQLite設定與遷移腳本(已由T4完成)

---

## 8. 工作量評估

### 評估方法
採用三點估算法(樂觀、最可能、悲觀)結合歷史資料進行評估

### 估算摘要
**總人日**: 4人日  
**信心水準**: 高

### 工作分解
| 工作項目 | 樂觀估算 | 最可能估算 | 悲觀估算 | 加權估算 |
|----------|----------|------------|----------|----------|
| Dockerfile重構與Python 3.13升級 | 0.5日 | 1日 | 1.5日 | 1日 |
| uv套件管理器整合與測試 | 0.5日 | 1日 | 2日 | 1.1日 |
| Windows PowerShell腳本開發 | 0.3日 | 0.5日 | 1日 | 0.6日 |
| Unix Bash腳本開發 | 0.3日 | 0.5日 | 0.8日 | 0.5日 |
| 健康檢查與驗證邏輯 | 0.2日 | 0.5日 | 1日 | 0.5日 |
| 跨平台測試與除錯 | 0.2日 | 0.5日 | 1.5日 | 0.6日 |
| 文檔撰寫與範例建立 | 0.1日 | 0.3日 | 0.5日 | 0.3日 |

**加權總計**: 4.6人日 ≈ 5人日(含緩衝)

---

## 9. 風險評估與對策

### R-T6-1: Python 3.13相容性風險
**描述**: discord.py或其他核心依賴可能尚未完全支援Python 3.13  
**機率**: 中等 **影響**: 高  
**緩解措施**:  
- 優先測試核心依賴包在Python 3.13環境的相容性
- 準備降級回Python 3.12的備選方案
- 與T9任務協調確保升級策略一致性
**應急計劃**: 若發現重大相容性問題，暫時保持Python 3.12並更新任務範圍

### R-T6-2: uv套件管理器穩定性風險  
**描述**: uv作為較新工具，可能存在與複雜依賴關係的相容問題
**機率**: 中等 **影響**: 中等
**緩解措施**:
- 建立pip fallback機制在uv失敗時自動切換
- 完整測試現有依賴在uv環境下的安裝與執行
- 監控uv社群反饋與版本更新
**應急計劃**: 保留傳統pip安裝流程作為備選，確保功能不受影響

### R-T6-3: 跨平台腳本相容性風險
**描述**: PowerShell版本差異或Unix系統差異可能導致腳本執行失敗  
**機率**: 低 **影響**: 中等
**緩解措施**:
- 使用保守的PowerShell語法，相容PowerShell 5.1+
- Bash腳本遵循POSIX標準，避免GNU特定語法
- 建立多版本測試矩陣確保廣泛相容性  
**應急計劃**: 提供手動部署指南作為腳本失敗時的替代方案

### R-T6-4: Docker映像大小超標風險
**描述**: 整合更多工具可能導致映像大小超過500MB限制
**機率**: 低 **影響**: 低  
**緩解措施**:
- 使用.dockerignore精確控制建置上下文  
- 多階段建置中及時清理建置快取與不必要檔案
- 持續監控映像大小並優化層級結構
**應急計劃**: 調整非功能性需求，容許映像大小最大至600MB

---

## 10. 尚待釐清問題

目前已充分分析任務需求與技術約束，無重大待決問題。

---

## 11. 備註

### 技術決策紀錄
- **映像基底選擇**: 選用python:3.13-slim而非python:3.13-alpine，因slim版本提供更好的套件相容性，雖然映像稍大但更穩定
- **uv整合策略**: 採用系統全域安裝uv而非虛擬環境內安裝，簡化容器內依賴管理
- **腳本錯誤處理**: 採用錯誤碼標準化，便於後續自動化工具整合與問題診斷

### 與其他任務的協調
- **T7 (uv + pyproject)**: 需確保pyproject.toml配置完整後再進行容器整合測試
- **T9 (Python 3.13升級)**: 共享Python版本升級的相容性測試結果
- **R8需求**: 直接對應，確保跨平台啟動腳本滿足所有驗收條件

### 維運考量  
- 建立清晰的版本標籤策略，便於問題追溯與版本回滾
- 提供完整的故障排查流程圖，降低維運負擔
- 考慮未來的擴展需求，如支援更多作業系統或容器編排平台

---

**開發備註位置**: docs/dev-notes/T6-dev-notes.md  
**開發備註Schema**: 參考 unified-developer-workflow.yaml 中的 dev_notes_v1 結構  
**開發備註說明**: 開發者在實施過程中將在獨立檔案中填寫詳細記錄，不在計劃檔案中維護