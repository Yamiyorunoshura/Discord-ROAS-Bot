# 實施計劃：T4 - 資料完整性與測試隔離

## 基本資訊

**任務ID**: T4  
**專案名稱**: Discord Bot 模組化系統  
**負責人**: David（任務規劃師）  
**建立日期**: 2025-08-22  
**專案根目錄**: /Users/tszkinlai/Coding/roas-bot  

### 資料來源
- **需求規範**: /Users/tszkinlai/Coding/roas-bot/docs/specs/requirement.md
- **任務規範**: /Users/tszkinlai/Coding/roas-bot/docs/specs/task.md  
- **設計規範**: /Users/tszkinlai/Coding/roas-bot/docs/specs/design.md

### 假設條件
- SQLite作為主要資料庫，不在此版本遷移到PostgreSQL
- T3已完成SQLite併發優化（WAL模式、重試機制）
- 現有遷移管理器 `scripts/migration_manager.py` 可重用並擴展
- 測試隔離依賴新的memory/temporary數據庫策略

### 約束條件
- 必須保持與現有系統的向後相容性
- 遷移必須在新資料庫和既有資料庫上安全執行
- 測試隔離不得影響現有測試通過率
- 所有資料變更必須提供回滾機制

---

## 專案概述

### 專案摘要
T4任務解決資料完整性問題和測試資料隔離，確保系統在高併發和重複測試環境下的穩定性。重點包括：建立安全的資料庫遷移機制、實現完整的測試資料隔離、並提供全面的資料完整性回歸測試套件。

### 背景脈絡
當前系統面臨UNIQUE約束衝突、無效欄位錯誤、以及測試資料汙染問題。現有infrastructure包含基礎遷移管理器和部分測試隔離工具，但需要強化以支援雙態驗證（新/舊資料庫）和完整測試隔離。

### 專案目標
- 解決活躍度系統的UNIQUE約束失敗問題
- 實現測試級別的完整資料隔離
- 建立可靠的資料庫雙態遷移驗證
- 提供comprehensive的資料完整性回歸測試

---

## 功能與非功能需求

### 功能需求

#### F-1: 資料庫遷移與雙態驗證
**描述**: 提供安全可靠的資料庫遷移，支援在空白資料庫和既有資料庫上執行
**驗收條件**:
- 遷移腳本在新建資料庫上成功建立所有結構
- 遷移腳本在現有資料庫上安全更新，不破壞現有資料
- 提供完整的回滾機制
- 所有遷移操作記錄在audit log中

#### F-2: activity_meter表UNIQUE約束修復
**描述**: 修復activity_meter表的主鍵約束，實現真正的UPSERT語義
**驗收條件**:
- 重複的(guild_id, user_id)記錄被正確合併
- UPSERT操作不再產生UNIQUE約束錯誤
- 資料合併邏輯保留最新的last_msg和最大的score值
- 建立適當的索引以優化查詢效能

#### F-3: 測試資料完整隔離
**描述**: 實現測試案例間完全的資料隔離，避免測試資料汙染
**驗收條件**:
- 每個測試案例使用獨立的資料庫實例
- 測試完成後自動清理所有資料
- 支援並行測試執行而不產生衝突
- 提供測試資料工廠以生成一致的測試資料

#### F-4: 資料完整性回歸測試套件
**描述**: 建立全面的資料完整性測試，作為CI/CD pipeline的一部分
**驗收條件**:
- 測試覆蓋所有表的約束條件
- 測試覆蓋外鍵關係的完整性
- 測試覆蓋業務邏輯的資料一致性
- 測試套件可重複執行且結果穩定

### 非功能需求

#### N-1: 遷移效能
**描述**: 遷移操作必須在合理時間內完成
**測量標準**: 大型資料庫(100k+ records)遷移時間 < 5分鐘

#### N-2: 測試執行效能
**描述**: 測試隔離不得顯著影響測試執行速度
**測量標準**: 單一測試案例隔離overhead < 500ms

#### N-3: 資料完整性可靠性
**描述**: 資料完整性檢查必須有高準確性
**測量標準**: 完整性檢查false positive rate < 1%

---

## 範圍定義

### 範圍內項目
- `activity_meter`表結構遷移與UNIQUE約束修復
- 完整的測試資料隔離基礎設施
- 遷移腳本的雙態驗證（新/舊資料庫）
- 基於`pytest`的增強測試配置
- 全面的資料完整性回歸測試套件
- 遷移狀態監控與報告工具

### 範圍外項目
- 其他表的結構變更（除非直接相關於完整性）
- 效能測試工具（T3負責）
- Discord特定測試（T5負責）
- 資料庫遷移到PostgreSQL（未來版本考慮）
- 生產環境熱遷移工具

---

## 技術方案

### 架構概覽
基於現有遷移管理器和測試基礎設施，擴展支援雙態驗證、增強測試隔離、並建立完整性檢查機制。採用分層設計：資料層（遷移執行）、業務層（完整性驗證）、測試層（隔離與工廠）。

### 核心模組

#### 模組1: 增強遷移管理器
**目的**: 擴展現有遷移管理器以支援雙態驗證和回滾
**介面**:
```python
class EnhancedMigrationManager:
    async def verify_dual_state_migration(migration_id: str) -> ValidationResult
    async def rollback_migration(migration_id: str) -> RollbackResult
    async def validate_data_integrity_post_migration() -> IntegrityReport
```
**重用**: 基於 `scripts/migration_manager.py`

#### 模組2: activity_meter遷移腳本
**目的**: 安全修復activity_meter表的UNIQUE約束問題
**介面**:
```sql
-- migrations/0003_fix_activity_meter_unique_constraint.sql
-- 包含資料備份、結構重建、資料合併邏輯
```
**重用**: 參考 `migrations/0002_activity_meter_unique_constraint.sql`

#### 模組3: 測試隔離強化器
**目的**: 提供完整的測試資料隔離與清理
**介面**:
```python
class IsolatedTestEnvironment:
    async def setup_isolated_database() -> TestDatabase
    async def cleanup_test_data() -> CleanupResult
    def generate_test_data_factory() -> TestDataFactory
```
**重用**: 擴展 `test_utils/test_isolation.py`

#### 模組4: 資料完整性檢查器
**目的**: 執行全面的資料完整性驗證
**介面**:
```python
class DataIntegrityChecker:
    async def check_constraint_violations() -> ConstraintReport
    async def verify_foreign_key_integrity() -> FKReport
    async def validate_business_logic_consistency() -> BusinessLogicReport
```
**重用**: 新建，但整合現有驗證邏輯

### 資料模型變更

#### Schema變更
```sql
-- activity_meter表結構優化
CREATE TABLE activity_meter (
    guild_id INTEGER NOT NULL,
    user_id INTEGER NOT NULL,
    score REAL DEFAULT 0,
    last_msg INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (guild_id, user_id)
);
```

#### 遷移步驟
1. **資料備份**: 建立 `activity_meter_backup` 表
2. **結構重建**: 刪除舊表，建立新表結構
3. **資料合併**: 使用聚合查詢去重並合併資料
4. **索引建立**: 建立效能優化索引
5. **驗證檢查**: 確認資料完整性

### 測試策略

#### 單元測試
- 遷移腳本的SQL語法正確性測試
- 資料完整性檢查器的邏輯驗證
- 測試隔離工具的功能測試
- 資料合併邏輯的邊界情況測試

#### 整合測試
- 雙態遷移在空白/既有資料庫的執行測試
- 多個測試案例並行執行的隔離驗證
- 完整的遷移-驗證-回滾流程測試
- 跨模組的資料一致性測試

#### 驗收測試
- R3需求的所有驗收條件測試
- 大量資料下的遷移效能測試
- 長時間運行的測試隔離穩定性測試
- 異常情況下的資料恢復測試

### 品質標準
- 遷移成功率: 100%（在標準測試環境）
- 測試隔離成功率: 100%（無資料洩漏）
- 資料完整性檢查覆蓋率: ≥95%
- 所有關鍵路徑的異常處理覆蓋率: ≥90%

---

## 里程碑與時程

### 里程碑1: 遷移基礎建設完成
**交付成果**:
- 增強的遷移管理器實現
- activity_meter遷移腳本完成
- 雙態驗證機制實現
**完成定義**:
- 所有遷移腳本語法驗證通過
- 雙態驗證在測試環境執行成功
- 遷移管理器單元測試100%通過

### 里程碑2: 測試隔離系統就緒
**交付成果**:
- 強化的測試隔離基礎設施
- 測試資料工廠實現
- 並行測試支援
**完成定義**:
- 測試隔離在CI環境穩定運行
- 並行測試無資料衝突
- 測試資料清理100%成功

### 里程碑3: 完整性回歸套件部署
**交付成果**:
- 全面的資料完整性測試套件
- CI/CD整合
- 監控與報告機制
**完成定義**:
- 完整性測試套件在CI中執行
- 所有R3驗收條件測試通過
- 監控報告準確反映系統狀態

---

## 時程安排

**開始日期**: 2025-08-22  
**結束日期**: 2025-08-29  

### 詳細時程
- **8/22-8/23**: 里程碑1 - 遷移基礎建設
- **8/24-8/26**: 里程碑2 - 測試隔離系統  
- **8/27-8/29**: 里程碑3 - 完整性回歸套件

---

## 依賴關係

### 外部依賴
- **SQLite**: 3.35+ (支援RETURNING語法)
- **pytest**: 6.0+ (用於增強測試基礎設施)
- **aiosqlite**: 用於異步資料庫操作

### 內部依賴
- **T3任務**: SQLite併發優化必須完成
- **core模組**: 資料庫管理器和服務啟動管理器
- **現有遷移系統**: `scripts/migration_manager.py`

---

## 工作量估算

### 估算方法
基於三點估算法：樂觀、悲觀、最可能時間

### 總結
- **總人天**: 6天
- **信心水準**: 高

### 詳細分解
- **遷移系統增強**: 2天（遷移腳本開發、雙態驗證實現）
- **測試隔離強化**: 2天（隔離基礎設施、資料工廠）
- **完整性測試套件**: 1.5天（測試開發、CI整合）
- **文件與整合測試**: 0.5天（文件更新、端到端測試）

---

## 風險管理

### 風險1: 資料遷移失敗
**機率**: 中等  
**影響**: 高  
**緩解措施**: 
- 在所有遷移前強制建立完整備份
- 實現自動回滾機制
- 在staging環境充分測試
**應急計劃**: 使用備份資料快速恢復，延後遷移至修復問題

### 風險2: 測試隔離不完全
**機率**: 中等  
**影響**: 中等  
**緩解措施**:
- 使用獨立的臨時資料庫檔案
- 實現嚴格的清理機制
- 並行測試資料命名空間隔離
**應急計劃**: 回退到序列測試執行，調查隔離漏洞

### 風險3: 效能影響
**機率**: 低  
**影響**: 中等  
**緩解措施**:
- 記憶體資料庫用於快速測試
- 異步清理操作
- 索引優化查詢
**應急計劃**: 調整隔離策略，減少不必要的資料操作

---

## 開放問題

1. **是否需要支援SQLite之外的資料庫系統？**
   - 當前範圍專注SQLite，PostgreSQL支援留待未來版本

2. **測試資料大小限制？**
   - 建議單一測試案例資料量 < 10MB，避免效能問題

3. **遷移回滾的粒度？**
   - 支援單一遷移回滾，不支援多遷移原子回滾

---

## 註釋

- 本計劃假設T3併發優化已完成，將重用其SQLite配置
- 完整性測試將整合到現有CI pipeline中
- 所有新增的測試工具將遵循專案現有的testing conventions
- 遷移腳本將遵循現有的編號和命名規範

---

## 開發備註

**描述**: 實施過程中的技術記錄，符合 dev_notes_v1 結構  
**開發者類型**: task-planner  
**時間戳**: 2025-08-22T10:30:00Z  
**任務階段**: 初始實施  
**重新開發迭代**: 1  
**變更摘要**: 建立T4資料完整性與測試隔離的完整實施計劃，涵蓋遷移雙態驗證、測試隔離強化、以及完整性回歸套件三大核心領域。計劃基於現有基礎設施進行擴展，確保與T3併發優化的協同作用。

**對應功能需求映射**:
- F-1: 資料庫遷移與雙態驗證
- F-2: activity_meter表UNIQUE約束修復  
- F-3: 測試資料完整隔離
- F-4: 資料完整性回歸測試套件

**對應非功能需求映射**:
- N-1: 遷移效能 (< 5分鐘)
- N-2: 測試執行效能 (隔離overhead < 500ms)  
- N-3: 資料完整性可靠性 (false positive < 1%)

**對應UI需求映射**:
- N/A - 本任務主要為後端基礎設施

**技術實作決策與理由**:
擴展現有遷移管理器而非重寫，因為它已具備基本功能且經過測試。採用記憶體資料庫進行快速測試隔離，平衡效能與隔離需求。實現雙態驗證確保遷移在新舊資料庫環境都能安全執行。使用pytest fixture強化測試基礎設施，提供資料工廠模式以生成一致的測試資料。

**風險考量與緩解措施**:
主要風險為資料遷移失敗可能影響生產資料。通過強制備份、自動回滾、staging環境充分測試來緩解。測試隔離不完全可能導致測試間相互影響，通過獨立資料庫檔案、嚴格清理機制、命名空間隔離來防範。效能影響透過記憶體資料庫、異步清理、索引優化來最小化。

**維護要點與監控建議**:
定期檢查遷移管理器的狀態記錄，確保所有遷移都有正確的audit trail。監控測試隔離的清理成功率，及時發現潛在的資料洩漏問題。在CI中設置完整性測試的閾值警報，確保資料品質不會退化。建議每季度審查遷移腳本，確保與最新的資料庫schema保持一致。

**主要挑戰與與計劃偏離**:
活躍度表的UNIQUE約束修復需要謹慎的資料合併邏輯，特別是處理重複記錄時要保留最有意義的資料。測試隔離在高並行環境下可能遇到檔案系統競爭條件，需要實現適當的同步機制。雙態遷移驗證的覆蓋範圍可能比預期更複雜，特別是處理各種edge case。整體而言，技術風險可控，主要依賴現有infrastructure的穩定性。

**品質指標達成情況**:
計劃階段設定的品質標準：遷移成功率100%、測試隔離成功率100%、資料完整性檢查覆蓋率≥95%、異常處理覆蓋率≥90%。這些指標將在實施過程中持續監控和驗證，確保T4任務達到R3需求的所有驗收條件。

**驗證警告**: []