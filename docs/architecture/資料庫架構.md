# 資料庫架構

## PostgreSQL 資料庫結構

```sql
-- 核心使用者表
CREATE TABLE users (
    user_id BIGINT PRIMARY KEY,
    username VARCHAR(255) NOT NULL,
    display_name VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 貨幣系統
CREATE TABLE currencies (
    currency_id SERIAL PRIMARY KEY,
    guild_id BIGINT NOT NULL,
    name VARCHAR(100) NOT NULL,
    symbol VARCHAR(10),
    icon_url VARCHAR(500),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE user_currencies (
    user_id BIGINT REFERENCES users(user_id),
    currency_id INTEGER REFERENCES currencies(currency_id),
    balance BIGINT DEFAULT 0,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, currency_id)
);

CREATE TABLE currency_transactions (
    transaction_id SERIAL PRIMARY KEY,
    from_user_id BIGINT REFERENCES users(user_id),
    to_user_id BIGINT REFERENCES users(user_id),
    currency_id INTEGER REFERENCES currencies(currency_id),
    amount BIGINT NOT NULL,
    transaction_type VARCHAR(50) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 政府系統
CREATE TABLE departments (
    department_id SERIAL PRIMARY KEY,
    guild_id BIGINT NOT NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    parent_id INTEGER REFERENCES departments(department_id),
    role_id BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE user_departments (
    user_id BIGINT REFERENCES users(user_id),
    department_id INTEGER REFERENCES departments(department_id),
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    assigned_by BIGINT REFERENCES users(user_id),
    PRIMARY KEY (user_id, department_id)
);

-- 成就系統
CREATE TABLE achievements (
    achievement_id SERIAL PRIMARY KEY,
    guild_id BIGINT NOT NULL,
    category VARCHAR(100),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    criteria JSONB NOT NULL,
    rewards JSONB,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE user_achievements (
    user_id BIGINT REFERENCES users(user_id),
    achievement_id INTEGER REFERENCES achievements(achievement_id),
    unlocked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    progress JSONB,
    PRIMARY KEY (user_id, achievement_id)
);

-- 活躍度系統
CREATE TABLE activity_records (
    record_id SERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(user_id),
    guild_id BIGINT NOT NULL,
    activity_type VARCHAR(50) NOT NULL,
    score_delta INTEGER DEFAULT 0,
    recorded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引優化
CREATE INDEX idx_user_currencies_balance ON user_currencies(balance DESC);
CREATE INDEX idx_currency_transactions_created_at ON currency_transactions(created_at DESC);
CREATE INDEX idx_activity_records_user_guild ON activity_records(user_id, guild_id);
CREATE INDEX idx_achievements_guild_category ON achievements(guild_id, category);
```
