# Discord ADR Bot v1.6.3 產品需求文件 (PRD)

## 📋 需求概述

本版本主要修復各模組面板載入問題，恢復核心功能，並增強系統權限驗證機制。所有修復都應遵循項目的統一錯誤處理和模組化架構原則。

## 🎯 核心修復需求

### 1. Welcome Cog 歡迎模組修復
**問題描述**: 面板載入失敗
**優先級**: 高
**模組路徑**: `cogs/welcome/`

**技術規格**:
- 檢查 `panel/main_view.py` 中的視圖初始化
- 修復 `components/modals.py` 中的模態框載入問題
- 確保 `database/database.py` 連接池正常運作
- 驗證 `config/config.py` 配置載入

**預期行為**:
- 面板能正常載入並顯示歡迎設定介面
- 所有按鈕和選項正常響應
- 歡迎圖片生成功能正常運作

**錯誤碼範圍**: 501-510
**測試標準**: 
- [ ] 面板載入無異常
- [ ] 設定保存成功
- [ ] 歡迎圖片正常生成

### 2. Anti-Executable Cog 反可執行檔案模組修復
**問題描述**: 面板載入發生錯誤
**優先級**: 高
**模組路徑**: `cogs/protection/anti_executable/`

**技術規格**:
- 檢查 `panel/main_view.py` 的視圖類繼承問題
- 修復 `components/buttons.py` 中的按鈕回調函數
- 驗證 `database/database.py` 的資料表結構
- 確保 `embeds/` 目錄下的嵌入訊息格式正確

**預期行為**:
- 防護設定面板正常載入
- 黑名單/白名單編輯功能正常
- 檔案格式檢測功能正常運作
- 統計資料正確顯示

**錯誤碼範圍**: 511-520
**測試標準**:
- [ ] 面板載入無異常
- [ ] 防護規則正常運作
- [ ] 統計資料準確顯示

### 3. 性能監控模組增強
**問題描述**: 改為非僅個人可見，加入權限認證
**優先級**: 中
**模組路徑**: `cogs/core/performance_dashboard.py`

**技術規格**:
- 移除 `ephemeral=True` 設定
- 實作權限驗證裝飾器 `@require_permission("manage_guild")`
- 加入用戶權限檢查邏輯
- 增強資料展示的安全性

**預期行為**:
- 只有具備管理權限的用戶可以查看
- 性能數據公開顯示（非私人訊息）
- 保護敏感系統資訊

**錯誤碼範圍**: 521-530
**測試標準**:
- [ ] 權限檢查正常運作
- [ ] 非管理員無法訪問
- [ ] 資料顯示正確

### 4. Anti-Spam 反垃圾訊息模組恢復
**問題描述**: 面板開啟後顯示功能正在重構，恢復其應有功能
**優先級**: 高
**模組路徑**: `cogs/protection/anti_spam/`

**技術規格**:
- 移除「功能正在重構」的暫時性訊息
- 恢復垃圾訊息檢測演算法
- 修復 `main/main.py` 中的核心邏輯
- 確保 `panel/embeds/settings_embed.py` 正常顯示

**預期行為**:
- 垃圾訊息自動檢測和處理
- 設定面板完全可用
- 白名單功能正常運作
- 統計資料正確追蹤

**錯誤碼範圍**: 531-540
**測試標準**:
- [ ] 垃圾訊息檢測正常
- [ ] 設定面板功能完整
- [ ] 統計資料準確

### 5. Sync Data 資料同步模組修復
**問題描述**: 載入狀態發生錯誤，修復問題，把已經加入面板的斜線指令取消註冊
**優先級**: 高
**模組路徑**: `cogs/sync_data/`

**技術規格**:
- 修復 `main/main.py` 中的載入狀態邏輯
- 移除重複的斜線指令註冊
- 修復 `panel/embeds/status_embed.py` 的狀態顯示
- 確保 `database/database.py` 同步狀態正確追蹤

**預期行為**:
- 同步狀態正確顯示
- 無重複的斜線指令
- 同步操作正常執行
- 歷史記錄正確記錄

**錯誤碼範圍**: 541-550
**測試標準**:
- [ ] 載入狀態顯示正確
- [ ] 斜線指令無重複
- [ ] 同步功能正常運作

### 6. Activity Meter 活躍度模組修復
**問題描述**: 活躍度條無法正常顯示中文字體，面板載入失敗
**優先級**: 高
**模組路徑**: `cogs/activity_meter/`

**技術規格**:
- 修復 `main/renderer.py` 中的中文字體載入問題
- 檢查字體文件路徑: `fonts/NotoSansCJKtc-Regular.otf`, `fonts/wqy-microhei.ttc`
- 修復 `panel/main_view.py` 的載入問題
- 確保 `main/calculator.py` 分數計算正確

**預期行為**:
- 活躍度條正確顯示中文用戶名
- 面板載入和操作正常
- 分數計算和排行榜功能正常
- 圖片生成包含正確的中文字體

**錯誤碼範圍**: 551-560
**測試標準**:
- [ ] 中文字體顯示正常
- [ ] 面板載入無異常
- [ ] 排行榜功能正常

### 7. Anti-Link 反連結模組恢復
**問題描述**: 面板顯示已停用，恢復其應有功能
**優先級**: 高
**模組路徑**: `cogs/protection/anti_link/`

**技術規格**:
- 移除「已停用」狀態標記
- 恢復連結檢測邏輯在 `main/main.py`
- 修復 `panel/embeds/config_embed.py` 的配置顯示
- 確保黑名單/白名單功能正常

**預期行為**:
- 連結檢測和攔截功能正常
- 設定面板完全可用
- 黑名單/白名單管理功能正常
- 統計資料正確顯示

**錯誤碼範圍**: 561-570
**測試標準**:
- [ ] 連結檢測正常運作
- [ ] 設定面板功能完整
- [ ] 統計資料準確

## 🔧 技術實現指南

### 統一錯誤處理
所有修復都必須使用項目的統一錯誤處理機制：

```python
from cogs.core.error_handler import create_error_handler

# 在每個模組中
handler = create_error_handler(self.__class__.__name__)
with handler.handle_error(error_code=具體錯誤碼):
    # 業務邏輯
```

### 面板載入標準流程
1. 檢查 `main_view.py` 中的視圖初始化
2. 驗證 `components/` 目錄下的組件載入
3. 確保 `embeds/` 目錄下的嵌入訊息格式
4. 測試資料庫連接和查詢

### 權限驗證實現
```python
def is_allowed(interaction: discord.Interaction, action: str = "") -> bool:
    """檢查用戶權限"""
    if not interaction.guild:
        return False
    member = interaction.guild.get_member(interaction.user.id)
    return member.guild_permissions.manage_guild if member else False
```

### 日誌記錄要求
所有修復都必須包含適當的日誌記錄：

```python
logger = setup_module_logger(self.__class__.__name__)
logger.info(f"模組載入完成: {self.__class__.__name__}")
```

## 📊 測試標準

### 自動化測試
- [ ] 所有模組的單元測試通過
- [ ] 面板載入測試無異常
- [ ] 資料庫操作測試正常
- [ ] 錯誤處理測試覆蓋

### 手動測試
- [ ] 所有面板可以正常載入
- [ ] 功能按鈕響應正常
- [ ] 資料顯示正確
- [ ] 錯誤訊息友好

### 性能測試
- [ ] 面板載入時間 < 2秒
- [ ] 資料庫查詢時間 < 50ms
- [ ] 記憶體使用量 < 200MB
- [ ] 無記憶體洩漏

## 🚀 部署要求

### 向後兼容性
- [ ] 現有資料庫結構保持不變
- [ ] 現有配置格式保持兼容
- [ ] 用戶權限設定保持不變

### 部署檢查清單
- [ ] 所有依賴項目已更新
- [ ] 資料庫遷移腳本已執行
- [ ] 配置文件已驗證
- [ ] 日誌目錄已創建

## 📝 完成標準

### 定義完成 (Definition of Done)
- [ ] 所有需求功能已實現
- [ ] 所有測試已通過
- [ ] 程式碼已通過審查
- [ ] 文檔已更新
- [ ] 部署已驗證

### 驗收條件
- [ ] 所有面板載入正常
- [ ] 所有功能按設計運作
- [ ] 無關鍵錯誤或警告
- [ ] 性能符合指標要求
- [ ] 用戶體驗流暢

## 🔍 除錯指南

### 常見問題排查
1. **面板載入失敗**: 檢查視圖類繼承和初始化
2. **按鈕無響應**: 驗證回調函數和權限
3. **資料庫錯誤**: 檢查連接池和表結構
4. **字體問題**: 確認字體文件路徑和格式

### 日誌檔案位置
- 主要日誌: `logs/main.log`
- 錯誤日誌: `logs/main_error.log`
- 模組日誌: `logs/[模組名].log`

### 除錯命令
```bash
# 檢查日誌
tail -f logs/main.log

# 執行測試
python -m pytest tests/ -v

# 檢查程式碼品質
python quality_check.py
```