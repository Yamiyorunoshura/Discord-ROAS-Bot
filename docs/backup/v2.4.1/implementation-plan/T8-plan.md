# 任務 T8 實施計劃：錯誤代碼系統統一化

## 元資料 (Metadata)

- **任務ID**: T8
- **專案名稱**: roas-bot
- **負責人**: David (任務規劃師)
- **日期**: 2025-08-23
- **專案根目錄**: /Users/tszkinlai/Coding/roas-bot
- **來源文件**:
  - 類型: requirements  
    路徑: /Users/tszkinlai/Coding/roas-bot/docs/specs/requirement.md
  - 類型: task  
    路徑: /Users/tszkinlai/Coding/roas-bot/docs/specs/task.md
  - 類型: design  
    路徑: /Users/tszkinlai/Coding/roas-bot/docs/specs/design.md
- **假設**:
  - 現有 `src/core/errors.py` 和 `src/core/error_codes.py` 模組提供良好基礎
  - 所有服務模組都已實施基本錯誤處理但需要標準化
  - 錯誤代碼格式採用 `[模組]-[數字]` 規範（如 ACH_1200、ECO_1300）
- **約束**:
  - 不可破壞現有API接口的向後相容性
  - 必須確保使用者訊息和日誌記錄的一致性
  - 錯誤代碼必須具備唯一性且不可重用已廢止代碼

## 上下文 (Context)

### 摘要
統一化專案中的錯誤代碼系統，確保所有模組在錯誤處理上採用一致的錯誤代碼、訊息格式和日誌記錄方式，提升系統的可維運性和問題追蹤效率。

### 背景
目前系統已具備基礎錯誤處理架構，包含自定義異常類別（ServiceError、DatabaseError等）和初步的錯誤代碼枚舉。然而，各服務模組在實際使用錯誤代碼時存在不一致性，部分模組未完全採用標準化錯誤代碼，導致問題追蹤和維運困難。

### 目標
- 建立完整且一致的錯誤代碼規範文件
- 確保所有服務模組採用統一錯誤代碼
- 實現使用者訊息與日誌記錄的完全一致性
- 建立錯誤代碼管理的版本化策略

## 目標 (Objectives)

### 功能性需求
- **F-1**: 錯誤代碼規範制定
  描述: 建立統一的錯誤代碼命名規範、分類體系和版本化管理策略
  驗收條件:
    - 產出完整的錯誤代碼規範文件，涵蓋命名規則、分類標準、新增流程
    - 定義錯誤代碼生命週期管理（新增、修改、廢止）的標準程序
    - 建立錯誤代碼與問題來源的明確對應關係

- **F-2**: 模組錯誤處理標準化
  描述: 所有關鍵服務模組採用統一錯誤代碼拋出和記錄機制  
  驗收條件:
    - Achievement、Economy、Government、Activity等服務完全採用標準錯誤代碼
    - 異常拋出時自動附帶正確錯誤代碼和上下文資訊
    - 所有錯誤記錄包含一致格式的錯誤代碼和詳細資訊

### 非功能性需求
- **N-1**: 效能影響
  描述: 錯誤處理標準化不得顯著影響系統效能
  測量標準: 錯誤代碼轉換和訊息格式化時間 < 1ms，對正常業務邏輯影響 < 0.1%

- **N-2**: 可維護性
  描述: 錯誤代碼系統需易於擴展和維護
  測量標準: 新增錯誤代碼時間 < 5分鐘，錯誤追蹤效率提升 > 50%

## 範圍 (Scope)

### 包含範圍
- 更新和完善 `src/core/error_codes.py` 中的錯誤代碼枚舉
- 建立 `docs/error-codes.md` 規範文件
- 標準化 Achievement、Economy、Government、Activity、Database 等核心服務的錯誤處理
- 實施日誌記錄與使用者訊息的一致性檢查
- 建立錯誤代碼一致性整合測試

### 排除範圍
- Discord Bot 框架層級的異常處理修改
- 第三方庫錯誤的重新包裝（僅映射到標準錯誤代碼）
- UI/UX 層面的錯誤訊息國際化（保持繁體中文）
- 效能監控系統的錯誤追蹤整合

## 方法 (Approach)

### 架構概述
採用集中式錯誤代碼管理架構，基於現有 `src/core/error_codes.py` 模組擴展，確保所有服務透過統一的錯誤代碼映射和格式化機制處理異常。

### 模組設計

#### 核心模組
- **錯誤代碼管理器** (`src/core/error_codes.py`)
  目的: 集中管理所有錯誤代碼定義、映射和格式化
  介面:
    - `map_exception_to_error_code(exception) -> ErrorCode`
    - `get_user_message(error_code, context) -> str`
    - `format_error_response(exception, include_technical_details) -> Dict`
    - `log_error(logger, exception, context) -> None`
  重用: 擴展現有模組，新增版本化和一致性檢查功能

- **錯誤處理中介器** (`src/core/error_middleware.py`)
  目的: 提供服務層錯誤處理的標準化裝飾器和工具
  介面:
    - `@standardized_error_handling` 裝飾器
    - `ErrorCodeValidator` 驗證器
    - `ConsistencyChecker` 一致性檢查器
  重用: 新建模組，整合現有錯誤處理邏輯

### 資料設計

#### Schema 變更
錯誤代碼枚舉擴展：
```python
class ErrorCode(Enum):
    # 新增統一命名規範的錯誤代碼
    # [模組縮寫]_[類別]_[編號]
    CORE_CONFIG_1000 = "CORE-CFG-1000"
    DB_LOCK_2001 = "DB-LOCK-2001"  
    SRV_ACH_3001 = "SRV-ACH-3001"
    # ... 其他標準化錯誤代碼
```

#### 遷移步驟
- 不需要資料庫 Schema 遷移
- 現有錯誤代碼逐步遷移到新命名規範
- 提供向後相容性映射期（3個版本週期）

### 測試策略

#### 單元測試
- `tests/unit/test_error_code_mapping.py`: 測試錯誤代碼映射邏輯正確性
- `tests/unit/test_error_message_formatting.py`: 測試使用者訊息格式化一致性
- `tests/unit/test_error_consistency.py`: 測試各服務錯誤處理一致性

#### 整合測試  
- `tests/integration/test_service_error_standards.py`: 驗證所有服務採用標準錯誤處理
- `tests/integration/test_error_logging_consistency.py`: 驗證日誌記錄格式一致性
- `tests/integration/test_user_message_consistency.py`: 驗證使用者訊息與日誌一致性

#### 驗收測試
- 錯誤追蹤場景測試：模擬各種錯誤情況，確認錯誤代碼正確且可追蹤
- 相容性測試：確認現有API和使用者體驗無重大變更

### 品質閘道
- 錯誤代碼覆蓋率 >= 95%（所有自定義異常都有對應錯誤代碼）
- 錯誤處理一致性測試通過率 = 100%
- 日誌格式標準化檢查通過率 = 100%
- 使用者訊息與錯誤代碼一致性檢查通過率 = 100%

## 里程碑 (Milestones)

### M1: 錯誤代碼規範建立
**交付物**:
- `docs/error-codes.md` 完整規範文件
- 更新的 `src/core/error_codes.py` 包含標準化錯誤代碼
- `src/core/error_middleware.py` 錯誤處理中介器模組

**完成定義**:
- 錯誤代碼規範文件通過技術評審
- 所有計劃中的錯誤代碼已定義並通過唯一性檢查  
- 錯誤處理中介器模組通過單元測試

### M2: 服務模組標準化實施
**交付物**:
- 標準化的 Achievement、Economy、Government、Activity 服務錯誤處理
- 更新的錯誤處理邏輯和日誌記錄
- 服務層錯誤處理一致性驗證

**完成定義**:
- 所有目標服務模組採用標準錯誤代碼
- 整合測試通過率達100%
- 錯誤處理效能影響測試通過

### M3: 一致性驗證和文件更新
**交付物**:
- 完整的錯誤代碼一致性測試套件
- 更新的系統文件和錯誤排解指南
- 錯誤處理最佳實踐文件

**完成定義**:
- 一致性檢查測試全部通過
- 錯誤追蹤效率驗證完成
- 文件評審通過並發布

## 時程 (Timeline)

- **開始日期**: 2025-08-23
- **結束日期**: 2025-08-30
- **排程**:
  - M1 (錯誤代碼規範建立): 2025-08-23 ~ 2025-08-25
  - M2 (服務模組標準化): 2025-08-25 ~ 2025-08-28  
  - M3 (一致性驗證): 2025-08-28 ~ 2025-08-30

## 依賴 (Dependencies)

### 外部依賴
- Python 3.13: 確保類型註解和新語法支援
- pytest: 單元測試和整合測試執行環境

### 內部依賴
- 核心基礎設施團隊: 確認核心錯誤處理架構變更不影響其他模組
- 測試團隊: 協助建立一致性驗證測試套件

## 估算 (Estimation)

### 方法
採用工作分解結構 (WBS) 結合專家判斷法進行估算

### 摘要
- **總人天**: 6 人天
- **信心程度**: 高

### 分解
- **錯誤代碼規範制定**: 1.5 人天
  - 規範文件編寫: 1 人天
  - 錯誤代碼枚舉更新: 0.5 人天
- **中介器模組開發**: 1 人天
  - 裝飾器和工具實作: 0.7 人天
  - 單元測試: 0.3 人天
- **服務模組標準化**: 2.5 人天
  - Achievement服務: 0.7 人天
  - Economy服務: 0.6 人天
  - Government服務: 0.6 人天
  - Database模組: 0.6 人天
- **一致性測試開發**: 1 人天
  - 整合測試: 0.7 人天
  - 一致性驗證腳本: 0.3 人天

## 風險 (Risks)

### R1: 向後相容性破壞
**描述**: 錯誤代碼標準化可能破壞現有API使用者的錯誤處理邏輯
**機率**: 中  
**影響**: 高
**緩解措施**: 實施錯誤代碼映射機制，提供3個版本的過渡期，維持舊錯誤代碼的映射關係
**應急計劃**: 準備回滾機制，在發現重大相容性問題時快速恢復舊版錯誤處理

### R2: 效能影響
**描述**: 新增的錯誤處理邏輯可能影響系統整體效能
**機率**: 低
**影響**: 中
**緩解措施**: 在開發階段進行效能基準測試，確保錯誤代碼轉換時間 < 1ms
**應急計劃**: 準備效能優化版本，必要時採用快取機制加速錯誤代碼查找

### R3: 測試覆蓋不完整
**描述**: 複雜的錯誤處理邏輯可能導致測試覆蓋率不足，隱藏潛在問題
**機率**: 中
**影響**: 中  
**緩解措施**: 建立comprehensive測試矩陣，確保每種錯誤類型和使用場景都有對應測試
**應急計劃**: 實施段階式發布，先在測試環境充分驗證再部署到生產環境

## 開放問題 (Open Questions)

目前無待解決問題。所有技術實作細節和架構決策都已明確定義。

## 備註 (Notes)

- 本實施計劃嚴格遵循專案現有的程式碼風格和架構原則
- 錯誤代碼設計考慮了未來擴展需求，預留足夠的編號空間
- 實施過程中將持續關注對現有功能的影響，確保零中斷升級
- 建議在實施過程中建立錯誤處理最佳實踐文件，供後續開發參考

## 開發筆記檔案位置
- **路徑**: docs/dev-notes/T8-dev-notes.md  
- **Schema**: 參考 unified-developer-workflow.yaml 中的 dev_notes_v1 結構
- **說明**: 開發者在實施過程中將在獨立檔案中填寫詳細記錄，包含技術決策、實作細節、測試結果和問題解決方案，不在計劃檔案中維護