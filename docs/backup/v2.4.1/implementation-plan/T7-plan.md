# T7 環境與依賴管理實施計劃

## 元資料 (Metadata)

- **任務ID**: T7
- **專案名稱**: Discord機器人系統 - 環境與依賴管理
- **負責人**: 開發團隊
- **建立日期**: 2025-08-23
- **專案根目錄**: /Users/tszkinlai/Coding/roas-bot
- **來源規格檔案**:
  - requirements: /Users/tszkinlai/Coding/roas-bot/docs/specs/requirement.md
  - task: /Users/tszkinlai/Coding/roas-bot/docs/specs/task.md  
  - design: /Users/tszkinlai/Coding/roas-bot/docs/specs/design.md
- **內容雜湊**: e8738a098d12e1f33be4352a774d4a1c895f41ba0b563b3001ba74a388a32629

### 關鍵假設
- uv 工具已在開發與 CI 環境中可用或可安裝
- 現有 pyproject.toml 結構良好，僅需調整與增強
- CI 環境支援 uv 快取機制

### 技術約束  
- 必須保持向後相容性，避免破壞現有開發工作流程
- CI 流程變更必須確保所有測試持續通過
- 鎖定檔案須納入版本控制以確保環境一致性

## 專案背景 (Context)

### 摘要
實施以 uv 與 pyproject.toml 為核心的現代 Python 依賴管理系統，提升建置速度和環境重現性，同時建立完整的依賴管理策略文檔。

### 背景描述
專案目前已具備 pyproject.toml 基礎架構，但仍使用傳統 pip 進行依賴安裝。隨著專案複雜度增長，需要更快、更可靠的依賴管理工具鏈來支撐開發與 CI/CD 流程。

### 目標導向
- 建立快速且可重現的依賴安裝體驗
- 確保所有環境的依賴版本一致性
- 簡化新開發者的環境設置流程
- 提升 CI 建置效率

## 功能與非功能需求 (Objectives)

### 功能需求
- **F-7-1**: 建立完整的 uv 依賴管理工作流程
  - **驗收條件**:
    - pyproject.toml 包含所有必要的專案設定
    - uv.lock 檔案正確鎖定所有依賴版本
    - 可透過單一 `uv sync` 指令完成環境建置

- **F-7-2**: CI 流程完全遷移至 uv 工具鏈
  - **驗收條件**:
    - 所有 CI 工作流程使用 uv 安裝依賴
    - CI 建置時間較使用 pip 時縮短至少 30%
    - 所有現有測試在新 CI 流程下正常執行

- **F-7-3**: 依賴管理策略文檔化
  - **驗收條件**:
    - 提供完整的依賴更新策略文檔
    - 包含安全審核與緊急回滾流程
    - 開發者可依文檔獨立完成環境設置

### 非功能需求
- **N-7-1**: 建置效能提升
  - **衡量標準**: CI 依賴安裝時間 < 60 秒（較現有 pip 方式提升 30%+）
  
- **N-7-2**: 環境一致性
  - **衡量標準**: 開發、測試、生產環境依賴版本 100% 一致

- **N-7-3**: 開發者體驗
  - **衡量標準**: 新環境設置時間 < 5 分鐘（從零到可運行測試）

## 範圍界定 (Scope)

### 納入範圍
- pyproject.toml 調整與優化
- uv.lock 檔案生成與維護
- CI 工作流程遷移至 uv
- 依賴管理策略文檔撰寫
- 開發環境設置文檔更新

### 排除範圍
- 現有依賴套件的版本升級（僅鎖定當前版本）
- 套件安全漏洞修復（屬於獨立安全稽核任務）
- Docker 映像檔的依賴管理調整（由 T6 負責）

## 技術實施方案 (Approach)

### 系統架構概覽
採用 uv 作為核心依賴管理工具，pyproject.toml 作為設定中心，uv.lock 提供精確的版本鎖定。CI 流程透過 uv 快取機制提升建置效率。

### 核心模組設計

#### 模組 M-7-1: pyproject.toml 增強
- **目的**: 優化專案設定，支援 Python 3.13，調整工具設定
- **介面**: 
  - 設定 requires-python >= 3.13
  - 保持現有 dependencies 與 optional-dependencies 結構
- **重用元件**: 保留現有 pytest、coverage、工具設定

#### 模組 M-7-2: uv 工作流程整合
- **目的**: 建立 uv 工具鏈的標準工作流程
- **介面**:
  - `uv sync` 進行完整環境同步
  - `uv add/remove` 進行依賴管理
  - `uv lock` 更新鎖定檔
- **重用元件**: 無（全新工具鏈整合）

#### 模組 M-7-3: CI 工作流程遷移
- **目的**: 將所有 CI 步驟遷移至使用 uv
- **介面**: 修改 .github/workflows/ci.yml 中所有安裝步驟
- **重用元件**: 保持現有測試矩陣與策略

### 資料變更
- **資料異動**: 新增 uv.lock 檔案至版本控制
- **遷移步驟**: 
  1. 執行 `uv lock` 產生初始鎖定檔
  2. 將 uv.lock 加入 git 追蹤
  3. 更新 .gitignore 確保不忽略 uv.lock

### 測試策略

#### 單元測試
- 測試 pyproject.toml 設定正確性
- 驗證 uv 指令執行的冪等性

#### 整合測試  
- 在乾淨環境執行 `uv sync` 驗證可重現性
- CI 工作流程完整性測試

#### 驗收測試
- 全 CI 工作流程執行驗證
- 開發環境快速設置驗證
- 依賴版本一致性驗證

### 品質門檻
- CI 所有測試必須通過（單元、整合、dpytest）
- uv sync 執行時間 < 60 秒
- 文檔完整性檢查通過

## 專案里程碑 (Milestones)

### 里程碑 M1: pyproject 與鎖定流程建立
**交付成果**:
- 更新的 pyproject.toml（支援 Python 3.13）
- 產生的 uv.lock 檔案
- 更新的 README.md 與開發設置文檔

**完成定義**:
- pyproject.toml requires-python 調整為 >= 3.13
- uv.lock 包含所有當前依賴的精確版本
- 開發者可依新文檔成功設置環境

### 里程碑 M2: CI 流程遷移
**交付成果**:
- 更新的 .github/workflows/ci.yml
- CI 快取策略調整
- 所有測試工作正常執行

**完成定義**:
- 所有 pip install 替換為 uv sync 或等價指令
- CI 建置時間較基準減少 30% 以上
- 全部測試矩陣（unit、integration、dpytest）通過

### 里程碑 M3: 依賴管理策略文檔
**交付成果**:
- docs/dependency-policy.md
- 更新的疑難排解文檔

**完成定義**:
- 完整的依賴更新策略與審核流程文檔
- 緊急回滾機制說明
- 開發者可依文檔獨立解決常見問題

## 時程規劃 (Timeline)

- **開始日期**: 2025-08-23
- **結束日期**: 2025-08-25

### 詳細排程
- **M1 (pyproject 與鎖定流程)**: 2025-08-23 → 2025-08-23
- **M2 (CI 流程遷移)**: 2025-08-24 → 2025-08-24  
- **M3 (依賴管理策略文檔)**: 2025-08-25 → 2025-08-25

## 依賴關係 (Dependencies)

### 外部依賴
- uv 工具（版本 >= 0.1.0）
- Python 3.13 可用性

### 內部依賴  
- T9 (Python 3.13 升級) 進行並行協調
- 現有 pyproject.toml 結構維持穩定

## 工作量估算 (Estimation)

- **估算方法**: 開發時數
- **總人日數**: 2.5
- **信心度**: 高

### 工作分解
- pyproject.toml 調整與 uv.lock 生成: 0.5 人日
- CI 工作流程遷移與測試: 1.0 人日
- 文檔撰寫與更新: 0.5 人日
- 整體測試與驗證: 0.5 人日

## 風險管控 (Risks)

### 風險 R7-1: uv 工具相容性問題
- **描述**: uv 可能與現有依賴套件存在相容性問題
- **機率**: 中
- **影響度**: 中
- **緩解措施**: 在隔離環境進行全面測試，準備降級至 pip 的備案
- **應急計劃**: 保留原有 pip 工作流程，分階段遷移

### 風險 R7-2: CI 工作流程中斷
- **描述**: CI 遷移可能造成建置失敗
- **機率**: 低  
- **影響度**: 高
- **緩解措施**: 先在分支環境測試，確認穩定後才合併主分支
- **應急計劃**: 立即回退至原有 CI 設定檔

### 風險 R7-3: 開發者工作流程影響
- **描述**: 工具切換可能造成開發者困擾
- **機率**: 中
- **影響度**: 低
- **緩解措施**: 提供詳細遷移指南與常見問題解答
- **應急計劃**: 同時支援 pip 與 uv 工作流程一段過渡期

## 待釐清議題 (Open Questions)

無具體待釐清議題。所有技術路徑明確，實施風險可控。

## 備註說明 (Notes)

- 本任務與 T9 (Python 3.13 升級) 有輕度耦合，建議並行執行
- uv 工具仍為相對新穎的工具，需密切關注社群回饋與更新
- 建議在實施過程中記錄詳細的效能基準數據，以利後續優化

---

**開發筆記位置**: docs/dev-notes/T7-dev-notes.md  
**開發筆記結構**: 參考 unified-developer-workflow.yaml 中的 dev_notes_v1 結構  
**注意事項**: 開發者將在實施過程中於獨立檔案填寫詳細記錄