<!-- BEGIN:DOC(requirement) v1 -->

## 1. 簡介 (Introduction)

本文件定義本專案於 v2.4.1 的修復與強化需求。範圍涵蓋：修復成就系統啟動與依賴（R1）、資料庫併發鎖定與效能（R2）、測試資料完整性（R3）；以及強化測試系統與 dpytest/隨機交互（R4）、統一錯誤代碼（R5）、以 uv 與 pyproject.toml 管理依賴（R6）、升級至 Python 3.13（R7）、跨平台 Docker 一鍵啟動（R8）、終端互動管理模式（R9）。目標是全面提升穩定性、可維運性、可測試性與部署便捷性。

假設與限制：
- TBD: 是否在 v2.4.1 採取僅優化 SQLite（連線池/重試/調整鎖策略）而不進行 PostgreSQL 遷移。
- TBD: 壓測基準與併發負載等級需統一（來源、樣本長度、指標統計方法）。
- TBD: 成就系統載入錯誤是否僅發生於特定環境（開發/測試/生產）的差異需確認。
- TBD: 測試資料清理策略（每測試案例資料隔離與清理流程）與責任邊界需明確。
- TBD: 日誌路徑與保留策略需確認是否與完成報告一致（例如 `/logs/main_error.log`）。
- TBD: dpytest 整合範圍（面板/核心/服務）、最低覆蓋要求與隨機測試執行策略（次數、超時、種子）。
- TBD: 錯誤代碼格式規範（命名、分類、語言顯示）、是否對最終使用者顯示以及記錄策略。
- TBD: 依賴管理遷移細節（`requirement.txt` 去留、uv 版本、鎖定檔命名與存放）。
- TBD: Python 3.13 升級相容性清單（含 discord.py 版本）、最低支援 OS 與回滾機制。
- TBD: 跨平台啟動腳本支援類型（Bash/PowerShell）、最低 Docker/Compose 版本與前置需求提示策略。
- TBD: 終端互動模式可用的管理命令範圍、權限限制與審計需求。

## 2. 需求 (Requirements)

### 需求 R1：修復成就系統服務依賴與啟動順序問題

### 使用者故事
**使用者故事：** 作為伺服器管理員，我希望成就系統能在機器人啟動時正確載入並可用，以便使用者能正常獲得成就與獎勵，維持系統功能完整。

#### 驗收標準
- AC-R1-1: 當機器人啟動完成時，成就模組應成功載入，日誌中不應出現「成就服務不可用」或等價錯誤訊息。
- AC-R1-2: 成就系統相關的自動化測試應 100% 通過，無因依賴注入或服務啟動順序造成的失敗。
- AC-R1-3: 針對訊息數量、活躍度、特殊事件等成就觸發條件，在測試環境觸發後應能正確授予成就。
- AC-R1-4: 成就獎勵（經濟與身分組）應正確發放，且與經濟/政府系統整合行為正常。
- AC-R1-5: 對啟動順序或依賴解析的調整不應造成其他服務的啟動錯誤，核心回歸測試應全部通過。

### 需求 R2：修復資料庫併發鎖定與效能穩定性問題

### 使用者故事
**使用者故事：** 作為維運工程師，我希望系統在高併發下不再出現「database is locked」錯誤，以便活躍度與其他頻繁寫入功能能穩定運作。

#### 驗收標準
- AC-R2-1: 在標準化併發負載測試中，「database is locked」錯誤次數相較 v2.4.0 基線應降低至少 90%。
- AC-R2-2: 系統併發處理能力（以單位時間成功完成的寫入/交易數計）相較 v2.4.0 基線應提升至少 50%。
- AC-R2-3: 資料庫操作的 99 百分位回應時間應不大於 100ms。
- AC-R2-4: 壓測期間活躍度系統與其他頻繁寫入功能不應出現功能性失敗或降級不可用的情形。
- AC-R2-5: 在併發優化後，資料完整性（唯一性、外鍵/欄位有效性）應無新增錯誤，相關測試應全部通過。

### 需求 R3：修復測試資料污染與資料完整性問題

### 使用者故事
**使用者故事：** 作為測試工程師，我希望自動化測試不再觸發 UNIQUE 約束失敗或無效欄位錯誤，以便測試結果穩定且可信。

#### 驗收標準
- AC-R3-1: 執行全量測試後，日誌中不應出現 UNIQUE 約束失敗或無效欄位相關錯誤。
- AC-R3-2: 對 `activity_meter` 等表的重複寫入在重跑測試時不應產生重複鍵衝突。
- AC-R3-3: 資料庫遷移在「全新資料庫」與「已有資料庫」兩種情境下均應順利完成，無欄位缺失或不相容問題。
- AC-R3-4: 測試資料建立與清理流程應保證測試案例間資料隔離，重跑同一測試套件不應產生殘留資料。
- AC-R3-5: 與資料完整性相關的測試失敗率應降至 0，測試結果應穩定可重現。

### 需求 R4：完善測試系統並整合 dpytest 與隨機交互

### 使用者故事
**使用者故事：** 作為 QA 工程師，我希望測試系統能整合 dpytest 並提供隨機交互測試，以便覆蓋面板、核心與服務邏輯，提升缺陷發現率。

#### 驗收標準
- AC-R4-1: 測試框架完成 dpytest 整合，可模擬 Discord 事件與互動；本地與 CI 執行時所有 dpytest 測試應成功通過。
- AC-R4-2: 面板邏輯、核心業務邏輯與服務邏輯均具備正常流程、邊界情況與錯誤處理的測試案例。
- AC-R4-3: 提供可設定隨機種子的隨機交互測試模式，當測試失敗時應產生包含重現資訊（含種子與操作序列）的報告。
- AC-R4-4: 隨機交互測試在重複執行下不應出現非決定性（flaky）失敗。
- AC-R4-5: 新增測試不應降低現有測試通過率或破壞現有測試穩定性。

### 需求 R5：建立統一的錯誤代碼系統

### 使用者故事
**使用者故事：** 作為維運與開發人員，我希望系統在錯誤發生時能提供統一且可追溯的錯誤代碼，以便快速定位問題並指引處置。

#### 驗收標準
- AC-R5-1: 提供錯誤代碼規範與對照表，覆蓋主要錯誤類型與來源模組。
- AC-R5-2: 錯誤發生時，使用者可見訊息與後端日誌應包含一致的錯誤代碼。
- AC-R5-3: 相同錯誤在不同模組中使用一致且唯一的代碼，避免重複或衝突。
- AC-R5-4: 文檔提供由錯誤代碼到問題來源與建議處置的查詢指引。
- AC-R5-5: 錯誤代碼的新增或調整須符合版本化與唯一性原則，不得重用已廢止代碼。

### 需求 R6：以 uv 與 pyproject.toml 管理專案依賴

### 使用者故事
**使用者故事：** 作為開發人員，我希望以 uv 與 pyproject.toml 管理依賴，以便獲得更快更可重現的建置體驗。

#### 驗收標準
- AC-R6-1: 專案提供 `pyproject.toml` 定義核心依賴與工具設定，並以 uv 完成依賴安裝與鎖定。
- AC-R6-2: 在乾淨環境可依據單一設定完成可重現安裝，並成功啟動專案與執行測試。
- AC-R6-3: CI 依賴安裝流程切換至 uv 後能穩定通過全部測試。
- AC-R6-4: 依賴鎖定與更新策略被文件化，發佈版本可追溯依賴版本集合。

### 需求 R7：升級至 Python 3.13 並採用新語法

### 使用者故事
**使用者故事：** 作為技術負責人，我希望專案升級至 Python 3.13 並採用可用的新語法，以提升效能與可維護性。

#### 驗收標準
- AC-R7-1: 本地開發與容器運行環境均使用 Python 3.13，版本可被驗證。
- AC-R7-2: 全量測試在 Python 3.13 下全部通過，無功能退化。
- AC-R7-3: 採用 3.13 可用的新語法或標準庫能力，不影響程式碼可讀性與穩定性。
- AC-R7-4: 升級後相關文檔與啟動腳本已更新且與版本一致。

### 需求 R8：提供跨平台（Windows/macOS/Linux）一鍵 Docker 啟動腳本

### 使用者故事
**使用者故事：** 作為系統管理員，我希望在 Windows、macOS 與 Linux 上能以一鍵腳本使用 Docker 啟動機器人，以降低部署門檻。

#### 驗收標準
- AC-R8-1: 提供 Windows 與 *nix 平台的啟動腳本，可自動讀取環境設定並以 Docker 啟動機器人。
- AC-R8-2: 在三大平台上執行腳本後，容器應成功啟動且機器人正常運作，日誌無致命錯誤。
- AC-R8-3: 當缺失前置條件（如未安裝 Docker/Compose）時，腳本應輸出明確錯誤提示與補救指引。
- AC-R8-4: 提供使用說明與疑難排解指引，涵蓋常見錯誤情境。

### 需求 R9：提供基於 input 的終端互動管理模式

### 使用者故事
**使用者故事：** 作為維運工程師，我希望能透過終端輸入指令與機器人互動，以便更容易地進行日常管理與診斷。

#### 驗收標準
- AC-R9-1: 提供互動式終端模式，可透過輸入指令執行常見管理操作，並提供指令清單/說明（help）。
- AC-R9-2: 對非法或未知指令，系統應提示可用指令且不中斷進程或造成異常退出。
- AC-R9-3: 互動模式可安全退出，且在非互動環境可關閉或設置超時退出。
- AC-R9-4: 互動模式行為應被記錄於日誌以利追蹤與審計（不得記錄敏感資訊）。

### 變更摘要
- 新增：R4、R5、R6、R7、R8、R9

<!-- FORMAT_CHECK
doc_type: requirement
schema_version: 1
uses_r_ids: true
ac_prefix: "AC-R{n}-{k}"
sections_present: ["1","2"]
has_tbd: true
-->

<!-- END:DOC -->
