# 錯誤代碼規範文件

## 概述

本文件定義了 roas-bot 專案統一的錯誤代碼系統，確保所有模組在錯誤處理上採用一致的錯誤代碼、訊息格式和日誌記錄方式，提升系統的可維運性和問題追蹤效率。

## 錯誤代碼命名規範

### 基本格式
錯誤代碼採用以下格式：
```
[模組縮寫]_[數字]
```

- **模組縮寫**：3-4個字母，表示錯誤來源模組
- **數字**：4位數字，表示具體錯誤類型

### 模組縮寫對應
| 模組 | 縮寫 | 數字範圍 | 說明 |
|------|------|----------|------|
| 應用程式核心 | APP | 1000-1099 | 通用應用程式錯誤 |
| 服務層 | SVC | 1100-1199 | 服務層錯誤 |
| 成就系統 | ACH | 1200-1299 | 成就相關錯誤 |
| 經濟系統 | ECO | 1300-1399 | 經濟/交易錯誤 |
| 政府系統 | GOV | 1400-1499 | 身分組/權限錯誤 |
| 資料庫 | DB | 1500-1599 | 資料庫操作錯誤 |
| 驗證 | VAL | 1600-1699 | 輸入驗證錯誤 |
| 權限 | PERM | 1700-1799 | 權限控制錯誤 |
| 資源查找 | NF | 1800-1899 | 資源未找到錯誤 |
| 配置 | CFG | 1900-1999 | 配置相關錯誤 |
| 外部服務 | EXT | 2000-2099 | 外部API錯誤 |
| 測試 | TEST | 2100-2199 | 測試相關錯誤 |
| 活動系統 | ACT | 2200-2299 | 活動監控錯誤 |
| 監控系統 | MON | 2300-2399 | 系統監控錯誤 |
| 部署系統 | DEP | 2400-2499 | 部署相關錯誤 |
| 文檔系統 | DOC | 2500-2599 | 文檔管理錯誤 |

## 錯誤代碼分類體系

### 通用錯誤 (APP_1000-1099)
- `APP_1000`: 未知錯誤
- `APP_1001`: 系統內部錯誤
- `APP_1002`: 初始化錯誤
- `APP_1003`: 關閉錯誤
- `APP_1004`: 逾時錯誤

### 服務層錯誤 (SVC_1100-1199)
- `SVC_1100`: 通用服務錯誤
- `SVC_1101`: 服務無法使用
- `SVC_1102`: 服務初始化失敗
- `SVC_1103`: 服務關閉失敗
- `SVC_1104`: 服務依賴錯誤

### 成就系統錯誤 (ACH_1200-1299)
- `ACH_1200`: 成就不存在
- `ACH_1201`: 成就已獲得
- `ACH_1202`: 成就要求未滿足
- `ACH_1203`: 成就進度錯誤
- `ACH_1204`: 成就觸發錯誤
- `ACH_1205`: 成就獎勵發放錯誤
- `ACH_1206`: 成就創建失敗
- `ACH_1207`: 成就更新失敗
- `ACH_1208`: 成就刪除失敗

### 經濟系統錯誤 (ECO_1300-1399)
- `ECO_1300`: 餘額不足
- `ECO_1301`: 金額無效
- `ECO_1302`: 交易失敗
- `ECO_1303`: 餘額查詢錯誤
- `ECO_1304`: 轉帳錯誤
- `ECO_1305`: 帳戶不存在
- `ECO_1306`: 帳戶創建失敗
- `ECO_1307`: 帳戶凍結
- `ECO_1308`: 交易記錄查詢失敗

### 政府系統錯誤 (GOV_1400-1499)
- `GOV_1400`: 身分組不存在
- `GOV_1401`: 身分組指派失敗
- `GOV_1402`: 身分組移除失敗
- `GOV_1403`: 權限不足
- `GOV_1404`: 政府結構錯誤
- `GOV_1405`: 身分組創建失敗
- `GOV_1406`: 身分組刪除失敗
- `GOV_1407`: 權限檢查失敗

### 資料庫錯誤 (DB_1500-1599)
- `DB_1500`: 資料庫連線錯誤
- `DB_1501`: 資料查詢錯誤
- `DB_1502`: 資料約束錯誤
- `DB_1503`: 資料庫逾時
- `DB_1504`: 資料遷移錯誤
- `DB_1505`: 資料完整性錯誤
- `DB_1506`: 資料庫鎖定錯誤
- `DB_1507`: 交易失敗

## 錯誤代碼生命週期管理

### 新增錯誤代碼流程
1. **確定模組和數字範圍**：根據錯誤來源選擇適當的模組縮寫和數字範圍
2. **檢查唯一性**：確保新錯誤代碼未被使用
3. **更新枚舉**：在 `src/core/error_codes.py` 的 `ErrorCode` 枚舉中新增
4. **添加使用者訊息**：在 `get_user_message()` 函數中添加對應的繁體中文訊息
5. **更新文檔**：在本文檔中記錄新增的錯誤代碼
6. **編寫測試**：為新錯誤代碼編寫單元測試

### 修改錯誤代碼流程
1. **向後相容性檢查**：確保修改不會破壞現有功能
2. **映射維護**：如需修改錯誤代碼值，維持舊值的映射關係
3. **文檔更新**：更新文檔說明修改原因和影響
4. **測試更新**：更新相關測試用例

### 廢止錯誤代碼流程
1. **標記廢止**：在程式碼中添加廢止註解
2. **保留映射**：在3個版本週期內保持舊錯誤代碼的映射
3. **文檔記錄**：在文檔中記錄廢止原因和替代方案
4. **逐步移除**：在確認無使用後完全移除

## 使用方式

### 在服務中使用標準化錯誤處理

```python
from src.core.error_codes import ErrorCode
from src.core.errors import ServiceError
from src.core.error_middleware import standardized_error_handling

class MyService:
    @standardized_error_handling
    async def my_method(self):
        try:
            # 業務邏輯
            pass
        except SomeSpecificException as e:
            raise ServiceError(
                "操作失敗",
                service_name=self.name,
                operation="my_method",
                error_code=ErrorCode.SERVICE_ERROR.value,
                cause=e
            )
```

### 錯誤日誌記錄

```python
from src.core.error_codes import log_error

try:
    # 業務邏輯
    pass
except Exception as e:
    log_error(self.logger, e, context={
        "user_id": user_id,
        "guild_id": guild_id,
        "operation": "method_name"
    })
    raise
```

### API錯誤回應

```python
from src.core.error_codes import format_error_response

try:
    # API邏輯
    pass
except Exception as e:
    return format_error_response(e, include_technical_details=DEBUG_MODE)
```

## 一致性檢查

### 自動檢查項目
1. **錯誤代碼唯一性**：確保所有錯誤代碼唯一
2. **使用者訊息完整性**：確保所有錯誤代碼都有對應的使用者訊息
3. **服務採用率**：檢查各服務是否採用標準錯誤處理
4. **日誌格式一致性**：確保日誌記錄格式統一

### 執行一致性檢查
```bash
# 執行錯誤代碼一致性檢查
python -m tests.integration.test_error_consistency
```

## 效能考量

### 最佳實踐
1. **錯誤代碼映射快取**：使用記憶體快取提升映射速度
2. **訊息格式化優化**：避免不必要的字串格式化操作  
3. **日誌記錄批次化**：在高頻場景下採用批次記錄

### 效能目標
- 錯誤代碼轉換時間：< 1ms
- 訊息格式化時間：< 0.5ms
- 對正常業務邏輯影響：< 0.1%

## 版本化策略

### 版本號命名
錯誤代碼系統遵循語意化版本規範：
- **主版本號**：不相容的API修改
- **次版本號**：向後相容的功能新增
- **修訂號**：向後相容的問題修正

### 向後相容性保證
- **3個版本週期**：廢止的錯誤代碼維持映射關係
- **逐步遷移**：提供遷移指南和工具
- **API穩定性**：核心API保持穩定

## 故障排除

### 常見問題
1. **錯誤代碼重複**：檢查 ErrorCode 枚舉是否有重複值
2. **訊息缺失**：檢查 get_user_message() 是否包含所有錯誤代碼
3. **映射失敗**：檢查 map_exception_to_error_code() 的映射邏輯
4. **一致性失敗**：執行一致性檢查腳本排查問題

### 除錯工具
- **錯誤代碼查詢工具**：`python -m tools.error_code_lookup [ERROR_CODE]`
- **一致性檢查工具**：`python -m tools.consistency_checker`
- **使用率統計工具**：`python -m tools.error_usage_stats`

## 擴展指南

### 添加新模組
1. **分配數字範圍**：在錯誤代碼對應表中分配新範圍
2. **定義錯誤代碼**：添加模組特有的錯誤代碼
3. **實作服務整合**：使用錯誤處理中介器
4. **編寫測試**：確保新模組符合一致性要求

### 整合第三方庫
1. **異常映射**：在 map_exception_to_error_code() 中添加第三方異常映射
2. **訊息本地化**：為第三方異常添加繁體中文訊息
3. **上下文提取**：提取第三方異常的有用上下文資訊

---

**版本**: 1.0  
**最後更新**: 2025-08-23  
**負責人**: T8 任務實施團隊  
**審核狀態**: 待審核