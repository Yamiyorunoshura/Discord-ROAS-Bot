# æ´»èºåº¦é¢æ¿ç³»çµ±é–‹ç™¼æç¤ºè© v1.7-1

## ğŸ¯ é–‹ç™¼ç›®æ¨™

ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„Discordæ©Ÿå™¨äººé–‹ç™¼å°ˆå®¶ï¼Œéœ€è¦æ ¹æ“šPRDæ–‡æª”å¯¦ç¾ä¸€å€‹å®Œæ•´çš„æ´»èºåº¦é¢æ¿ç³»çµ±ã€‚è«‹åš´æ ¼æŒ‰ç…§ä»¥ä¸‹è¦æ±‚é€²è¡Œé–‹ç™¼ï¼š

## ğŸ“‹ æ ¸å¿ƒéœ€æ±‚ç†è§£

### 1. é¢æ¿å¯¦ç¾å•é¡Œ
- **ç¾æ³**: æ´»èºåº¦é¢æ¿ä¸¦æœªå®Œå…¨å¯¦ç¾ï¼Œæ‰“é–‹é¢æ¿é¡¯ç¤ºé é¢mainä¸å­˜åœ¨
- **ç›®æ¨™**: å¯¦ç¾å®Œæ•´çš„æ´»èºåº¦é¢æ¿ç³»çµ±ï¼Œç¢ºä¿æ‰€æœ‰é é¢åŠŸèƒ½æ­£å¸¸é‹ä½œ

### 2. è¨­è¨ˆé€šç”¨æ€§å•é¡Œ
- **ç¾æ³**: æ´»èºåº¦é¢æ¿çš„è¨­è¨ˆéæ–¼é€šç”¨
- **ç›®æ¨™**: é‡å°æ´»èºåº¦ç³»çµ±ç‰¹æ€§å„ªåŒ–ç•Œé¢ï¼Œæä¾›å°ˆå±¬çš„æ´»èºåº¦ç®¡ç†åŠŸèƒ½

### 3. æ¬Šé™è¨­è¨ˆå•é¡Œ
- **ç¾æ³**: é¢æ¿æ¬Šé™è¨­è¨ˆä¸åˆç†
- **ç›®æ¨™**: å¯¦ç¾åˆ†å±¤æ¬Šé™ç®¡ç†ï¼Œå€åˆ†æŸ¥çœ‹æ¬Šé™å’Œæ“ä½œæ¬Šé™

## ğŸ—ï¸ æ¶æ§‹è¨­è¨ˆè¦æ±‚

### æ ¸å¿ƒçµ„ä»¶çµæ§‹
```
ActivityPanelView (ä¸»é¢æ¿æ§åˆ¶å™¨)
â”œâ”€â”€ SettingsPage (è¨­å®šé é¢)
â”œâ”€â”€ PreviewPage (é è¦½é é¢)
â”œâ”€â”€ StatsPage (çµ±è¨ˆé é¢)
â””â”€â”€ HistoryPage (æ­·å²é é¢)
```

### æ¬Šé™åˆ†å±¤æ¶æ§‹
1. **æŸ¥çœ‹æ¬Šé™**: æ‰€æœ‰ä¼ºæœå™¨æˆå“¡
2. **åŸºæœ¬æ“ä½œæ¬Šé™**: æ‰€æœ‰ä¼ºæœå™¨æˆå“¡
3. **ç®¡ç†æ¬Šé™**: æ“æœ‰ã€Œç®¡ç†ä¼ºæœå™¨ã€æ¬Šé™çš„æˆå“¡
4. **é«˜ç´šç®¡ç†æ¬Šé™**: ä¼ºæœå™¨ç®¡ç†å“¡

## ğŸ”§ æŠ€è¡“å¯¦ç¾è¦æ±‚

### 1. ä¸»é¢æ¿æ§åˆ¶å™¨ (ActivityPanelView)
```python
class ActivityPanelView(discord.ui.View):
    def __init__(self, bot: commands.Bot, guild_id: int, user_id: int):
        self.bot = bot
        self.guild_id = guild_id
        self.user_id = user_id
        self.current_page = "settings"
        self.db = ActivityDatabase()
        
    async def start(self, interaction: discord.Interaction):
        """å•Ÿå‹•é¢æ¿"""
        await self.show_page(interaction, self.current_page)
    
    async def show_page(self, interaction: discord.Interaction, page: str):
        """é¡¯ç¤ºæŒ‡å®šé é¢"""
        # å¯¦ç¾é é¢åˆ‡æ›é‚è¼¯
```

### 2. æ¬Šé™æª¢æŸ¥å™¨ (PermissionChecker)
```python
class PermissionChecker:
    @staticmethod
    def can_view(user: discord.Member) -> bool:
        """æª¢æŸ¥æŸ¥çœ‹æ¬Šé™"""
        return True  # æ‰€æœ‰äººå¯æŸ¥çœ‹
    
    @staticmethod
    def can_manage(user: discord.Member) -> bool:
        """æª¢æŸ¥ç®¡ç†æ¬Šé™"""
        return user.guild_permissions.manage_guild
    
    @staticmethod
    def can_export(user: discord.Member) -> bool:
        """æª¢æŸ¥å°å‡ºæ¬Šé™"""
        return user.guild_permissions.administrator
```

### 3. æ•¸æ“šåº«è¡¨çµæ§‹
å¿…é ˆå¯¦ç¾ä»¥ä¸‹æ•¸æ“šåº«è¡¨ï¼š
```sql
-- æ´»èºåº¦ä¸»è¡¨
CREATE TABLE meter(
  guild_id INTEGER, 
  user_id INTEGER,
  score REAL DEFAULT 0, 
  last_msg INTEGER DEFAULT 0,
  PRIMARY KEY(guild_id, user_id)
);

-- æ¯æ—¥çµ±è¨ˆè¡¨
CREATE TABLE daily(
  ymd TEXT, 
  guild_id INTEGER, 
  user_id INTEGER,
  msg_cnt INTEGER DEFAULT 0,
  PRIMARY KEY(ymd, guild_id, user_id)
);

-- æ’­å ±é »é“è¨­å®šè¡¨
CREATE TABLE report_channel(
  guild_id INTEGER PRIMARY KEY,
  channel_id INTEGER
);

-- ç³»çµ±è¨­å®šè¡¨
CREATE TABLE activity_settings(
  guild_id INTEGER PRIMARY KEY,
  activity_gain REAL DEFAULT 5.0,
  activity_decay_per_h REAL DEFAULT 2.0,
  activity_cooldown INTEGER DEFAULT 60,
  report_hour INTEGER DEFAULT 21,
  system_enabled BOOLEAN DEFAULT 1
);
```

## ğŸ“„ é é¢å¯¦ç¾è¦æ±‚

### 1. è¨­å®šé é¢ (SettingsPage)
**åŠŸèƒ½è¦æ±‚**:
- æ’­å ±é »é“è¨­å®š
- æ´»èºåº¦è¨ˆç®—åƒæ•¸èª¿æ•´
- è‡ªå‹•æ’­å ±æ™‚é–“è¨­å®š
- ç³»çµ±é–‹é—œæ§åˆ¶
- ç­‰ç´šç³»çµ±è¨­å®š
- ä¸»é¡Œé¢¨æ ¼è¨­å®š

**æ¬Šé™è¦æ±‚**:
- æŸ¥çœ‹: æ‰€æœ‰æˆå“¡
- ä¿®æ”¹: ç®¡ç†ä¼ºæœå™¨æ¬Šé™

### 2. é è¦½é é¢ (PreviewPage)
**åŠŸèƒ½è¦æ±‚**:
- å³æ™‚æ’è¡Œæ¦œé è¦½
- å€‹äººæ´»èºåº¦æŸ¥è©¢
- ä¸åŒæ™‚é–“ç¯„åœåˆ‡æ›
- è¦–è¦ºåŒ–æ•ˆæœå±•ç¤º
- ç­‰ç´šç³»çµ±å±•ç¤º

**æ¬Šé™è¦æ±‚**:
- æŸ¥çœ‹: æ‰€æœ‰æˆå“¡
- æ“ä½œ: æ‰€æœ‰æˆå“¡

### 3. çµ±è¨ˆé é¢ (StatsPage)
**åŠŸèƒ½è¦æ±‚**:
- ç³»çµ±ä½¿ç”¨çµ±è¨ˆ
- ç”¨æˆ¶æ´»èºåº¦åˆ†æ
- é »é“æ´»èºåº¦æ’è¡Œ
- æ­·å²æ•¸æ“šè¶¨å‹¢
- æ’è¡Œæ¦œçµ±è¨ˆ
- ç³»çµ±æ€§èƒ½ç›£æ§

**æ¬Šé™è¦æ±‚**:
- æŸ¥çœ‹: æ‰€æœ‰æˆå“¡
- è©³ç´°æ•¸æ“š: ç®¡ç†ä¼ºæœå™¨æ¬Šé™

### 4. æ­·å²è¨˜éŒ„é é¢ (HistoryPage)
**åŠŸèƒ½è¦æ±‚**:
- æ­·å²æ’è¡Œæ¦œè¨˜éŒ„
- ç”¨æˆ¶æ´»èºåº¦è®ŠåŒ–
- æ•¸æ“šå°å‡ºåŠŸèƒ½
- æ•¸æ“šæ¸…ç†åŠŸèƒ½
- å‚™ä»½é‚„åŸåŠŸèƒ½
- æ•¸æ“šåˆ†æå ±å‘Š

**æ¬Šé™è¦æ±‚**:
- æŸ¥çœ‹: æ‰€æœ‰æˆå“¡
- å°å‡º/ç®¡ç†: ç®¡ç†ä¼ºæœå™¨æ¬Šé™

## ğŸ¨ ç•Œé¢è¨­è¨ˆè¦æ±‚

### é¢æ¿ä½ˆå±€
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š æ´»èºåº¦ç³»çµ±ç®¡ç†é¢æ¿              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [è¨­å®š] [é è¦½] [çµ±è¨ˆ] [æ­·å²]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [é‡æ–°æ•´ç†] [è¨­å®šé »é“] [æ¸…é™¤æ•¸æ“š]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [é—œé–‰]                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¨­è¨ˆåŸå‰‡
- ä½¿ç”¨æŒ‰éˆ•å¼é é¢åˆ‡æ›
- ä¿æŒç•¶å‰é é¢ç‹€æ…‹
- æä¾›é é¢è¼‰å…¥æŒ‡ç¤ºå™¨
- éŸ¿æ‡‰å¼è¨­è¨ˆï¼Œé©é…ä¸åŒè¢å¹•å°ºå¯¸

## ğŸ” éŒ¯èª¤è™•ç†è¦æ±‚

### çµ±ä¸€éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
```python
class PanelErrorHandler:
    @staticmethod
    async def handle_database_error(interaction: discord.Interaction, error: Exception):
        """è™•ç†è³‡æ–™åº«éŒ¯èª¤"""
        logger.error(f"é¢æ¿è³‡æ–™åº«éŒ¯èª¤: {error}")
        await interaction.followup.send(
            "âŒ è³‡æ–™åº«æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦",
            ephemeral=True
        )
    
    @staticmethod
    async def handle_permission_error(interaction: discord.Interaction, required_permission: str):
        """è™•ç†æ¬Šé™éŒ¯èª¤"""
        await interaction.followup.send(
            f"âŒ éœ€è¦ã€Œ{required_permission}ã€æ¬Šé™æ‰èƒ½åŸ·è¡Œæ­¤æ“ä½œ",
            ephemeral=True
        )
```

## âš¡ æ€§èƒ½å„ªåŒ–è¦æ±‚

### ç·©å­˜æ©Ÿåˆ¶
- å¯¦ç¾æ’è¡Œæ¦œæ•¸æ“šç·©å­˜
- ç·©å­˜æ™‚é–“è¨­å®šç‚º5åˆ†é˜
- ç•°æ­¥æ•¸æ“šåŠ è¼‰

### ç•°æ­¥è™•ç†
- æ‰€æœ‰æ•¸æ“šåº«æ“ä½œå¿…é ˆç•°æ­¥
- ä½¿ç”¨asyncio.gatheré€²è¡Œä¸¦ç™¼è™•ç†
- é¿å…é˜»å¡ä¸»ç·šç¨‹

## ğŸ“Š æ•¸æ“šæ¸²æŸ“è¦æ±‚

### æ’è¡Œæ¦œæ¸²æŸ“
```python
async def render_rankings_embed(self, rankings: List[Dict], guild: discord.Guild) -> discord.Embed:
    """æ¸²æŸ“æ’è¡Œæ¦œåµŒå…¥"""
    lines = []
    for rank, data in enumerate(rankings, 1):
        user_id = data["user_id"]
        msg_cnt = data["msg_cnt"]
        member = guild.get_member(user_id)
        name = member.display_name if member else f"<@{user_id}>"
        lines.append(f"`#{rank:2}` {name:<20} â€§ {msg_cnt} å‰‡")
    
    embed = discord.Embed(
        title=f"ğŸ“ˆ æ´»èºæ’è¡Œæ¦œ - {guild.name}",
        description="\n".join(lines),
        colour=discord.Colour.green()
    )
    return embed
```

## ğŸ§ª æ¸¬è©¦è¦æ±‚

### åŠŸèƒ½æ¸¬è©¦
- é¢æ¿è¼‰å…¥æ¸¬è©¦
- é é¢åˆ‡æ›æ¸¬è©¦
- æ¬Šé™æª¢æŸ¥æ¸¬è©¦
- æ•¸æ“šé¡¯ç¤ºæ¸¬è©¦

### æ¬Šé™æ¸¬è©¦
- æ™®é€šæˆå“¡æ¬Šé™æ¸¬è©¦
- ç®¡ç†å“¡æ¬Šé™æ¸¬è©¦
- æ¬Šé™é‚Šç•Œæ¸¬è©¦

### æ€§èƒ½æ¸¬è©¦
- é¢æ¿éŸ¿æ‡‰é€Ÿåº¦æ¸¬è©¦
- æ•¸æ“šè¼‰å…¥æ€§èƒ½æ¸¬è©¦
- ä¸¦ç™¼è¨ªå•æ¸¬è©¦

## ğŸ“ ä»£ç¢¼è³ªé‡è¦æ±‚

### ä»£ç¢¼è¦ç¯„
- ä½¿ç”¨é¡å‹æç¤º (Type Hints)
- æ·»åŠ è©³ç´°çš„docstring
- éµå¾ªPEP 8ä»£ç¢¼é¢¨æ ¼
- ä½¿ç”¨é©ç•¶çš„ç•°å¸¸è™•ç†

### æ¨¡çµ„åŒ–è¨­è¨ˆ
- æ¯å€‹é é¢ç¨ç«‹æˆé¡
- ä½¿ç”¨ä¾è³´æ³¨å…¥
- é¿å…å¾ªç’°ä¾è³´
- ä¿æŒä»£ç¢¼å¯æ¸¬è©¦æ€§

## ğŸš€ å¯¦æ–½æ­¥é©Ÿ

### Phase 1: åŸºç¤æ¶æ§‹
1. å¯¦ç¾ActivityPanelViewä¸»æ§åˆ¶å™¨
2. å»ºç«‹PermissionCheckeræ¬Šé™æª¢æŸ¥å™¨
3. å¯¦ç¾åŸºç¤é é¢åˆ‡æ›åŠŸèƒ½

### Phase 2: æ ¸å¿ƒåŠŸèƒ½
1. å¯¦ç¾SettingsPageè¨­å®šé é¢
2. å¯¦ç¾PreviewPageé è¦½é é¢
3. å¯¦ç¾StatsPageçµ±è¨ˆé é¢
4. å¯¦ç¾HistoryPageæ­·å²é é¢

### Phase 3: å„ªåŒ–å®Œå–„
1. æ·»åŠ éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
2. å¯¦ç¾ç·©å­˜å„ªåŒ–
3. å®Œå–„ç•Œé¢è¨­è¨ˆ
4. æ·»åŠ æ€§èƒ½ç›£æ§

### Phase 4: æ¸¬è©¦éƒ¨ç½²
1. é€²è¡ŒåŠŸèƒ½æ¸¬è©¦
2. é€²è¡Œæ¬Šé™æ¸¬è©¦
3. é€²è¡Œæ€§èƒ½æ¸¬è©¦
4. éƒ¨ç½²ä¸Šç·š

## âœ… é©—æ”¶æ¨™æº–

### åŠŸèƒ½é©—æ”¶
- [ ] æ‰€æœ‰é é¢æ­£å¸¸è¼‰å…¥
- [ ] é é¢åˆ‡æ›æµæš¢
- [ ] æ¬Šé™æª¢æŸ¥æº–ç¢º
- [ ] æ•¸æ“šé¡¯ç¤ºæ­£ç¢º

### æ€§èƒ½é©—æ”¶
- [ ] é¢æ¿è¼‰å…¥æ™‚é–“ < 2ç§’
- [ ] é é¢åˆ‡æ›æ™‚é–“ < 1ç§’
- [ ] æ”¯æŒ100+ä¸¦ç™¼ç”¨æˆ¶

### ç”¨æˆ¶é«”é©—é©—æ”¶
- [ ] ç•Œé¢ç›´è§€æ˜“ç”¨
- [ ] éŒ¯èª¤æç¤ºæ¸…æ™°
- [ ] æ“ä½œæµç¨‹é †æš¢

## ğŸ”„ é–‹ç™¼æµç¨‹

1. **éœ€æ±‚åˆ†æ**: ä»”ç´°é–±è®€PRDæ–‡æª”ï¼Œç†è§£æ ¸å¿ƒéœ€æ±‚
2. **æ¶æ§‹è¨­è¨ˆ**: è¨­è¨ˆæ¸…æ™°çš„æ¨¡çµ„æ¶æ§‹
3. **é€æ­¥å¯¦ç¾**: æŒ‰ç…§Phaseé †åºé€æ­¥å¯¦ç¾åŠŸèƒ½
4. **æ¸¬è©¦é©—è­‰**: æ¯å€‹éšæ®µå®Œæˆå¾Œé€²è¡Œæ¸¬è©¦
5. **å„ªåŒ–å®Œå–„**: æ ¹æ“šæ¸¬è©¦çµæœé€²è¡Œå„ªåŒ–

## ğŸ“‹ é‡è¦æé†’

1. **åš´æ ¼éµå¾ªPRD**: æ‰€æœ‰åŠŸèƒ½å¿…é ˆå®Œå…¨ç¬¦åˆPRDæ–‡æª”è¦æ±‚
2. **æ¬Šé™è¨­è¨ˆ**: å¿…é ˆå¯¦ç¾åˆ†å±¤æ¬Šé™ç®¡ç†
3. **éŒ¯èª¤è™•ç†**: å¿…é ˆæœ‰å®Œå–„çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
4. **æ€§èƒ½å„ªåŒ–**: å¿…é ˆè€ƒæ…®æ€§èƒ½å•é¡Œ
5. **ä»£ç¢¼è³ªé‡**: å¿…é ˆä¿æŒé«˜ä»£ç¢¼è³ªé‡
6. **æ¸¬è©¦è¦†è“‹**: å¿…é ˆæœ‰å……åˆ†çš„æ¸¬è©¦è¦†è“‹

---

**æç¤ºè©ç‰ˆæœ¬**: v1.7-1  
**å‰µå»ºæ—¥æœŸ**: 2025-01-18  
**é©ç”¨ç¯„åœ**: æ´»èºåº¦é¢æ¿ç³»çµ±é–‹ç™¼  
**é–‹ç™¼ç›®æ¨™**: å¯¦ç¾å®Œæ•´ã€ç©©å®šã€æ˜“ç”¨çš„æ´»èºåº¦é¢æ¿ç³»çµ±
