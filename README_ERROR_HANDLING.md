# Discord ADR Bot v1.5 - 錯誤處理指南

## 📋 目錄
- [錯誤分類](#錯誤分類)
- [常見錯誤](#常見錯誤)
- [故障排除](#故障排除)
- [日誌分析](#日誌分析)
- [錯誤代碼](#錯誤代碼)
- [聯絡支援](#聯絡支援)

## 🔍 錯誤分類

### 1. 啟動錯誤 (STARTUP_ERROR)
- **描述**：機器人啟動時發生的錯誤
- **嚴重程度**：高
- **影響**：機器人無法正常啟動
- **常見原因**：Token 錯誤、依賴缺失、權限不足

### 2. 資料庫錯誤 (DATABASE_ERROR)
- **描述**：資料庫操作相關錯誤
- **嚴重程度**：中-高
- **影響**：功能無法正常運作
- **常見原因**：檔案權限、磁碟空間、連線問題

### 3. 網路錯誤 (NETWORK_ERROR)
- **描述**：網路連線相關錯誤
- **嚴重程度**：中
- **影響**：部分功能暫時無法使用
- **常見原因**：網路中斷、API 限制、超時

### 4. 權限錯誤 (PERMISSION_ERROR)
- **描述**：權限不足相關錯誤
- **嚴重程度**：中
- **影響**：特定功能無法使用
- **常見原因**：角色權限、機器人權限、頻道權限

### 5. 配置錯誤 (CONFIG_ERROR)
- **描述**：配置檔案相關錯誤
- **嚴重程度**：中
- **影響**：功能行為異常
- **常見原因**：設定錯誤、檔案損壞、格式問題

## 🚨 常見錯誤

### 啟動錯誤

#### 錯誤 1: Token 無效
```
[ERROR] 無效的 Discord Token: TRACKING_ID-001
```
**解決方案**：
1. 檢查 `.env` 檔案中的 `DISCORD_TOKEN`
2. 確認 Token 格式正確
3. 重新生成 Bot Token

#### 錯誤 2: 依賴缺失
```
[ERROR] 缺少必要依賴: discord.py - TRACKING_ID-002
```
**解決方案**：
```bash
pip install -r requirement.txt
```

#### 錯誤 3: Python 版本不符
```
[ERROR] Python 版本不符，需要 3.8+ - TRACKING_ID-003
```
**解決方案**：
1. 升級 Python 到 3.8 或更高版本
2. 確認使用正確的 Python 環境

### 資料庫錯誤

#### 錯誤 1: 資料庫檔案權限錯誤
```
[DATABASE_ERROR] 無法存取資料庫檔案: TRACKING_ID-101
```
**解決方案**：
1. 檢查 `dbs/` 目錄權限
2. 確認檔案擁有者
3. 重新建立資料庫檔案

#### 錯誤 2: 資料庫連線失敗
```
[DATABASE_ERROR] 資料庫連線失敗: TRACKING_ID-102
```
**解決方案**：
1. 檢查磁碟空間
2. 確認 SQLite 支援
3. 重新啟動機器人

#### 錯誤 3: 資料庫查詢錯誤
```
[DATABASE_ERROR] 查詢執行失敗: TRACKING_ID-103
```
**解決方案**：
1. 檢查資料庫結構
2. 備份並重建資料庫
3. 檢查 SQL 語法

### 網路錯誤

#### 錯誤 1: Discord API 連線失敗
```
[NETWORK_ERROR] Discord API 連線失敗: TRACKING_ID-201
```
**解決方案**：
1. 檢查網路連線
2. 確認 Discord 服務狀態
3. 等待重試

#### 錯誤 2: Webhook 發送失敗
```
[NETWORK_ERROR] Webhook 發送失敗: TRACKING_ID-202
```
**解決方案**：
1. 檢查 Webhook URL 有效性
2. 確認頻道權限
3. 檢查訊息內容

#### 錯誤 3: 圖片下載失敗
```
[NETWORK_ERROR] 圖片下載失敗: TRACKING_ID-203
```
**解決方案**：
1. 檢查圖片 URL 有效性
2. 確認網路連線
3. 檢查檔案大小限制

### 權限錯誤

#### 錯誤 1: 機器人權限不足
```
[PERMISSION_ERROR] 機器人權限不足: TRACKING_ID-301
```
**解決方案**：
1. 檢查機器人角色權限
2. 確認頻道權限設定
3. 重新邀請機器人

#### 錯誤 2: 用戶權限不足
```
[PERMISSION_ERROR] 用戶權限不足: TRACKING_ID-302
```
**解決方案**：
1. 檢查用戶角色
2. 確認 `config.py` 權限設定
3. 調整權限配置

#### 錯誤 3: 頻道權限錯誤
```
[PERMISSION_ERROR] 頻道權限錯誤: TRACKING_ID-303
```
**解決方案**：
1. 檢查頻道權限設定
2. 確認機器人角色
3. 調整頻道權限

### 配置錯誤

#### 錯誤 1: 配置檔案格式錯誤
```
[CONFIG_ERROR] 配置檔案格式錯誤: TRACKING_ID-401
```
**解決方案**：
1. 檢查 `config.py` 語法
2. 確認變數定義
3. 重新設定配置

#### 錯誤 2: 環境變數缺失
```
[CONFIG_ERROR] 環境變數缺失: TRACKING_ID-402
```
**解決方案**：
1. 檢查 `.env` 檔案
2. 確認變數名稱
3. 重新設定環境變數

#### 錯誤 3: 路徑設定錯誤
```
[CONFIG_ERROR] 路徑設定錯誤: TRACKING_ID-403
```
**解決方案**：
1. 檢查路徑是否存在
2. 確認路徑格式
3. 建立必要目錄

## 🔧 故障排除

### 基本檢查清單

1. **環境檢查**
   - Python 版本 (3.8+)
   - 依賴套件完整性
   - 虛擬環境啟用

2. **配置檢查**
   - `.env` 檔案存在且格式正確
   - `config.py` 設定正確
   - 路徑設定有效

3. **權限檢查**
   - 檔案讀寫權限
   - 目錄存取權限
   - 網路連線權限

4. **資源檢查**
   - 磁碟空間充足
   - 記憶體使用正常
   - CPU 使用率正常

### 進階故障排除

#### 日誌分析
```bash
# 查看主要錯誤日誌
tail -f logs/main_error.log

# 查看特定模組日誌
tail -f logs/activity_meter.log
tail -f logs/database.log
tail -f logs/message_listener.log
```

#### 資料庫修復
```python
# 備份資料庫
import shutil
shutil.copy2('dbs/activity.db', 'dbs/activity_backup.db')

# 重建資料庫
import os
os.remove('dbs/activity.db')
# 重新啟動機器人
```

#### 配置重置
```python
# 重置配置到預設值
# 編輯 config.py 或重新複製備份
```

### 效能問題

#### 記憶體使用過高
**症狀**：
- 機器人響應緩慢
- 記憶體使用率持續上升
- 系統變得不穩定

**解決方案**：
1. 檢查圖片快取設定
2. 調整批次處理大小
3. 定期重啟機器人

#### 資料庫查詢緩慢
**症狀**：
- 指令響應延遲
- 資料庫檔案過大
- 查詢時間過長

**解決方案**：
1. 優化資料庫索引
2. 清理舊資料
3. 分割大型資料表

#### 網路延遲
**症狀**：
- API 呼叫超時
- 圖片載入緩慢
- Webhook 發送失敗

**解決方案**：
1. 檢查網路連線
2. 調整超時設定
3. 使用 CDN 加速

## 📊 日誌分析

### 日誌格式
```
[時間戳] [等級] [模組] [追蹤ID] 訊息內容
```

### 日誌等級
- **DEBUG**: 詳細除錯資訊
- **INFO**: 一般資訊
- **WARNING**: 警告訊息
- **ERROR**: 錯誤訊息
- **CRITICAL**: 嚴重錯誤

### 日誌檔案位置
- `logs/main_error.log` - 主要錯誤日誌
- `logs/activity_meter.log` - 活躍度系統日誌
- `logs/database.log` - 資料庫操作日誌
- `logs/message_listener.log` - 訊息監控日誌
- `logs/welcome.log` - 歡迎系統日誌
- `logs/protection.log` - 群組保護日誌
- `logs/sync_data.log` - 資料同步日誌

### 日誌分析工具
```bash
# 搜尋特定錯誤
grep "TRACKING_ID-001" logs/*.log

# 統計錯誤數量
grep -c "ERROR" logs/main_error.log

# 查看最近錯誤
tail -n 100 logs/main_error.log | grep "ERROR"
```

## 🔢 錯誤代碼

### 追蹤 ID 格式
```
TRACKING_ID-XXX
```
- **XXX**: 三位數字，按模組分類

### 錯誤代碼分類
- **001-099**: 啟動錯誤
- **101-199**: 資料庫錯誤
- **201-299**: 網路錯誤
- **301-399**: 權限錯誤
- **401-499**: 配置錯誤
- **501-599**: 模組特定錯誤

### 常見錯誤代碼
- `TRACKING_ID-001`: Token 無效
- `TRACKING_ID-002`: 依賴缺失
- `TRACKING_ID-003`: Python 版本不符
- `TRACKING_ID-101`: 資料庫檔案權限錯誤
- `TRACKING_ID-102`: 資料庫連線失敗
- `TRACKING_ID-201`: Discord API 連線失敗
- `TRACKING_ID-301`: 機器人權限不足
- `TRACKING_ID-401`: 配置檔案格式錯誤

## 📞 聯絡支援

### 提交問題前檢查
1. 確認錯誤代碼
2. 收集相關日誌
3. 記錄操作步驟
4. 檢查環境資訊

### 問題報告格式
```
**錯誤代碼**: TRACKING_ID-XXX
**錯誤描述**: 簡潔描述問題
**重現步驟**: 詳細的操作步驟
**預期行為**: 期望的正常行為
**實際行為**: 實際發生的行為
**環境資訊**: Python版本、作業系統等
**相關日誌**: 錯誤日誌內容
```

### 聯絡方式
- **GitHub Issues**: 提交問題報告
- **Discord**: 加入支援伺服器
- **Email**: 發送詳細報告

### 支援時間
- **工作日**: 9:00-18:00 (UTC+8)
- **週末**: 10:00-16:00 (UTC+8)
- **緊急問題**: 24/7 支援

---

**注意事項**：
- 提交問題前請先查看本指南
- 提供完整的錯誤資訊
- 包含相關的日誌檔案
- 描述清楚的重現步驟

**快速修復**：
- 大部分問題可通過重啟機器人解決
- 檢查配置檔案設定
- 確認網路連線正常
- 驗證權限設定正確