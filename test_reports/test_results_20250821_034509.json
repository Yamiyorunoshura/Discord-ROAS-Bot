{
  "cross_system_tests": {
    "test_type": "cross_system_tests",
    "success": false,
    "duration_seconds": 0.3529651165008545,
    "return_code": 1,
    "tests_run": 0,
    "tests_passed": 0,
    "tests_failed": 0,
    "tests_skipped": 0,
    "coverage_data": null,
    "stdout": "============================= test session starts ==============================\nplatform darwin -- Python 3.10.18, pytest-8.4.1, pluggy-1.6.0 -- /Users/tszkinlai/Deploy/Discord ADR bot latest.ver/venv/bin/python\ncachedir: .pytest_cache\nrootdir: /Users/tszkinlai/Coding/roas-bot\nconfigfile: pyproject.toml\nplugins: anyio-4.9.0, asyncio-1.1.0, cov-6.2.1, mock-3.14.1\nasyncio: mode=auto, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function\ncollecting ... collected 7 items\n\ntests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_achievement_economy_integration FAILED [ 14%]\ntests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_government_economy_integration FAILED [ 28%]\ntests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_role_management_integration FAILED [ 42%]\ntests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_data_consistency_across_systems <- tests/test_infrastructure.py FAILED [ 57%]\ntests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_cross_system_performance <- tests/test_infrastructure.py FAILED [ 71%]\ntests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_concurrent_cross_system_operations FAILED [ 85%]\ntests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_transaction_atomicity FAILED [100%]\n\n=================================== FAILURES ===================================\n_______ TestCrossSystemIntegration.test_achievement_economy_integration ________\nservices/achievement/achievement_service.py:361: in create_achievement\n    achievement.validate()\nE   AttributeError: 'dict' object has no attribute 'validate'\n\nDuring handling of the above exception, another exception occurred:\ntests/integration/test_cross_system_integration.py:63: in test_achievement_economy_integration\n    await achievement_service.create_achievement(achievement_data)\ncore/exceptions.py:312: in async_wrapper\n    return await func(*args, **kwargs)\nservices/achievement/achievement_service.py:416: in create_achievement\n    raise ServiceError(\nE   core.exceptions.ServiceError: 建立成就失敗：'dict' object has no attribute 'validate'\n---------------------------- Captured stdout setup -----------------------------\n載入服務 activity 失敗：ActivityService.__init__() missing 1 required positional argument: 'database_manager'\n載入服務 welcome 失敗：WelcomeService.__init__() missing 1 required positional argument: 'database_manager'\n載入服務 message 失敗：MessageService.__init__() missing 1 required positional argument: 'database_manager'\n------------------------------ Captured log setup ------------------------------\nINFO     core.database_manager:database_manager.py:223 應用遷移 001: 建立基礎表格\nINFO     core.database_manager:database_manager.py:238 遷移 001 應用成功\nINFO     core.database_manager:database_manager.py:377 資料庫管理器初始化完成\nWARNING  service.AchievementService:achievement_service.py:77 經濟服務依賴不可用，貨幣獎勵功能將受限\nWARNING  service.AchievementService:achievement_service.py:82 身分組服務依賴不可用，身分組獎勵功能將受限\nINFO     core.database_manager:database_manager.py:223 應用遷移 004_achievement_system: 建立成就系統核心表格和索引\nERROR    core.database_manager:database_manager.py:484 執行 SQL 指令失敗：incomplete input\n指令內容：CREATE TABLE IF NOT EXISTS achievements ( id TEXT PRIMARY KEY,                    -- 成就唯一ID name TEXT NOT NULL,                     -- 成就名稱 description TEXT NOT NULL,              -- 成就描述 achievement_type TEXT NOT NULL,         -- 成就類型 (milestone, recurring, hidden, progressive) guild_id INTEGER NOT NULL,              -- 所屬伺服器ID trigger_conditions TEXT NOT NULL,       -- 觸發條件JSON rewards TEXT NOT NULL,                  -- 獎勵配置JSON status TEXT NOT NULL DEFAULT 'active',  -- 成就狀態 (active, disabled, archived) metadata TEXT,                          -- 額外配置資料JSON created_at TIMESTAMP NOT NULL,          -- 建立時間 updated_at TIMESTAMP NOT NULL,          -- 更新時間 CONSTRAINT achievements_type_check CHECK (achievement_type IN ('milestone', 'recurring', 'hidden', 'progressive')), CONSTRAINT achievements_status_check CHECK (status IN ('active', 'disabled', 'archived')) )\n參數：()\nERROR    core.exceptions:exceptions.py:315 BotError in execute: {'type': 'DatabaseQueryError', 'message': '資料庫查詢失敗：incomplete input', 'severity': 'medium', 'category': 'database', 'user_message': '資料庫暫時無法使用，請稍後再試。', 'details': {'operation': 'query', 'table': None, 'query': \"CREATE TABLE IF NOT EXISTS achievements ( id TEXT PRIMARY KEY,                    -- 成就唯一ID name TEXT NOT NULL,                     -- 成就名稱 description TEXT NOT NULL,              -- 成就描述 achievement_type TEXT NOT NULL,         -- 成就類型 (milestone, recurring, hidden, progressive) guild_id INTEGER NOT NULL,              -- 所屬伺服器ID trigger_conditions TEXT NOT NULL,       -- 觸發條件JSON rewards TEXT NOT NULL,                  -- 獎勵配置JSON status TEXT NOT NULL DEFAULT 'active',  -- 成就狀態 (active, disabled, archived) metadata TEXT,                          -- 額外配置資料JSON created_at TIMESTAMP NOT NULL,          -- 建立時間 updated_at TIMESTAMP NOT NULL,          -- 更新時間 CONSTRAINT achievements_type_check CHECK (achievement_type IN ('milestone', 'recurring', 'hidden', 'progressive')), CONSTRAINT achievements_status_check CHECK (status IN ('active', 'disabled', 'archived')) )\", 'error': 'incomplete input'}, 'recoverable': True}\nERROR    core.database_manager:database_manager.py:243 應用遷移時發生錯誤：資料庫查詢失敗：incomplete input\nERROR    service.AchievementService:achievement_service.py:90 成就系統遷移應用失敗\nERROR    service.AchievementService:base_service.py:378 服務 AchievementService 初始化失敗\nINFO     core.database_manager:database_manager.py:223 應用遷移 002_economy_system: 建立經濟系統核心表格和索引\nERROR    core.database_manager:database_manager.py:484 執行 SQL 指令失敗：incomplete input\n指令內容：CREATE TABLE IF NOT EXISTS economy_accounts ( id TEXT PRIMARY KEY,                    -- 帳戶ID，格式：user_{user_id}_{guild_id} 或 gov_{type}_{guild_id} account_type TEXT NOT NULL,             -- 帳戶類型：user, government_council, government_department guild_id INTEGER NOT NULL,              -- Discord伺服器ID user_id INTEGER,                        -- 使用者ID（僅用於user類型帳戶） balance REAL NOT NULL DEFAULT 0.0,      -- 帳戶餘額 created_at TEXT NOT NULL,               -- 建立時間 (ISO 8601格式) updated_at TEXT NOT NULL,               -- 最後更新時間 (ISO 8601格式) is_active INTEGER NOT NULL DEFAULT 1,   -- 帳戶是否啟用 (0=停用, 1=啟用) metadata TEXT,                          -- 額外資料 (JSON格式) CHECK (account_type IN ('user', 'government_council', 'government_department')), CHECK (balance >= 0.0), CHECK (is_active IN (0, 1)), CHECK ( (account_type = 'user' AND user_id IS NOT NULL) OR (account_type IN ('government_council', 'government_department') AND user_id IS NULL) ) )\n參數：()\nERROR    core.exceptions:exceptions.py:315 BotError in execute: {'type': 'DatabaseQueryError', 'message': '資料庫查詢失敗：incomplete input', 'severity': 'medium', 'category': 'database', 'user_message': '資料庫暫時無法使用，請稍後再試。', 'details': {'operation': 'query', 'table': None, 'query': \"CREATE TABLE IF NOT EXISTS economy_accounts ( id TEXT PRIMARY KEY,                    -- 帳戶ID，格式：user_{user_id}_{guild_id} 或 gov_{type}_{guild_id} account_type TEXT NOT NULL,             -- 帳戶類型：user, government_council, government_department guild_id INTEGER NOT NULL,              -- Discord伺服器ID user_id INTEGER,                        -- 使用者ID（僅用於user類型帳戶） balance REAL NOT NULL DEFAULT 0.0,      -- 帳戶餘額 created_at TEXT NOT NULL,               -- 建立時間 (ISO 8601格式) updated_at TEXT NOT NULL,               -- 最後更新時間 (ISO 8601格式) is_active INTEGER NOT NULL DEFAULT 1,   -- 帳戶是否啟用 (0=停用, 1=啟用) metadata TEXT,                          -- 額外資料 (JSON格式) CHECK (account_type IN ('user', 'government_council', 'government_department')), CHECK (balance >= 0.0), CHECK (is_active IN (0, 1)), CHECK ( (account_type = 'user' AND user_id IS NOT NULL) OR (account_type IN ('government_council', 'government_department') AND user_id IS NULL) ) )\", 'error': 'incomplete input'}, 'recoverable': True}\nERROR    core.database_manager:database_manager.py:243 應用遷移時發生錯誤：資料庫查詢失敗：incomplete input\nERROR    service.EconomyService:economy_service.py:57 經濟系統遷移應用失敗\nERROR    service.EconomyService:base_service.py:378 服務 EconomyService 初始化失敗\nERROR    service.GovernmentService:government_service.py:66 身分組服務依賴不可用\nERROR    service.GovernmentService:base_service.py:378 服務 GovernmentService 初始化失敗\n------------------------------ Captured log call -------------------------------\nERROR    core.exceptions:exceptions.py:315 BotError in create_achievement: {'type': 'ServiceError', 'message': \"建立成就失敗：'dict' object has no attribute 'validate'\", 'severity': 'medium', 'category': 'business', 'user_message': '服務 AchievementService 暫時無法使用，請稍後再試。', 'details': {'service_name': 'AchievementService', 'operation': 'create_achievement'}, 'recoverable': True}\n---------------------------- Captured log teardown -----------------------------\nINFO     core.database_manager:database_manager.py:399 資料庫管理器已清理\n________ TestCrossSystemIntegration.test_government_economy_integration ________\ncore/exceptions.py:312: in async_wrapper\n    return await func(*args, **kwargs)\nE   TypeError: GovernmentService.create_department() got an unexpected keyword argument 'guild_id'\n\nDuring handling of the above exception, another exception occurred:\ntests/integration/test_cross_system_integration.py:126: in test_government_economy_integration\n    dept_result = await government_service.create_department(\ncore/exceptions.py:344: in async_wrapper\n    raise bot_error\nE   core.exceptions.BotError: Unexpected error in create_department: GovernmentService.create_department() got an unexpected keyword argument 'guild_id'\n---------------------------- Captured stdout setup -----------------------------\n載入服務 activity 失敗：ActivityService.__init__() missing 1 required positional argument: 'database_manager'\n載入服務 welcome 失敗：WelcomeService.__init__() missing 1 required positional argument: 'database_manager'\n載入服務 message 失敗：MessageService.__init__() missing 1 required positional argument: 'database_manager'\n------------------------------ Captured log setup ------------------------------\nINFO     core.database_manager:database_manager.py:223 應用遷移 001: 建立基礎表格\nINFO     core.database_manager:database_manager.py:238 遷移 001 應用成功\nINFO     core.database_manager:database_manager.py:377 資料庫管理器初始化完成\nWARNING  service.AchievementService:achievement_service.py:77 經濟服務依賴不可用，貨幣獎勵功能將受限\nWARNING  service.AchievementService:achievement_service.py:82 身分組服務依賴不可用，身分組獎勵功能將受限\nINFO     core.database_manager:database_manager.py:223 應用遷移 004_achievement_system: 建立成就系統核心表格和索引\nERROR    core.database_manager:database_manager.py:484 執行 SQL 指令失敗：incomplete input\n指令內容：CREATE TABLE IF NOT EXISTS achievements ( id TEXT PRIMARY KEY,                    -- 成就唯一ID name TEXT NOT NULL,                     -- 成就名稱 description TEXT NOT NULL,              -- 成就描述 achievement_type TEXT NOT NULL,         -- 成就類型 (milestone, recurring, hidden, progressive) guild_id INTEGER NOT NULL,              -- 所屬伺服器ID trigger_conditions TEXT NOT NULL,       -- 觸發條件JSON rewards TEXT NOT NULL,                  -- 獎勵配置JSON status TEXT NOT NULL DEFAULT 'active',  -- 成就狀態 (active, disabled, archived) metadata TEXT,                          -- 額外配置資料JSON created_at TIMESTAMP NOT NULL,          -- 建立時間 updated_at TIMESTAMP NOT NULL,          -- 更新時間 CONSTRAINT achievements_type_check CHECK (achievement_type IN ('milestone', 'recurring', 'hidden', 'progressive')), CONSTRAINT achievements_status_check CHECK (status IN ('active', 'disabled', 'archived')) )\n參數：()\nERROR    core.exceptions:exceptions.py:315 BotError in execute: {'type': 'DatabaseQueryError', 'message': '資料庫查詢失敗：incomplete input', 'severity': 'medium', 'category': 'database', 'user_message': '資料庫暫時無法使用，請稍後再試。', 'details': {'operation': 'query', 'table': None, 'query': \"CREATE TABLE IF NOT EXISTS achievements ( id TEXT PRIMARY KEY,                    -- 成就唯一ID name TEXT NOT NULL,                     -- 成就名稱 description TEXT NOT NULL,              -- 成就描述 achievement_type TEXT NOT NULL,         -- 成就類型 (milestone, recurring, hidden, progressive) guild_id INTEGER NOT NULL,              -- 所屬伺服器ID trigger_conditions TEXT NOT NULL,       -- 觸發條件JSON rewards TEXT NOT NULL,                  -- 獎勵配置JSON status TEXT NOT NULL DEFAULT 'active',  -- 成就狀態 (active, disabled, archived) metadata TEXT,                          -- 額外配置資料JSON created_at TIMESTAMP NOT NULL,          -- 建立時間 updated_at TIMESTAMP NOT NULL,          -- 更新時間 CONSTRAINT achievements_type_check CHECK (achievement_type IN ('milestone', 'recurring', 'hidden', 'progressive')), CONSTRAINT achievements_status_check CHECK (status IN ('active', 'disabled', 'archived')) )\", 'error': 'incomplete input'}, 'recoverable': True}\nERROR    core.database_manager:database_manager.py:243 應用遷移時發生錯誤：資料庫查詢失敗：incomplete input\nERROR    service.AchievementService:achievement_service.py:90 成就系統遷移應用失敗\nERROR    service.AchievementService:base_service.py:378 服務 AchievementService 初始化失敗\nINFO     core.database_manager:database_manager.py:223 應用遷移 002_economy_system: 建立經濟系統核心表格和索引\nERROR    core.database_manager:database_manager.py:484 執行 SQL 指令失敗：incomplete input\n指令內容：CREATE TABLE IF NOT EXISTS economy_accounts ( id TEXT PRIMARY KEY,                    -- 帳戶ID，格式：user_{user_id}_{guild_id} 或 gov_{type}_{guild_id} account_type TEXT NOT NULL,             -- 帳戶類型：user, government_council, government_department guild_id INTEGER NOT NULL,              -- Discord伺服器ID user_id INTEGER,                        -- 使用者ID（僅用於user類型帳戶） balance REAL NOT NULL DEFAULT 0.0,      -- 帳戶餘額 created_at TEXT NOT NULL,               -- 建立時間 (ISO 8601格式) updated_at TEXT NOT NULL,               -- 最後更新時間 (ISO 8601格式) is_active INTEGER NOT NULL DEFAULT 1,   -- 帳戶是否啟用 (0=停用, 1=啟用) metadata TEXT,                          -- 額外資料 (JSON格式) CHECK (account_type IN ('user', 'government_council', 'government_department')), CHECK (balance >= 0.0), CHECK (is_active IN (0, 1)), CHECK ( (account_type = 'user' AND user_id IS NOT NULL) OR (account_type IN ('government_council', 'government_department') AND user_id IS NULL) ) )\n參數：()\nERROR    core.exceptions:exceptions.py:315 BotError in execute: {'type': 'DatabaseQueryError', 'message': '資料庫查詢失敗：incomplete input', 'severity': 'medium', 'category': 'database', 'user_message': '資料庫暫時無法使用，請稍後再試。', 'details': {'operation': 'query', 'table': None, 'query': \"CREATE TABLE IF NOT EXISTS economy_accounts ( id TEXT PRIMARY KEY,                    -- 帳戶ID，格式：user_{user_id}_{guild_id} 或 gov_{type}_{guild_id} account_type TEXT NOT NULL,             -- 帳戶類型：user, government_council, government_department guild_id INTEGER NOT NULL,              -- Discord伺服器ID user_id INTEGER,                        -- 使用者ID（僅用於user類型帳戶） balance REAL NOT NULL DEFAULT 0.0,      -- 帳戶餘額 created_at TEXT NOT NULL,               -- 建立時間 (ISO 8601格式) updated_at TEXT NOT NULL,               -- 最後更新時間 (ISO 8601格式) is_active INTEGER NOT NULL DEFAULT 1,   -- 帳戶是否啟用 (0=停用, 1=啟用) metadata TEXT,                          -- 額外資料 (JSON格式) CHECK (account_type IN ('user', 'government_council', 'government_department')), CHECK (balance >= 0.0), CHECK (is_active IN (0, 1)), CHECK ( (account_type = 'user' AND user_id IS NOT NULL) OR (account_type IN ('government_council', 'government_department') AND user_id IS NULL) ) )\", 'error': 'incomplete input'}, 'recoverable': True}\nERROR    core.database_manager:database_manager.py:243 應用遷移時發生錯誤：資料庫查詢失敗：incomplete input\nERROR    service.EconomyService:economy_service.py:57 經濟系統遷移應用失敗\nERROR    service.EconomyService:base_service.py:378 服務 EconomyService 初始化失敗\nERROR    service.GovernmentService:government_service.py:66 身分組服務依賴不可用\nERROR    service.GovernmentService:base_service.py:378 服務 GovernmentService 初始化失敗\n------------------------------ Captured log call -------------------------------\nERROR    core.exceptions:exceptions.py:326 Unexpected error in create_department: GovernmentService.create_department() got an unexpected keyword argument 'guild_id'\nTraceback (most recent call last):\n  File \"/Users/tszkinlai/Coding/roas-bot/core/exceptions.py\", line 312, in async_wrapper\n    return await func(*args, **kwargs)\nTypeError: GovernmentService.create_department() got an unexpected keyword argument 'guild_id'\n---------------------------- Captured log teardown -----------------------------\nINFO     core.database_manager:database_manager.py:399 資料庫管理器已清理\n_________ TestCrossSystemIntegration.test_role_management_integration __________\ncore/exceptions.py:312: in async_wrapper\n    return await func(*args, **kwargs)\nE   TypeError: GovernmentService.create_department() got an unexpected keyword argument 'guild_id'\n\nDuring handling of the above exception, another exception occurred:\ntests/integration/test_cross_system_integration.py:197: in test_role_management_integration\n    dept_result = await government_service.create_department(\ncore/exceptions.py:344: in async_wrapper\n    raise bot_error\nE   core.exceptions.BotError: Unexpected error in create_department: GovernmentService.create_department() got an unexpected keyword argument 'guild_id'\n---------------------------- Captured stdout setup -----------------------------\n載入服務 activity 失敗：ActivityService.__init__() missing 1 required positional argument: 'database_manager'\n載入服務 welcome 失敗：WelcomeService.__init__() missing 1 required positional argument: 'database_manager'\n載入服務 message 失敗：MessageService.__init__() missing 1 required positional argument: 'database_manager'\n------------------------------ Captured log setup ------------------------------\nINFO     core.database_manager:database_manager.py:223 應用遷移 001: 建立基礎表格\nINFO     core.database_manager:database_manager.py:238 遷移 001 應用成功\nINFO     core.database_manager:database_manager.py:377 資料庫管理器初始化完成\nWARNING  service.AchievementService:achievement_service.py:77 經濟服務依賴不可用，貨幣獎勵功能將受限\nWARNING  service.AchievementService:achievement_service.py:82 身分組服務依賴不可用，身分組獎勵功能將受限\nINFO     core.database_manager:database_manager.py:223 應用遷移 004_achievement_system: 建立成就系統核心表格和索引\nERROR    core.database_manager:database_manager.py:484 執行 SQL 指令失敗：incomplete input\n指令內容：CREATE TABLE IF NOT EXISTS achievements ( id TEXT PRIMARY KEY,                    -- 成就唯一ID name TEXT NOT NULL,                     -- 成就名稱 description TEXT NOT NULL,              -- 成就描述 achievement_type TEXT NOT NULL,         -- 成就類型 (milestone, recurring, hidden, progressive) guild_id INTEGER NOT NULL,              -- 所屬伺服器ID trigger_conditions TEXT NOT NULL,       -- 觸發條件JSON rewards TEXT NOT NULL,                  -- 獎勵配置JSON status TEXT NOT NULL DEFAULT 'active',  -- 成就狀態 (active, disabled, archived) metadata TEXT,                          -- 額外配置資料JSON created_at TIMESTAMP NOT NULL,          -- 建立時間 updated_at TIMESTAMP NOT NULL,          -- 更新時間 CONSTRAINT achievements_type_check CHECK (achievement_type IN ('milestone', 'recurring', 'hidden', 'progressive')), CONSTRAINT achievements_status_check CHECK (status IN ('active', 'disabled', 'archived')) )\n參數：()\nERROR    core.exceptions:exceptions.py:315 BotError in execute: {'type': 'DatabaseQueryError', 'message': '資料庫查詢失敗：incomplete input', 'severity': 'medium', 'category': 'database', 'user_message': '資料庫暫時無法使用，請稍後再試。', 'details': {'operation': 'query', 'table': None, 'query': \"CREATE TABLE IF NOT EXISTS achievements ( id TEXT PRIMARY KEY,                    -- 成就唯一ID name TEXT NOT NULL,                     -- 成就名稱 description TEXT NOT NULL,              -- 成就描述 achievement_type TEXT NOT NULL,         -- 成就類型 (milestone, recurring, hidden, progressive) guild_id INTEGER NOT NULL,              -- 所屬伺服器ID trigger_conditions TEXT NOT NULL,       -- 觸發條件JSON rewards TEXT NOT NULL,                  -- 獎勵配置JSON status TEXT NOT NULL DEFAULT 'active',  -- 成就狀態 (active, disabled, archived) metadata TEXT,                          -- 額外配置資料JSON created_at TIMESTAMP NOT NULL,          -- 建立時間 updated_at TIMESTAMP NOT NULL,          -- 更新時間 CONSTRAINT achievements_type_check CHECK (achievement_type IN ('milestone', 'recurring', 'hidden', 'progressive')), CONSTRAINT achievements_status_check CHECK (status IN ('active', 'disabled', 'archived')) )\", 'error': 'incomplete input'}, 'recoverable': True}\nERROR    core.database_manager:database_manager.py:243 應用遷移時發生錯誤：資料庫查詢失敗：incomplete input\nERROR    service.AchievementService:achievement_service.py:90 成就系統遷移應用失敗\nERROR    service.AchievementService:base_service.py:378 服務 AchievementService 初始化失敗\nINFO     core.database_manager:database_manager.py:223 應用遷移 002_economy_system: 建立經濟系統核心表格和索引\nERROR    core.database_manager:database_manager.py:484 執行 SQL 指令失敗：incomplete input\n指令內容：CREATE TABLE IF NOT EXISTS economy_accounts ( id TEXT PRIMARY KEY,                    -- 帳戶ID，格式：user_{user_id}_{guild_id} 或 gov_{type}_{guild_id} account_type TEXT NOT NULL,             -- 帳戶類型：user, government_council, government_department guild_id INTEGER NOT NULL,              -- Discord伺服器ID user_id INTEGER,                        -- 使用者ID（僅用於user類型帳戶） balance REAL NOT NULL DEFAULT 0.0,      -- 帳戶餘額 created_at TEXT NOT NULL,               -- 建立時間 (ISO 8601格式) updated_at TEXT NOT NULL,               -- 最後更新時間 (ISO 8601格式) is_active INTEGER NOT NULL DEFAULT 1,   -- 帳戶是否啟用 (0=停用, 1=啟用) metadata TEXT,                          -- 額外資料 (JSON格式) CHECK (account_type IN ('user', 'government_council', 'government_department')), CHECK (balance >= 0.0), CHECK (is_active IN (0, 1)), CHECK ( (account_type = 'user' AND user_id IS NOT NULL) OR (account_type IN ('government_council', 'government_department') AND user_id IS NULL) ) )\n參數：()\nERROR    core.exceptions:exceptions.py:315 BotError in execute: {'type': 'DatabaseQueryError', 'message': '資料庫查詢失敗：incomplete input', 'severity': 'medium', 'category': 'database', 'user_message': '資料庫暫時無法使用，請稍後再試。', 'details': {'operation': 'query', 'table': None, 'query': \"CREATE TABLE IF NOT EXISTS economy_accounts ( id TEXT PRIMARY KEY,                    -- 帳戶ID，格式：user_{user_id}_{guild_id} 或 gov_{type}_{guild_id} account_type TEXT NOT NULL,             -- 帳戶類型：user, government_council, government_department guild_id INTEGER NOT NULL,              -- Discord伺服器ID user_id INTEGER,                        -- 使用者ID（僅用於user類型帳戶） balance REAL NOT NULL DEFAULT 0.0,      -- 帳戶餘額 created_at TEXT NOT NULL,               -- 建立時間 (ISO 8601格式) updated_at TEXT NOT NULL,               -- 最後更新時間 (ISO 8601格式) is_active INTEGER NOT NULL DEFAULT 1,   -- 帳戶是否啟用 (0=停用, 1=啟用) metadata TEXT,                          -- 額外資料 (JSON格式) CHECK (account_type IN ('user', 'government_council', 'government_department')), CHECK (balance >= 0.0), CHECK (is_active IN (0, 1)), CHECK ( (account_type = 'user' AND user_id IS NOT NULL) OR (account_type IN ('government_council', 'government_department') AND user_id IS NULL) ) )\", 'error': 'incomplete input'}, 'recoverable': True}\nERROR    core.database_manager:database_manager.py:243 應用遷移時發生錯誤：資料庫查詢失敗：incomplete input\nERROR    service.EconomyService:economy_service.py:57 經濟系統遷移應用失敗\nERROR    service.EconomyService:base_service.py:378 服務 EconomyService 初始化失敗\nERROR    service.GovernmentService:government_service.py:66 身分組服務依賴不可用\nERROR    service.GovernmentService:base_service.py:378 服務 GovernmentService 初始化失敗\n------------------------------ Captured log call -------------------------------\nERROR    core.exceptions:exceptions.py:326 Unexpected error in create_department: GovernmentService.create_department() got an unexpected keyword argument 'guild_id'\nTraceback (most recent call last):\n  File \"/Users/tszkinlai/Coding/roas-bot/core/exceptions.py\", line 312, in async_wrapper\n    return await func(*args, **kwargs)\nTypeError: GovernmentService.create_department() got an unexpected keyword argument 'guild_id'\n---------------------------- Captured log teardown -----------------------------\nINFO     core.database_manager:database_manager.py:399 資料庫管理器已清理\n_______ TestCrossSystemIntegration.test_data_consistency_across_systems ________\ntests/test_infrastructure.py:435: in wrapper\n    result = await func(*args, **kwargs)\nE   TypeError: TestCrossSystemIntegration.test_data_consistency_across_systems() missing 1 required positional argument: 'cross_system_test_setup'\n___________ TestCrossSystemIntegration.test_cross_system_performance ___________\ntests/test_infrastructure.py:389: in wrapper\n    result = await func(*args, **kwargs)\nE   TypeError: TestCrossSystemIntegration.test_cross_system_performance() missing 2 required positional arguments: 'cross_system_test_setup' and 'performance_monitor'\n______ TestCrossSystemIntegration.test_concurrent_cross_system_operations ______\ntests/integration/test_cross_system_integration.py:440: in test_concurrent_cross_system_operations\n    assert result[\"success_rate\"] >= 95.0  # 至少95%成功率\nE   assert 0.0 >= 95.0\n---------------------------- Captured stdout setup -----------------------------\n載入服務 activity 失敗：ActivityService.__init__() missing 1 required positional argument: 'database_manager'\n載入服務 welcome 失敗：WelcomeService.__init__() missing 1 required positional argument: 'database_manager'\n載入服務 message 失敗：MessageService.__init__() missing 1 required positional argument: 'database_manager'\n------------------------------ Captured log setup ------------------------------\nINFO     core.database_manager:database_manager.py:223 應用遷移 001: 建立基礎表格\nINFO     core.database_manager:database_manager.py:238 遷移 001 應用成功\nINFO     core.database_manager:database_manager.py:377 資料庫管理器初始化完成\nWARNING  service.AchievementService:achievement_service.py:77 經濟服務依賴不可用，貨幣獎勵功能將受限\nWARNING  service.AchievementService:achievement_service.py:82 身分組服務依賴不可用，身分組獎勵功能將受限\nINFO     core.database_manager:database_manager.py:223 應用遷移 004_achievement_system: 建立成就系統核心表格和索引\nERROR    core.database_manager:database_manager.py:484 執行 SQL 指令失敗：incomplete input\n指令內容：CREATE TABLE IF NOT EXISTS achievements ( id TEXT PRIMARY KEY,                    -- 成就唯一ID name TEXT NOT NULL,                     -- 成就名稱 description TEXT NOT NULL,              -- 成就描述 achievement_type TEXT NOT NULL,         -- 成就類型 (milestone, recurring, hidden, progressive) guild_id INTEGER NOT NULL,              -- 所屬伺服器ID trigger_conditions TEXT NOT NULL,       -- 觸發條件JSON rewards TEXT NOT NULL,                  -- 獎勵配置JSON status TEXT NOT NULL DEFAULT 'active',  -- 成就狀態 (active, disabled, archived) metadata TEXT,                          -- 額外配置資料JSON created_at TIMESTAMP NOT NULL,          -- 建立時間 updated_at TIMESTAMP NOT NULL,          -- 更新時間 CONSTRAINT achievements_type_check CHECK (achievement_type IN ('milestone', 'recurring', 'hidden', 'progressive')), CONSTRAINT achievements_status_check CHECK (status IN ('active', 'disabled', 'archived')) )\n參數：()\nERROR    core.exceptions:exceptions.py:315 BotError in execute: {'type': 'DatabaseQueryError', 'message': '資料庫查詢失敗：incomplete input', 'severity': 'medium', 'category': 'database', 'user_message': '資料庫暫時無法使用，請稍後再試。', 'details': {'operation': 'query', 'table': None, 'query': \"CREATE TABLE IF NOT EXISTS achievements ( id TEXT PRIMARY KEY,                    -- 成就唯一ID name TEXT NOT NULL,                     -- 成就名稱 description TEXT NOT NULL,              -- 成就描述 achievement_type TEXT NOT NULL,         -- 成就類型 (milestone, recurring, hidden, progressive) guild_id INTEGER NOT NULL,              -- 所屬伺服器ID trigger_conditions TEXT NOT NULL,       -- 觸發條件JSON rewards TEXT NOT NULL,                  -- 獎勵配置JSON status TEXT NOT NULL DEFAULT 'active',  -- 成就狀態 (active, disabled, archived) metadata TEXT,                          -- 額外配置資料JSON created_at TIMESTAMP NOT NULL,          -- 建立時間 updated_at TIMESTAMP NOT NULL,          -- 更新時間 CONSTRAINT achievements_type_check CHECK (achievement_type IN ('milestone', 'recurring', 'hidden', 'progressive')), CONSTRAINT achievements_status_check CHECK (status IN ('active', 'disabled', 'archived')) )\", 'error': 'incomplete input'}, 'recoverable': True}\nERROR    core.database_manager:database_manager.py:243 應用遷移時發生錯誤：資料庫查詢失敗：incomplete input\nERROR    service.AchievementService:achievement_service.py:90 成就系統遷移應用失敗\nERROR    service.AchievementService:base_service.py:378 服務 AchievementService 初始化失敗\nINFO     core.database_manager:database_manager.py:223 應用遷移 002_economy_system: 建立經濟系統核心表格和索引\nERROR    core.database_manager:database_manager.py:484 執行 SQL 指令失敗：incomplete input\n指令內容：CREATE TABLE IF NOT EXISTS economy_accounts ( id TEXT PRIMARY KEY,                    -- 帳戶ID，格式：user_{user_id}_{guild_id} 或 gov_{type}_{guild_id} account_type TEXT NOT NULL,             -- 帳戶類型：user, government_council, government_department guild_id INTEGER NOT NULL,              -- Discord伺服器ID user_id INTEGER,                        -- 使用者ID（僅用於user類型帳戶） balance REAL NOT NULL DEFAULT 0.0,      -- 帳戶餘額 created_at TEXT NOT NULL,               -- 建立時間 (ISO 8601格式) updated_at TEXT NOT NULL,               -- 最後更新時間 (ISO 8601格式) is_active INTEGER NOT NULL DEFAULT 1,   -- 帳戶是否啟用 (0=停用, 1=啟用) metadata TEXT,                          -- 額外資料 (JSON格式) CHECK (account_type IN ('user', 'government_council', 'government_department')), CHECK (balance >= 0.0), CHECK (is_active IN (0, 1)), CHECK ( (account_type = 'user' AND user_id IS NOT NULL) OR (account_type IN ('government_council', 'government_department') AND user_id IS NULL) ) )\n參數：()\nERROR    core.exceptions:exceptions.py:315 BotError in execute: {'type': 'DatabaseQueryError', 'message': '資料庫查詢失敗：incomplete input', 'severity': 'medium', 'category': 'database', 'user_message': '資料庫暫時無法使用，請稍後再試。', 'details': {'operation': 'query', 'table': None, 'query': \"CREATE TABLE IF NOT EXISTS economy_accounts ( id TEXT PRIMARY KEY,                    -- 帳戶ID，格式：user_{user_id}_{guild_id} 或 gov_{type}_{guild_id} account_type TEXT NOT NULL,             -- 帳戶類型：user, government_council, government_department guild_id INTEGER NOT NULL,              -- Discord伺服器ID user_id INTEGER,                        -- 使用者ID（僅用於user類型帳戶） balance REAL NOT NULL DEFAULT 0.0,      -- 帳戶餘額 created_at TEXT NOT NULL,               -- 建立時間 (ISO 8601格式) updated_at TEXT NOT NULL,               -- 最後更新時間 (ISO 8601格式) is_active INTEGER NOT NULL DEFAULT 1,   -- 帳戶是否啟用 (0=停用, 1=啟用) metadata TEXT,                          -- 額外資料 (JSON格式) CHECK (account_type IN ('user', 'government_council', 'government_department')), CHECK (balance >= 0.0), CHECK (is_active IN (0, 1)), CHECK ( (account_type = 'user' AND user_id IS NOT NULL) OR (account_type IN ('government_council', 'government_department') AND user_id IS NULL) ) )\", 'error': 'incomplete input'}, 'recoverable': True}\nERROR    core.database_manager:database_manager.py:243 應用遷移時發生錯誤：資料庫查詢失敗：incomplete input\nERROR    service.EconomyService:economy_service.py:57 經濟系統遷移應用失敗\nERROR    service.EconomyService:base_service.py:378 服務 EconomyService 初始化失敗\nERROR    service.GovernmentService:government_service.py:66 身分組服務依賴不可用\nERROR    service.GovernmentService:base_service.py:378 服務 GovernmentService 初始化失敗\n---------------------------- Captured log teardown -----------------------------\nINFO     core.database_manager:database_manager.py:399 資料庫管理器已清理\n____________ TestCrossSystemIntegration.test_transaction_atomicity _____________\ntests/integration/test_cross_system_integration.py:458: in test_transaction_atomicity\n    await economy_service.create_user_account(user_id, guild_id)\nE   AttributeError: 'EconomyService' object has no attribute 'create_user_account'. Did you mean: 'create_account'?\n---------------------------- Captured stdout setup -----------------------------\n載入服務 activity 失敗：ActivityService.__init__() missing 1 required positional argument: 'database_manager'\n載入服務 welcome 失敗：WelcomeService.__init__() missing 1 required positional argument: 'database_manager'\n載入服務 message 失敗：MessageService.__init__() missing 1 required positional argument: 'database_manager'\n------------------------------ Captured log setup ------------------------------\nINFO     core.database_manager:database_manager.py:223 應用遷移 001: 建立基礎表格\nINFO     core.database_manager:database_manager.py:238 遷移 001 應用成功\nINFO     core.database_manager:database_manager.py:377 資料庫管理器初始化完成\nWARNING  service.AchievementService:achievement_service.py:77 經濟服務依賴不可用，貨幣獎勵功能將受限\nWARNING  service.AchievementService:achievement_service.py:82 身分組服務依賴不可用，身分組獎勵功能將受限\nINFO     core.database_manager:database_manager.py:223 應用遷移 004_achievement_system: 建立成就系統核心表格和索引\nERROR    core.database_manager:database_manager.py:484 執行 SQL 指令失敗：incomplete input\n指令內容：CREATE TABLE IF NOT EXISTS achievements ( id TEXT PRIMARY KEY,                    -- 成就唯一ID name TEXT NOT NULL,                     -- 成就名稱 description TEXT NOT NULL,              -- 成就描述 achievement_type TEXT NOT NULL,         -- 成就類型 (milestone, recurring, hidden, progressive) guild_id INTEGER NOT NULL,              -- 所屬伺服器ID trigger_conditions TEXT NOT NULL,       -- 觸發條件JSON rewards TEXT NOT NULL,                  -- 獎勵配置JSON status TEXT NOT NULL DEFAULT 'active',  -- 成就狀態 (active, disabled, archived) metadata TEXT,                          -- 額外配置資料JSON created_at TIMESTAMP NOT NULL,          -- 建立時間 updated_at TIMESTAMP NOT NULL,          -- 更新時間 CONSTRAINT achievements_type_check CHECK (achievement_type IN ('milestone', 'recurring', 'hidden', 'progressive')), CONSTRAINT achievements_status_check CHECK (status IN ('active', 'disabled', 'archived')) )\n參數：()\nERROR    core.exceptions:exceptions.py:315 BotError in execute: {'type': 'DatabaseQueryError', 'message': '資料庫查詢失敗：incomplete input', 'severity': 'medium', 'category': 'database', 'user_message': '資料庫暫時無法使用，請稍後再試。', 'details': {'operation': 'query', 'table': None, 'query': \"CREATE TABLE IF NOT EXISTS achievements ( id TEXT PRIMARY KEY,                    -- 成就唯一ID name TEXT NOT NULL,                     -- 成就名稱 description TEXT NOT NULL,              -- 成就描述 achievement_type TEXT NOT NULL,         -- 成就類型 (milestone, recurring, hidden, progressive) guild_id INTEGER NOT NULL,              -- 所屬伺服器ID trigger_conditions TEXT NOT NULL,       -- 觸發條件JSON rewards TEXT NOT NULL,                  -- 獎勵配置JSON status TEXT NOT NULL DEFAULT 'active',  -- 成就狀態 (active, disabled, archived) metadata TEXT,                          -- 額外配置資料JSON created_at TIMESTAMP NOT NULL,          -- 建立時間 updated_at TIMESTAMP NOT NULL,          -- 更新時間 CONSTRAINT achievements_type_check CHECK (achievement_type IN ('milestone', 'recurring', 'hidden', 'progressive')), CONSTRAINT achievements_status_check CHECK (status IN ('active', 'disabled', 'archived')) )\", 'error': 'incomplete input'}, 'recoverable': True}\nERROR    core.database_manager:database_manager.py:243 應用遷移時發生錯誤：資料庫查詢失敗：incomplete input\nERROR    service.AchievementService:achievement_service.py:90 成就系統遷移應用失敗\nERROR    service.AchievementService:base_service.py:378 服務 AchievementService 初始化失敗\nINFO     core.database_manager:database_manager.py:223 應用遷移 002_economy_system: 建立經濟系統核心表格和索引\nERROR    core.database_manager:database_manager.py:484 執行 SQL 指令失敗：incomplete input\n指令內容：CREATE TABLE IF NOT EXISTS economy_accounts ( id TEXT PRIMARY KEY,                    -- 帳戶ID，格式：user_{user_id}_{guild_id} 或 gov_{type}_{guild_id} account_type TEXT NOT NULL,             -- 帳戶類型：user, government_council, government_department guild_id INTEGER NOT NULL,              -- Discord伺服器ID user_id INTEGER,                        -- 使用者ID（僅用於user類型帳戶） balance REAL NOT NULL DEFAULT 0.0,      -- 帳戶餘額 created_at TEXT NOT NULL,               -- 建立時間 (ISO 8601格式) updated_at TEXT NOT NULL,               -- 最後更新時間 (ISO 8601格式) is_active INTEGER NOT NULL DEFAULT 1,   -- 帳戶是否啟用 (0=停用, 1=啟用) metadata TEXT,                          -- 額外資料 (JSON格式) CHECK (account_type IN ('user', 'government_council', 'government_department')), CHECK (balance >= 0.0), CHECK (is_active IN (0, 1)), CHECK ( (account_type = 'user' AND user_id IS NOT NULL) OR (account_type IN ('government_council', 'government_department') AND user_id IS NULL) ) )\n參數：()\nERROR    core.exceptions:exceptions.py:315 BotError in execute: {'type': 'DatabaseQueryError', 'message': '資料庫查詢失敗：incomplete input', 'severity': 'medium', 'category': 'database', 'user_message': '資料庫暫時無法使用，請稍後再試。', 'details': {'operation': 'query', 'table': None, 'query': \"CREATE TABLE IF NOT EXISTS economy_accounts ( id TEXT PRIMARY KEY,                    -- 帳戶ID，格式：user_{user_id}_{guild_id} 或 gov_{type}_{guild_id} account_type TEXT NOT NULL,             -- 帳戶類型：user, government_council, government_department guild_id INTEGER NOT NULL,              -- Discord伺服器ID user_id INTEGER,                        -- 使用者ID（僅用於user類型帳戶） balance REAL NOT NULL DEFAULT 0.0,      -- 帳戶餘額 created_at TEXT NOT NULL,               -- 建立時間 (ISO 8601格式) updated_at TEXT NOT NULL,               -- 最後更新時間 (ISO 8601格式) is_active INTEGER NOT NULL DEFAULT 1,   -- 帳戶是否啟用 (0=停用, 1=啟用) metadata TEXT,                          -- 額外資料 (JSON格式) CHECK (account_type IN ('user', 'government_council', 'government_department')), CHECK (balance >= 0.0), CHECK (is_active IN (0, 1)), CHECK ( (account_type = 'user' AND user_id IS NOT NULL) OR (account_type IN ('government_council', 'government_department') AND user_id IS NULL) ) )\", 'error': 'incomplete input'}, 'recoverable': True}\nERROR    core.database_manager:database_manager.py:243 應用遷移時發生錯誤：資料庫查詢失敗：incomplete input\nERROR    service.EconomyService:economy_service.py:57 經濟系統遷移應用失敗\nERROR    service.EconomyService:base_service.py:378 服務 EconomyService 初始化失敗\nERROR    service.GovernmentService:government_service.py:66 身分組服務依賴不可用\nERROR    service.GovernmentService:base_service.py:378 服務 GovernmentService 初始化失敗\n---------------------------- Captured log teardown -----------------------------\nINFO     core.database_manager:database_manager.py:399 資料庫管理器已清理\n============================= slowest 10 durations =============================\n0.02s setup    tests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_achievement_economy_integration\n0.01s setup    tests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_government_economy_integration\n0.01s setup    tests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_transaction_atomicity\n0.01s setup    tests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_concurrent_cross_system_operations\n0.01s setup    tests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_role_management_integration\n0.00s teardown tests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_achievement_economy_integration\n0.00s teardown tests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_concurrent_cross_system_operations\n0.00s teardown tests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_transaction_atomicity\n0.00s teardown tests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_role_management_integration\n0.00s teardown tests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_government_economy_integration\n=========================== short test summary info ============================\nFAILED tests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_achievement_economy_integration - core.exceptions.ServiceError: 建立成就失敗：'dict' object has no attribute 'validate'\nFAILED tests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_government_economy_integration - core.exceptions.BotError: Unexpected error in create_department: GovernmentService.create_department() got an unexpected keyword argument 'guild_id'\nFAILED tests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_role_management_integration - core.exceptions.BotError: Unexpected error in create_department: GovernmentService.create_department() got an unexpected keyword argument 'guild_id'\nFAILED tests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_data_consistency_across_systems - TypeError: TestCrossSystemIntegration.test_data_consistency_across_systems() missing 1 required positional argument: 'cross_system_test_setup'\nFAILED tests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_cross_system_performance - TypeError: TestCrossSystemIntegration.test_cross_system_performance() missing 2 required positional arguments: 'cross_system_test_setup' and 'performance_monitor'\nFAILED tests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_concurrent_cross_system_operations - assert 0.0 >= 95.0\nFAILED tests/integration/test_cross_system_integration.py::TestCrossSystemIntegration::test_transaction_atomicity - AttributeError: 'EconomyService' object has no attribute 'create_user_account'. Did you mean: 'create_account'?\n============================== 7 failed in 0.12s ===============================\n",
    "stderr": "",
    "timestamp": "2025-08-21T03:45:09.860777"
  }
}