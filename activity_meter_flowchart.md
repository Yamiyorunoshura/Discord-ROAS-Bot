# 活躍度模塊運作流程圖

## 📊 活躍度系統架構概覽

```mermaid
graph TB
    A[用戶發送訊息] --> B{是否為機器人?}
    B -->|是| C[忽略處理]
    B -->|否| D{是否為私訊?}
    D -->|是| C
    D -->|否| E[獲取當前活躍度]
    E --> F{檢查冷卻時間}
    F -->|未達冷卻| G[僅增加訊息計數]
    F -->|已達冷卻| H[計算新活躍度]
    H --> I[更新活躍度資料]
    I --> J[更新訊息計數]
    G --> K[結束處理]
    J --> K
```

## 🔄 活躍度計算流程

```mermaid
graph LR
    A[當前活躍度分數] --> B[計算時間差]
    B --> C{是否超過衰減時間?}
    C -->|否| D[保持原分數]
    C -->|是| E[計算衰減量]
    E --> F[衰減後分數]
    F --> G[添加新訊息增益]
    G --> H[確保不超過最大值]
    H --> I[返回新活躍度]
    D --> G
```

## 📈 排行榜系統流程

```mermaid
graph TD
    A[排行榜查詢] --> B[獲取日期字串]
    B --> C[查詢每日訊息統計]
    C --> D[獲取月度統計]
    D --> E[計算月平均]
    E --> F[生成排行榜嵌入]
    F --> G[發送到頻道]
    
    H[自動播報任務] --> I{是否為播報時間?}
    I -->|否| J[等待下次檢查]
    I -->|是| K[獲取所有播報頻道]
    K --> L[處理每個伺服器]
    L --> M[生成排行榜]
    M --> N[發送播報]
    J --> H
```

## 🎨 進度條渲染流程

```mermaid
graph TD
    A[渲染請求] --> B[獲取用戶等級]
    B --> C[選擇主題風格]
    C --> D[創建畫布]
    D --> E[繪製背景]
    E --> F[計算填充寬度]
    F --> G[創建漸層效果]
    G --> H[繪製進度條]
    H --> I[添加文字]
    I --> J[應用特效]
    J --> K[生成圖片檔案]
    K --> L[返回Discord檔案]
```

## 🗄️ 資料庫操作流程

```mermaid
graph TD
    A[資料庫操作] --> B[獲取連接池]
    B --> C[建立連接]
    C --> D[執行SQL查詢]
    D --> E[處理結果]
    E --> F[提交事務]
    F --> G[關閉連接]
    G --> H[返回結果]
    
    I[初始化] --> J[創建表結構]
    J --> K[meter表]
    K --> L[daily表]
    L --> M[report_channel表]
    M --> N[初始化完成]
```

## ⚙️ 模組初始化流程

```mermaid
graph TD
    A[模組載入] --> B[初始化子模組]
    B --> C[ActivityDatabase]
    C --> D[ActivityCalculator]
    D --> E[ActivityRenderer]
    E --> F[ActivityTasks]
    F --> G[初始化資料庫]
    G --> H[啟動背景任務]
    H --> I[模組就緒]
    
    J[模組卸載] --> K[停止背景任務]
    K --> L[關閉資料庫連接]
    L --> M[清理資源]
    M --> N[模組卸載完成]
```

## 🎯 指令處理流程

```mermaid
graph TD
    A[指令接收] --> B{指令類型}
    B -->|活躍度查詢| C[獲取用戶活躍度]
    B -->|今日排行榜| D[查詢排行榜資料]
    B -->|設定播報頻道| E[權限檢查]
    B -->|活躍度面板| F[創建面板視圖]
    
    C --> G[計算衰減分數]
    G --> H[渲染進度條]
    H --> I[發送圖片]
    
    D --> J[生成排行榜嵌入]
    J --> K[發送排行榜]
    
    E --> L{權限通過?}
    L -->|是| M[更新播報頻道]
    L -->|否| N[權限拒絕]
    M --> O[確認設定]
    
    F --> P[啟動面板]
```

## 🔧 錯誤處理流程

```mermaid
graph TD
    A[操作執行] --> B{是否發生錯誤?}
    B -->|否| C[正常完成]
    B -->|是| D[記錄錯誤日誌]
    D --> E[錯誤分類]
    E --> F{錯誤類型}
    F -->|資料庫錯誤| G[重試機制]
    F -->|權限錯誤| H[返回權限訊息]
    F -->|渲染錯誤| I[使用預設渲染]
    F -->|其他錯誤| J[返回通用錯誤]
    
    G --> K{重試成功?}
    K -->|是| C
    K -->|否| L[返回錯誤訊息]
    H --> M[結束處理]
    I --> N[繼續處理]
    J --> O[結束處理]
```

## 📊 活躍度等級系統

```mermaid
graph LR
    A[0-25分] --> B[🌱 新手]
    B --> C[26-50分]
    C --> D[🔥 活躍]
    D --> E[51-75分]
    E --> F[⭐ 資深]
    F --> G[76-90分]
    G --> H[💎 專家]
    H --> I[91-100分]
    I --> J[👑 傳奇]
```

## 🎨 主題風格系統

```mermaid
graph TD
    A[主題選擇] --> B{主題類型}
    B -->|CLASSIC| C[經典風格]
    B -->|MODERN| D[現代風格]
    B -->|NEON| E[霓虹風格]
    B -->|MINIMAL| F[極簡風格]
    B -->|GRADIENT| G[漸層風格]
    
    C --> H[應用經典配置]
    D --> I[應用現代配置]
    E --> J[應用霓虹配置]
    F --> K[應用極簡配置]
    G --> L[應用漸層配置]
    
    H --> M[渲染完成]
    I --> M
    J --> M
    K --> M
    L --> M
```

## 📈 統計資料流程

```mermaid
graph TD
    A[統計查詢] --> B{查詢類型}
    B -->|每日統計| C[查詢daily表]
    B -->|月度統計| D[查詢月度資料]
    B -->|用戶統計| E[查詢meter表]
    
    C --> F[按訊息數排序]
    D --> G[計算月平均]
    E --> H[獲取活躍度分數]
    
    F --> I[生成排行榜]
    G --> J[計算統計]
    H --> K[計算衰減]
    
    I --> L[返回結果]
    J --> L
    K --> L
```

## 🔄 背景任務流程

```mermaid
graph TD
    A[背景任務啟動] --> B[每分鐘檢查]
    B --> C{是否為播報時間?}
    C -->|否| D[等待下次檢查]
    C -->|是| E[獲取播報頻道列表]
    
    D --> B
    E --> F[遍歷每個伺服器]
    F --> G[獲取排行榜資料]
    G --> H[生成播報嵌入]
    H --> I[發送到頻道]
    I --> J[處理下個伺服器]
    J --> F
    F --> K[播報完成]
    K --> B
```

## 🎯 核心功能總結

### 📊 **活躍度計算**
- **分數範圍**: 0-100分
- **增益機制**: 每則訊息+5分
- **衰減機制**: 1小時後開始，每小時-2分
- **冷卻時間**: 60秒內不重複計算

### 🏆 **等級系統**
- **新手** (0-25分): 🌱
- **活躍** (26-50分): 🔥  
- **資深** (51-75分): ⭐
- **專家** (76-90分): 💎
- **傳奇** (91-100分): 👑

### 📈 **排行榜功能**
- **每日排行榜**: 按訊息數排序
- **月平均計算**: 當月平均每日訊息數
- **自動播報**: 每日21:00自動播報
- **自定義頻道**: 可設定播報頻道

### 🎨 **視覺化系統**
- **進度條渲染**: 漸層效果設計
- **主題風格**: 5種不同主題
- **特效系統**: 發光、陰影效果
- **等級徽章**: 動態等級顯示

### 🗄️ **資料管理**
- **SQLite資料庫**: 輕量級本地存儲
- **連接池管理**: 高效連接管理
- **事務處理**: 確保資料一致性
- **錯誤處理**: 完整的錯誤恢復機制

### ⚙️ **系統架構**
- **模組化設計**: 清晰的職責分離
- **非同步處理**: 高效的事件處理
- **背景任務**: 自動化排行榜播報
- **權限控制**: 完整的權限檢查機制