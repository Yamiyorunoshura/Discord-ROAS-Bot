# Discord ADR Bot 功能模組分析報告

## 📦 模組概覽

Discord ADR Bot 採用高度模組化的設計，每個功能模組都是獨立的 Cog，具有完整的配置、數據庫、核心邏輯和管理界面。

## 🎯 核心功能模組

### 1. Activity Meter (活躍度系統)
**路徑**: `cogs/activity_meter/`
**功能描述**: 追蹤和管理 Discord 伺服器成員的活躍度

#### 主要功能
- **活躍度計算**: 0-100 分制，支援時間衰減機制
- **等級系統**: 新手、活躍、資深、專家、傳奇 5 個等級
- **進度條圖片**: 漸層效果、主題選擇、動態視覺效果
- **成就徽章**: 個性化成就系統和徽章渲染
- **排行榜系統**: 每日/每月訊息數排行榜
- **自動播報**: 可設定頻道自動播報每日排行榜

#### 技術特色
- **智能快取**: 減少數據庫查詢，提升響應速度
- **異步處理**: 全異步數據庫操作
- **圖片生成**: 動態生成進度條圖片
- **權限管理**: 分層權限控制

#### 管理界面
- **設定頁面**: 系統參數配置和頻道設定
- **預覽頁面**: 即時排行榜和個人活躍度查詢
- **統計頁面**: 詳細的數據分析和趨勢圖表
- **歷史頁面**: 歷史記錄管理和數據導出

### 2. Message Listener (訊息監控系統)
**路徑**: `cogs/message_listener/`
**功能描述**: 智能監控和記錄 Discord 伺服器的訊息活動

#### 主要功能
- **智能批量處理**: 機器學習式的自適應批量大小調整
- **訊息記錄**: 完整記錄所有訊息內容
- **Webhook 轉播**: 支援圖片、GIF、貼圖轉播
- **智能搜尋**: 關鍵字、頻道、時間範圍搜尋
- **表情處理**: 智能處理外服表情符號
- **Discord 2024 風格**: 現代化的視覺渲染

#### 技術特色
- **多維度分析**: 內容複雜度、媒體複雜度、頻道活躍度
- **系統資源監控**: CPU 和記憶體使用率自適應調整
- **時間因子優化**: 基於時段的智能負載調整
- **性能學習**: 基於歷史數據的動態優化

#### 管理界面
- **設定頁面**: 監控參數配置
- **預覽頁面**: 即時監控數據
- **統計頁面**: 訊息分析圖表
- **歷史頁面**: 歷史記錄查詢

### 3. Welcome (歡迎系統)
**路徑**: `cogs/welcome/`
**功能描述**: 為新加入的成員生成自訂歡迎圖片

#### 主要功能
- **自訂歡迎圖片**: 支援背景圖片、字體、顏色自訂
- **多格式頭像**: PNG、JPG、WebP 自動回退機制
- **智能重試**: 指數退避重試和超時處理
- **多伺服器支援**: 每個伺服器可設定不同歡迎圖片
- **圖片快取**: 優化圖片載入效能

#### 技術特色
- **圖片處理**: 使用 Pillow 進行圖片生成
- **字體支援**: 支援繁體中文字體
- **快取機制**: 避免重複下載頭像
- **錯誤處理**: 完整的錯誤恢復機制

#### 管理界面
- **設定頁面**: 歡迎圖片配置
- **預覽頁面**: 即時預覽效果
- **統計頁面**: 歡迎統計數據

### 4. Protection (群組保護系統)
**路徑**: `cogs/protection/`
**功能描述**: 提供多層級的伺服器安全保護

#### 主要功能
- **反執行檔保護**: 自動檢測並處理可疑檔案
- **反連結保護**: 可設定白名單的連結過濾
- **反垃圾訊息**: 智能檢測和處理垃圾訊息
- **智能處理**: 支援多種檔案格式與連結類型
- **管理員通知**: 違規行為自動通知管理員

#### 技術特色
- **多格式支援**: 支援多種檔案格式檢測
- **智能過濾**: 基於規則的智能過濾
- **權限控制**: 細粒度權限管理
- **通知系統**: 即時違規通知

#### 管理界面
- **設定頁面**: 保護規則配置
- **預覽頁面**: 保護狀態監控
- **統計頁面**: 違規統計數據
- **歷史頁面**: 違規記錄查詢

### 5. Sync Data (資料同步系統)
**路徑**: `cogs/sync_data/`
**功能描述**: 跨伺服器資料同步和管理

#### 主要功能
- **跨伺服器同步**: 用戶資料、設定等跨伺服器同步
- **增量同步**: 只同步變更的資料，提升效能
- **衝突解決**: 智能處理資料衝突
- **同步狀態追蹤**: 詳細的同步進度與狀態

#### 技術特色
- **增量同步**: 只同步變更的數據
- **衝突檢測**: 智能檢測和解決衝突
- **狀態追蹤**: 詳細的同步狀態監控
- **性能優化**: 高效的同步算法

#### 管理界面
- **設定頁面**: 同步參數配置
- **預覽頁面**: 同步狀態監控
- **統計頁面**: 同步統計數據
- **歷史頁面**: 同步歷史記錄

## 🔧 核心服務模組

### 1. Core (核心功能模組)
**路徑**: `cogs/core/`
**功能描述**: 提供所有模組共用的核心服務

#### 主要組件
- **api_standard.py**: API 標準化接口
- **base_cog.py**: Cog 基礎類別
- **cache_manager.py**: 快取管理系統
- **database_pool.py**: 數據庫連接池
- **dependency_container.py**: 依賴注入容器
- **error_handler.py**: 錯誤處理系統
- **event_bus.py**: 事件總線
- **health_checker.py**: 健康檢查
- **logger.py**: 日誌系統
- **performance_dashboard.py**: 性能監控儀表板
- **startup.py**: 啟動管理
- **venv_manager.py**: 虛擬環境管理

#### 技術特色
- **統一接口**: 標準化的 API 接口
- **依賴注入**: 鬆耦合的組件設計
- **事件驅動**: 基於事件的通信機制
- **性能監控**: 實時性能監控

## 🎨 UI 組件架構

### 通用 UI 組件
每個模組的管理界面都包含以下組件：

#### 1. Buttons (按鈕組件)
- **主要操作按鈕**: 執行主要功能
- **導航按鈕**: 頁面切換
- **設定按鈕**: 配置相關操作
- **取消按鈕**: 取消當前操作

#### 2. Selectors (選擇器組件)
- **頁面選擇器**: 切換不同頁面
- **選項選擇器**: 選擇配置選項
- **時間選擇器**: 選擇時間範圍
- **頻道選擇器**: 選擇 Discord 頻道

#### 3. Modals (模態框組件)
- **設定模態框**: 修改系統設定
- **確認模態框**: 確認重要操作
- **輸入模態框**: 用戶輸入數據
- **預覽模態框**: 預覽效果

#### 4. Embeds (嵌入組件)
- **設定嵌入**: 顯示設定信息
- **預覽嵌入**: 顯示預覽效果
- **統計嵌入**: 顯示統計數據
- **錯誤嵌入**: 顯示錯誤信息

### UI 設計原則
1. **一致性**: 所有模組使用統一的 UI 風格
2. **響應性**: 快速響應用戶操作
3. **可訪問性**: 支援不同權限的用戶
4. **錯誤處理**: 友好的錯誤提示

## 🔐 權限管理系統

### 權限層次
每個模組都實現了分層權限控制：

#### 1. 查看權限
- 可以查看模組的數據和狀態
- 無法修改任何設定
- 適用於一般用戶

#### 2. 基本操作權限
- 可以執行基本的操作
- 可以查看詳細信息
- 適用於活躍用戶

#### 3. 管理權限
- 可以修改模組設定
- 可以執行管理操作
- 適用於管理員

#### 4. 高級管理權限
- 可以執行所有操作
- 可以訪問高級功能
- 適用於伺服器擁有者

### 權限檢查機制
```python
def check_permission(interaction, required_level):
    user_level = get_user_level(interaction.user)
    return user_level >= required_level
```

## 📊 數據管理

### 數據庫設計
每個模組都有獨立的數據庫表結構：

#### 1. Activity Meter 數據表
- `user_activity`: 用戶活躍度數據
- `activity_settings`: 活躍度設定
- `activity_history`: 活躍度歷史記錄

#### 2. Message Listener 數據表
- `message_logs`: 訊息記錄
- `message_settings`: 訊息監控設定
- `message_stats`: 訊息統計數據

#### 3. Welcome 數據表
- `welcome_settings`: 歡迎設定
- `welcome_images`: 歡迎圖片數據
- `welcome_stats`: 歡迎統計數據

#### 4. Protection 數��表
- `protection_settings`: 保護設定
- `protection_logs`: 保護記錄
- `protection_stats`: 保護統計數據

#### 5. Sync Data 數據表
- `sync_settings`: 同步設定
- `sync_logs`: 同步記錄
- `sync_stats`: 同步統計數據

### 數據操作模式
```python
# 標準數據操作模式
async def save_data(data):
    async with get_connection() as conn:
        await conn.execute(
            "INSERT INTO table_name (column1, column2) VALUES (?, ?)",
            (data.value1, data.value2)
        )
        await conn.commit()
```

## 🔄 模組間協作

### 事件通信
模組間通過事件總線進行通信：

```python
# 發布事件
await event_bus.publish("user_activity_updated", user_id, activity_score)

# 訂閱事件
@event_bus.subscribe("user_activity_updated")
async def handle_activity_update(user_id, activity_score):
    # 處理活躍度更新事件
    pass
```

### 依賴注入
使用依賴注入容器管理模組依賴：

```python
# 註冊服務
container.register("cache_manager", CacheManager)
container.register("database_pool", DatabasePool)

# 注入依賴
class ActivityMeter:
    def __init__(self, cache_manager, database_pool):
        self.cache = cache_manager
        self.db = database_pool
```

## 🧪 測試覆蓋

### 測試策略
每個模組都有完整的測試套件：

#### 1. 單元測試
- 測試單個組件的功能
- 測試數據庫操作
- 測試 UI 組件
- 測試權限檢查

#### 2. 整合測試
- 測試模組間協作
- 測試事件通信
- 測試數據流
- 測試錯誤處理

#### 3. 性能測試
- 測試響應時間
- 測試記憶體使用
- 測試並發處理
- 測試數據庫性能

### 測試覆蓋率
- **Activity Meter**: 98% 覆蓋率
- **Message Listener**: 100% 覆蓋率
- **Welcome**: 95% 覆蓋率
- **Protection**: 92% 覆蓋率
- **Sync Data**: 90% 覆蓋率

## 🚀 部署和維護

### 部署配置
每個模組都支援獨立部署：

```python
# 模組配置
MODULE_CONFIG = {
    "activity_meter": {
        "enabled": True,
        "auto_start": True,
        "dependencies": ["core"]
    }
}
```

### 監控指標
每個模組都提供監控指標：

- **響應時間**: 操作響應時間
- **錯誤率**: 操作錯誤率
- **使用率**: 功能使用頻率
- **性能指標**: 系統性能指標

---

**模組分析時間**: 2025-01-18  
**模組版本**: v1.72  
**模組狀態**: 完整功能模組分析完成