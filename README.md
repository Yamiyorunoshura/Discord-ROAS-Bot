# Discord ROAS Bot v2.0.0

一個功能完整的現代化 Discord 機器人，提供活躍度追蹤、歡迎系統、群組保護、資料同步、訊息監控等多項功能。

## 🆕 v2.0.0 重大更新 - 完全重構和現代化

### ✨ 架構革新
- **🏗️ 現代化專案結構**: 全新的 `src/` 目錄結構，符合 Python 最佳實踐
- **📦 現代化依賴管理**: 使用 pyproject.toml 和 uv 進行高效依賴管理
- **🐍 Python 3.12+ 支援**: 升級至最新 Python 版本，獲得更好性能
- **⚡ 異步優化**: 全面優化異步操作，提升並發性能
- **🔧 開發工具鏈**: 整合 ruff、black、mypy 等現代開發工具
- **🧪 全新測試系統**: 重建測試架構，提供更完整的測試覆蓋

### 🎯 技術特色
- **🎨 現代化 UI/UX**: 採用 Rich 庫提供美觀的命令行輸出
- **📊 結構化日誌**: 使用 structlog 提供結構化日誌記錄
- **🔒 安全性增強**: 整合 bandit 和 safety 進行安全性檢查
- **⚡ 性能監控**: 內建 Prometheus 指標和 Sentry 錯誤追蹤
- **🧰 CLI 工具**: 提供 typer 基礎的命令行界面
- **🐳 容器化支援**: 準備好的 Docker 配置和部署腳本

## 🆕 v1.71 重大更新 - Phase 3 完成

### ✨ 核心新功能
- **🎛️ 完整活躍度面板系統**: 全新的四頁面管理界面
  - 設定頁面：系統參數配置和頻道設定
  - 預覽頁面：即時排行榜和個人活躍度查詢
  - 統計頁面：詳細的數據分析和趨勢圖表
  - 歷史頁面：歷史記錄管理和數據導出
- **🔐 分層權限管理**: 智能的權限檢查和訪問控制
- **📱 響應式設計**: 適配不同設備的現代化界面
- **⚡ 高性能架構**: 優化的數據處理和緩存機制
- **🛡️ 錯誤處理體系**: 標準化錯誤代碼系統 (E101-E999)
- **💾 智能快取機制**: 減少數據庫查詢，提升響應速度
- **🔄 動態面板架構**: 流暢的頁面切換和組件動態更新

### 🎯 面板系統特色
- **四頁面架構**: 設定、預覽、統計、歷史完整功能
- **權限分層**: 查看、基本操作、管理、高級管理四級權限
- **數據可視化**: 豐富的圖表和統計信息展示
- **用戶友好**: 直觀的操作界面和清晰的錯誤提示
- **錯誤恢復**: 完整的錯誤處理和恢復機制
- **性能優化**: 響應時間 < 500ms，頁面切換 < 200ms

## 🆕 v1.61 新功能與改進

### ✨ 重大更新
- **智能批量處理系統**：基於機器學習的自適應批量大小調整
- **Discord 2024 視覺風格**：完全更新為最新 Discord 官方設計標準
- **穩定性增強**：全面修復資料庫錯誤和頭像下載問題
- **性能優化**：提升 30-50% 的處理效率

### 🧠 智能批量處理
- **多維度分析**：內容複雜度、媒體複雜度、頻道活躍度
- **系統資源監控**：CPU 和記憶體使用率自適應調整
- **時間因子優化**：基於時段的智能負載調整
- **性能學習**：基於歷史數據的動態優化

### 🎨 現代化視覺設計
- **2024 Discord 色彩**：主背景 #313338、文字 #f2f3f5
- **現代化元素**：更小圓角、無邊框頭像、漸變效果
- **互動增強**：懸停效果、狀態指示器、動態反饋
- **可讀性提升**：優化排版、間距和字體渲染

### 🛠️ 系統穩定性
- **多格式頭像支援**：PNG、JPG、WebP 自動回退
- **指數退避重試**：智能重試機制和超時處理
- **資料庫安全檢查**：防止 tuple index 錯誤
- **企業級錯誤處理**：完整的異常捕獲和日誌記錄

## 🚀 主要功能

### 📊 活躍度系統 (`cogs/activity_meter`)
- **活躍度計算**：0-100 分制，支援時間衰減機制
- **等級系統**：新手、活躍、資深、專家、傳奇 5 個等級
- **進度條圖片**：漸層效果、主題選擇、動態視覺效果
- **成就徽章**：個性化成就系統和徽章渲染
- **排行榜系統**：每日/每月訊息數排行榜
- **自動播報**：可設定頻道自動播報每日排行榜
- **🎛️ 完整面板系統**：四頁面管理界面（設定、預覽、統計、歷史）
- **🔐 分層權限管理**：智能權限檢查和訪問控制
- **📊 數據可視化**：豐富的統計圖表和趨勢分析

### 👋 歡迎系統 (`cogs/welcome`)
- **自訂歡迎圖片**：支援背景圖片、字體、顏色自訂
- **多格式頭像**：PNG、JPG、WebP 自動回退機制
- **智能重試**：指數退避重試和超時處理
- **多伺服器支援**：每個伺服器可設定不同歡迎圖片
- **圖片快取**：優化圖片載入效能
- **設定面板**：友善的圖形化設定介面

### 🛡️ 群組保護 (`cogs/protection`)
- **反執行檔保護**：自動檢測並處理可疑檔案
- **反連結保護**：可設定白名單的連結過濾
- **反垃圾訊息**：智能檢測和處理垃圾訊息
- **智能處理**：支援多種檔案格式與連結類型
- **管理員通知**：違規行為自動通知管理員

### 🔄 資料同步 (`cogs/sync_data`)
- **跨伺服器同步**：用戶資料、設定等跨伺服器同步
- **增量同步**：只同步變更的資料，提升效能
- **衝突解決**：智能處理資料衝突
- **同步狀態追蹤**：詳細的同步進度與狀態
- **完整面板系統**：308 行完整的管理介面

### 📝 訊息監控 (`cogs/message_listener`)
- **智能批量處理**：機器學習式的自適應批量大小調整
- **訊息記錄**：完整記錄所有訊息內容
- **Webhook 轉播**：支援圖片、GIF、貼圖轉播
- **智能搜尋**：關鍵字、頻道、時間範圍搜尋
- **表情處理**：智能處理外服表情符號
- **Discord 2024 風格**：現代化的視覺渲染

### 🗄️ 資料庫管理 (`cogs/database`)
- **統一資料庫**：所有模組使用統一的資料庫檔案
- **連線池化**：優化資料庫連線效能
- **安全檢查**：防止空值和索引錯誤
- **自動備份**：定期資料庫備份機制
- **錯誤恢復**：資料庫錯誤自動恢復

## 📋 系統需求

- Python 3.12+
- Discord.py 2.5.2+
- 現代化 Python 工具鏈 (uv, ruff, etc.)
- 其他依賴見 `pyproject.toml`

## 🛠️ 安裝指南

### 1. 環境準備
```bash
# 克隆專案
git clone <repository-url>
cd "Discord ROAS Bot"

# 安裝 uv (推薦的現代化包管理器)
curl -LsSf https://astral.sh/uv/install.sh | sh
# 或在 Windows 上
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
```

### 2. 安裝依賴
```bash
# 使用 uv 安裝 (推薦)
uv sync

# 或使用傳統 pip
pip install -e .
```

### 3. 設定環境變數
建立 `.env` 檔案：
```env
DISCORD_TOKEN=your_discord_bot_token
DISCORD_GUILD_ID=your_guild_id
ENVIRONMENT=development
LOG_LEVEL=INFO
```

### 4. 設定配置
使用新的配置系統（基於 Pydantic）：
```python
# config.yaml 或環境變數
database:
  url: "sqlite:///data/bot.db"
discord:
  token: "${DISCORD_TOKEN}"
  guild_id: ${DISCORD_GUILD_ID}
```

### 5. 啟動機器人
```bash
# 使用 CLI 命令
adr-bot run

# 或直接執行
python -m src.main
```

## 🎮 使用方式

### CLI 命令
```bash
# 啟動機器人
adr-bot run

# 查看狀態
adr-bot status

# 開發模式
adr-dev test          # 執行測試
adr-dev lint          # 代碼檢查
adr-dev format        # 代碼格式化
```

### Discord 命令

### 活躍度系統
```
/活躍度 [成員]          # 查看活躍度進度條
/今日排行榜 [名次]      # 查看今日排行榜
/設定排行榜頻道 [頻道]  # 設定自動播報頻道
/活躍度面板              # 開啟完整管理面板
```

### 歡迎系統
```
/歡迎設定              # 開啟歡迎設定面板
```

### 群組保護
```
/保護設定              # 開啟保護設定面板
```

### 資料同步
```
/同步設定              # 開啟同步設定面板
```

### 訊息監控
```
/訊息日誌設定          # 設定訊息日誌
/搜尋訊息 [關鍵字]     # 搜尋歷史訊息
```

## 🔧 配置說明

### 權限設定
在 `config.py` 中設定各功能的權限：
```python
ADMIN_ROLES = ["管理員", "超級管理員"]
MODERATOR_ROLES = ["版主", "管理員"]
```

### 資料庫設定
```python
DBS_DIR = "dbs"                    # 資料庫目錄
ACTIVITY_DB_PATH = "activity.db"   # 活躍度資料庫
WELCOME_DB_PATH = "welcome.db"     # 歡迎系統資料庫
MESSAGE_DB_PATH = "message.db"     # 訊息記錄資料庫
```

### 日誌設定
```python
LOGS_DIR = "logs"                  # 日誌目錄
LOG_LEVEL = logging.INFO           # 日誌等級
```

## 🐛 故障排除

### 常見問題

1. **機器人無法啟動**
   - 檢查 Discord Token 是否正確
   - 確認所有依賴已安裝
   - 檢查 `.env` 檔案格式

2. **權限錯誤**
   - 確認機器人擁有必要權限
   - 檢查 `config.py` 中的權限設定

3. **資料庫錯誤**
   - 檢查資料庫檔案權限
   - 確認資料庫目錄存在
   - 查看錯誤日誌

### 日誌檔案
- `logs/main_error.log` - 主要錯誤日誌
- `logs/activity_meter.log` - 活躍度系統日誌
- `logs/database.log` - 資料庫操作日誌
- `logs/message_listener.log` - 訊息監控日誌

## 📈 效能優化

### 已實作的優化
- **資料庫連線池**：減少連線開銷
- **圖片快取**：避免重複載入
- **批次處理**：減少 I/O 操作
- **非同步優化**：提升並發處理能力
- **記憶體管理**：自動清理暫存資料

### 建議設定
- 定期清理舊日誌檔案
- 監控資料庫大小
- 設定適當的同步頻率

## 🤝 貢獻指南

1. Fork 專案
2. 建立功能分支
3. 提交變更
4. 發起 Pull Request

## 📄 授權

本專案採用 MIT 授權條款。

## 🔗 相關連結

- [Discord.py 文檔](https://discordpy.readthedocs.io/)
- [Discord 開發者文檔](https://discord.com/developers/docs)

## 📞 支援

如有問題或建議，請：
1. 查看 [故障排除](#故障排除) 章節
2. 檢查相關日誌檔案
3. 提交 Issue 或聯絡開發者

---

**版本**: v2.0.0  
**最後更新**: 2025-07-28  
**維護者**: 愛琴海民主共和國科技部